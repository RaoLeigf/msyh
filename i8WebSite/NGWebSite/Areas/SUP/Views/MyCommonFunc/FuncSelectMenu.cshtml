@{
    Layout = "~/Views/Shared/_Layout.cshtml";

    ViewBag.Title = "功能选择";
}

@section script
{
    @*<script src="~/NG3Resource/js/DMC/DMCCommon.js" type="text/javascript" charset="utf-8"></script>*@
    <script src=@Url.Script("~/NG3Resource/js/DMC/DMCCommon.js") type="text/javascript" charset="utf-8"></script>
    <link href=@Url.Script("~/NG3Resource/css/mainTreeTab.css") rel="stylesheet" type="text/css" />
    <style>
        #save-btnIconEl {
            margin-left: 10px;
        }

        #save-btnInnerEl {
            margin-left: 20px;
        }

        #cancel-btnIconEl {
            margin-left: 10px;
        }

        #cancel-btnInnerEl {
            margin-left: 20px;
        }
    </style>
    <script type="text/javascript">

        var contextMenuOpType = ""; //右键菜单操作类型
        var seq = 0;//常用功能显示顺序
        var check = true;

        var LoadEnFuncTreeRight = Ext.htmlDecode('@ViewBag.LoadEnFuncTreeRight');
        var data = Ext.htmlDecode('@ViewBag.originalData');
        var UserType = Ext.htmlDecode('@ViewBag.UserType');
        //var originalData = JSON.stringify(eval('(' + data + ')').Record);
        var originalData;
        //alert(originalData);
        if (LoadEnFuncTreeRight.substr(0, 1) == 1 && UserType != 'SYSTEM') {//第一个字符为1，启用企业功能树
            var MySuiteUrl = C_ROOT + 'SUP/EnFuncTree/GetSuiteList';
            var MyMenuUrl = C_ROOT + 'SUP/EnFuncTree/LoadMenu'; //像系统功能树一样做一个不懒加载的开关，否则添加到我的功能树会加不进去
            var MyQueryUrl = C_ROOT + 'SUP/EnFuncTree/Query';
        } else {
            var MySuiteUrl = C_ROOT + 'SUP/MainTree/GetSuiteList';
            var MyMenuUrl = C_ROOT + 'SUP/MainTree/LoadMenu' + "?lazyLoadFlag=false";
            var MyQueryUrl = C_ROOT + 'SUP/MainTree/Query';
        }
        var customEditToolbar;
        var gridPanel;

        var isWeb = false;
        if (window.external.IsInWebBrowser == undefined) {
            isWeb = true;
        }

        Ext.onReady(function () {

            var langInfo = Ext.htmlDecode('@ViewBag.NG3Lang');
            var Lang = Ext.isEmpty(langInfo) ? {} : Ext.decode(langInfo); //自定义

            //通过节点node找到树的根节点
            function findRoot(node) {
                while (!node.isRoot()) {
                    node = node.parentNode;
                }
                return node;
            }

            //展开根为root的树的所有节点
            function expandTree(root) {
                if (root.hasChildNodes()) {
                    root.expand();
                    for (var i = 0; i < root.childNodes.length; i++) {
                        expandTree(root.childNodes[i]);
                    }
                }

            }

            //折叠根为root的树的所有节点
            function collapseTree(root) {
                if (root.hasChildNodes()) {
                    //root.collapse();
                    for (var i = 0; i < root.childNodes.length; i++) {
                        if (root.childNodes[i].hasChildNodes()) {
                            root.childNodes[i].collapse();
                            collapseTree(root.childNodes[i]);
                        }
                    }
                }
            }

            var currentTree;
            //系统功能树
            Ext.define('Ext.ng.checkSysFuncTree', {
                extend: 'Ext.tab.Panel',
                alias: 'widget.ngCheckSysFuncTree',
                tabPosition: 'left',
                suites: [],
                initComponent: function () {
                    var me = this;
                    this.callParent();
                    me.menu = Ext.create('Ext.menu.Menu', {
                        //selectedNode:null,
                        items: [
                             {
                                 text: '全选',
                                 handler: function () {
                                     var node = me.menu.selectedNode;
                                     var root = findRoot(node);
                                     treeNodeCheckBoxSelected(root, true);
                                 }
                             },
                            {
                                text: '反选',
                                handler: function () {
                                    var node = me.menu.selectedNode;
                                    var root = findRoot(node);
                                    treeNodeCheckBoxSelected(root, false);
                                }
                            }, '-',
                            {
                                text: '全部展开',
                                handler: function () {
                                    var node = me.menu.selectedNode;
                                    var root = findRoot(node);
                                    expandTree(root);
                                }
                            },
                            {
                                text: '全部折叠',
                                handler: function () {
                                    var node = me.menu.selectedNode;
                                    var root = findRoot(node);
                                    collapseTree(root);
                                }
                            }
                        ]
                    });
                    me.loadData();
                    me.tabBar.on('change', function (tabBar, tab, card, eOpts) {
                        tabBar.needsScroll = false;//禁止tabBar乱滚动，抽风
                    });
                },
                loadData: function () {
                    var me = this;
                    var arr = [];
                    Ext.Ajax.request({
                        url: MySuiteUrl,
                        async: false,
                        success: function (res, opts) {
                            if (res.responseText.length > 0) {
                                var suites = Ext.JSON.decode(res.responseText);
                                for (var i = 0; i < suites.length; i++) {
                                    var title = TranTitle(suites[i].Name);

                                    var menu = Ext.create('Ext.ng.TreePanel', {
                                        autoLoad: false,
                                        height: 600,
                                        split: true,
                                        checked: false,
                                        border: false,
                                        //title: suites[i].Name,//title,
                                        title: title,
                                        suite: suites[i].Code,
                                        layout: 'fit',
                                        treeFields: [{ name: 'text', type: 'string' },
                                            //{ name: 'my', type: 'string' }//我的自定义属性
                                        ],
                                        url: MyMenuUrl, //'HR/EmpInfoList/LoadMenu'
                                        //params: { functiontree: 'myFuncTree'},
                                        listeners: {
                                            'afterrender': function () {
                                                //this.expandAll();
                                            },
                                            'expand': function () {
                                                var me = this;
                                                Ext.apply(this.getStore().proxy.extraParams, { suite: me.suite });
                                                this.getRootNode().expand();
                                            },
                                            'activate': function () {
                                                var me = this;
                                                Ext.apply(this.getStore().proxy.extraParams, { suite: me.suite });
                                                //this.getRootNode().expand();//有些电脑会全部出发这个事件，达不到懒加载目的
                                            },
                                            //'itemdblclick': function (view, rcd, item, idx, event, eOpts) {
                                            //    if (rcd.raw.leaf) {
                                            //        WF.Center.openTab(rcd.raw.text, rcd.raw.url);
                                            //    }
                                            //},
                                            'checkchange': function (node, checked) {
                                                setChildNodeChecked(node, checked);
                                            },
                                            'itemcontextmenu': function (view, rec, node, index, e) {
                                                e.stopEvent();
                                                var ngCheckSysFuncTree = this.findParentByType('ngCheckSysFuncTree');
                                                ngCheckSysFuncTree.menu.selectedNode = rec;
                                                ngCheckSysFuncTree.menu.showAt(e.getXY());
                                                return false;
                                            },
                                            'containercontextmenu': function (treeP, e, eOpts) {
                                                e.stopEvent();
                                                var ngCheckSysFuncTree = this.findParentByType('ngCheckSysFuncTree');
                                                ngCheckSysFuncTree.menu.selectedNode = treeP.store.data.items[0];
                                                ngCheckSysFuncTree.menu.showAt(e.getXY());
                                                return false;
                                            }
                                        }
                                    });
                                    arr.push(menu);
                                }


                                //在for循环外，添加报表仓库和文档库
                                var myTitle = '报表仓库';
                                var title = TranTitle(myTitle);
                                var menu = Ext.create('Ext.ng.TreePanel', {
                                    autoLoad: false,
                                    height: 600,
                                    split: true,
                                    suiteName: '报表仓库',
                                    border: false,
                                    //title: suites[i].Name,//title,
                                    title: title,
                                    //suite: suites[i].Code,
                                    layout: 'fit',
                                    treeFields: [{ name: 'text', type: 'string' },
                                            //{ name: 'checked', type: 'boolean', values: false },
                                            //{ name: 'my', type: 'string' }//我的自定义属性
                                    ],
                                    url: C_ROOT + 'SUP/ReportList/LoadReportList', //'HR/EmpInfoList/LoadMenu'
                                    listeners: {
                                        'afterrender': function () {
                                            //this.expandAll();
                                        },
                                        'expand': function () {
                                            var me = this;
                                            Ext.apply(this.getStore().proxy.extraParams, { suite: me.suite });
                                            this.getRootNode().expand();
                                        },
                                        'activate': function () {
                                            var me = this;
                                            Ext.apply(this.getStore().proxy.extraParams, { suite: me.suite });
                                            //this.getRootNode().expand();//有些电脑会全部出发这个事件，达不到懒加载目的
                                        },
                                        'checkchange': function (node, checked) {
                                            setChildNodeChecked(node, checked);
                                        },
                                        'itemdblclick': function (view, rcd, item, idx, event, eOpts) {
                                            if (rcd.raw.leaf) {
                                                //WF.Center.openTab(rcd.raw.text, rcd.raw.url);
                                                if (me.hasDbClickListener == true) {
                                                    var param = { 'str': rcd.raw.text, 'rightname': '', 'managername': rcd.raw.managername, 'moduleno': rcd.raw.moduleno, 'id': rcd.raw.code, 'url': rcd.raw.url, 'suite': rcd.raw.suite, 'rightkey': rcd.raw.rightkey };
                                                    window.external.OpenFunction(rcd.raw.url, JSON.stringify(param));
                                                }
                                            }
                                        }
                                    }
                                });

                                //在for循环外，添加报表仓库和文档库
                                var wocTitle = '文档库';
                                var title = TranTitle(wocTitle);
                                Ext.define('Ext.ng.WMDocTree', {
                                    extend: 'Ext.tree.TreePanel',
                                    alias: 'widget.ngDocTree',
                                    animate: true,
                                    collapsible: false,
                                    useArrows: true,
                                    rootVisible: false,
                                    hideHeaders: true,
                                    selectMode: 'Single',
                                    nodeIndex: -1,
                                    type: 'MY',
                                    filter: '',

                                    autoLoad: false,
                                    height: 600,
                                    split: true,
                                    suiteName: '文档库',
                                    border: false,
                                    //title: suites[i].Name,//title,
                                    title: title,
                                    //suite: suites[i].Code,
                                    layout: 'fit',
                                    treeFields: [
                                            { name: 'checked', type: 'boolean', values: false }
                                    ],
                                    columns: [
                                        {
                                            text: '物理主键',
                                            flex: 0,
                                            sortable: false,
                                            dataIndex: 'PhId',
                                            hideable: false,
                                            hidden: true
                                        }, {
                                            text: '代码',
                                            flex: 0,
                                            dataIndex: 'CNo',
                                            sortable: false,
                                            hideable: false,
                                            hidden: true
                                        }, {
                                            text: '名称',
                                            flex: 1,
                                            xtype: 'treecolumn',
                                            dataIndex: 'Text',
                                            hidden: false,
                                            hideable: false,
                                            align: 'left'
                                        }, {
                                            text: '名称',
                                            flex: 0,
                                            dataIndex: 'CName',
                                            hidden: true,
                                            hideable: false,
                                            sortable: false,
                                            align: 'left'
                                        }
                                    ],
                                    initComponent: function () {
                                        var me = this;
                                        Ext.define('model', {
                                            extend: 'Ext.data.Model',
                                            fields: [
                                                {
                                                    name: 'PhId',
                                                    type: 'string',
                                                    mapping: 'PhId'
                                                }, {
                                                    name: 'CNo',
                                                    type: 'string',
                                                    mapping: 'CNo'
                                                }, {
                                                    name: 'CName',
                                                    type: 'string',
                                                    mapping: 'CName'
                                                }, {
                                                    name: 'Text',
                                                    type: 'string',
                                                    mapping: 'text'
                                                }, {
                                                    name: 'IsDoc',
                                                    type: 'string',
                                                    mapping: 'IsDoc'
                                                }, {
                                                    name: 'DocType',
                                                    type: 'string',
                                                    mapping: 'DocType'
                                                }, {
                                                    name: 'Doclibid',
                                                    type: 'string',
                                                    mapping: 'Doclibid'
                                                }, {
                                                    name: 'WbsId',
                                                    type: 'string',
                                                    mapping: 'WbsId'
                                                }
                                            ]
                                        });
                                        var store = Ext.create('Ext.data.TreeStore', {
                                            model: 'model',
                                            autoLoad: false,
                                            proxy: {
                                                type: 'ajax',
                                                url: C_ROOT + 'WM/Doc/Document/GetDocumentForGuid'
                                            }
                                        });
                                        store.on('beforeload', function (store) {
                                            if (me.type) {
                                                Ext.apply(store.proxy.extraParams, { 'type': me.type });
                                            }
                                            if (me.filter || me.filter == '') {
                                                Ext.apply(store.proxy.extraParams, { 'filter': me.filter });
                                            }
                                        });
                                        me.store = store;
                                        me.callParent();
                                    },
                                });
                                var menuWoc = Ext.create('Ext.ng.WMDocTree', {

                                });




                                if (me.hasRightClickMenu == true) {
                                    menu.addListener('itemcontextmenu', function (view, rec, node, index, e) {
                                        e.stopEvent();
                                        var ngSysFuncTree = view.findParentByType('ngSysFuncTree');
                                        if (rec.data.leaf == true) {
                                            ngSysFuncTree.itemMenu.selectedNode = rec;
                                            ngSysFuncTree.itemMenu.showAt(e.getXY());
                                        } else {
                                            ngSysFuncTree.containMenu.selectedNode = rec;
                                            ngSysFuncTree.containMenu.showAt(e.getXY());
                                        }
                                        return false;
                                    });
                                    menu.addListener('containercontextmenu', function (treeP, e, eOpts) {
                                        e.stopEvent();
                                        var ngSysFuncTree = this.findParentByType('ngSysFuncTree');
                                        ngSysFuncTree.containMenu.selectedNode = treeP.store.data.items[0];
                                        ngSysFuncTree.containMenu.showAt(e.getXY());
                                        return false;
                                    })
                                }
                                if (UserType != 'SYSTEM') {
                                    arr.push(menu);
                                    arr.push(menuWoc);
                                }



                                me.suites = arr; //第一次加载把arr存在suites中
                                //me.items = arr;
                                me.add(arr);
                                Ext.apply(arr[0].getStore().proxy.extraParams, { suite: arr[0].suite });
                                arr[0].getRootNode().expand();//加载第一个
                                currentTree = arr[0];
                            }
                        }
                    });// 画出左侧菜单树
                },
                height: 300,
                width: 300,
                itemId: 'ngCheckSysFuncTree',
                dockedItems: [{
                    xtype: 'toolbar',
                    width: 300,
                    dock: 'top',
                    //layout: 'border',
                    //minWidth: 200,
                    items: [
                        {
                            width: 180,
                            //region: 'center',
                            xtype: 'textfield',
                            itemId: 'query',
                            name: 'queryname',
                            emptyText: '搜索内容',
                            enableKeyEvents: true,
                            listeners: {
                                'keydown': function (el, e, eOpts) {
                                    if (e.getKey() == e.ENTER) {
                                        var condition = this.ownerCt.queryById('query').getValue();
                                        //alert(condition);
                                        if (condition == '' || condition == null) {
                                            //alert('请输入搜索内容');
                                            return;
                                        };
                                        var ngCheckSysFuncTree = this.findParentByType('ngCheckSysFuncTree');//找到根节点
                                        ngCheckSysFuncTree.removeAll();
                                        var orgtitle = "搜索结果";
                                        var title = TranTitle(orgtitle);
                                        var qmenu = Ext.create('Ext.ng.TreePanel', {
                                            autoLoad: false,
                                            height: 600,
                                            split: true,
                                            border: false,
                                            text: "员工",
                                            title: title,
                                            layout: 'fit',
                                            treeFields: [{ name: 'text', type: 'string' },
                                                { name: 'my', type: 'string' }//我的自定义属性
                                            ],
                                            url: MyQueryUrl,
                                            listeners: {
                                                'afterrender': function () {
                                                },
                                                'expand': function () {
                                                    var me = this;
                                                    Ext.apply(this.getStore().proxy.extraParams, { suite: me.suite });
                                                    this.getRootNode().expand();
                                                },
                                                'activate': function () {
                                                    var me = this;
                                                    Ext.apply(this.getStore().proxy.extraParams, { suite: me.suite });
                                                    //this.getRootNode().expand();//有些电脑会全部出发这个事件，达不到懒加载目的
                                                },
                                                'itemdblclick': function (view, rcd, item, idx, event, eOpts) {
                                                    if (rcd.raw.leaf) {
                                                        //WF.Center.openTab(rcd.raw.text, rcd.raw.url);
                                                        var param = { 'str': rcd.raw.text, 'rightname': '', 'managername': rcd.raw.managername, 'moduleno': rcd.raw.moduleno, 'id': rcd.raw.code, 'url': rcd.raw.url, 'suite': rcd.raw.suite };
                                                        window.external.OpenFunction(rcd.raw.url, JSON.stringify(param));
                                                    }
                                                }
                                            }
                                        });
                                        ngCheckSysFuncTree.add(qmenu);
                                        Ext.apply(qmenu.getStore().proxy.extraParams, { condition: condition });
                                        qmenu.getRootNode().expand();//加载第一个
                                        return false;
                                    }
                                }
                            }
                        }, {
                            //region: 'east',
                            //width: 40,
                            //text: '搜索',
                            iconCls: 'icon-Query',
                            handler: function () {
                                //var s = this.up('toolbar');
                                var condition = this.ownerCt.queryById('query').getValue();
                                if (condition == '' || condition == null) {
                                    //alert('请输入搜索内容');
                                    return;
                                };
                                var ngCheckSysFuncTree = this.findParentByType('ngCheckSysFuncTree');//找到根节点
                                ngCheckSysFuncTree.removeAll();
                                var orgtitle = "搜索结果";
                                var title = TranTitle(orgtitle);
                                var qmenu = Ext.create('Ext.ng.TreePanel', {
                                    autoLoad: false,
                                    height: 600,
                                    split: true,
                                    border: false,
                                    text: "员工",
                                    title: title,
                                    layout: 'fit',
                                    treeFields: [{ name: 'text', type: 'string' },
                                        { name: 'checked', type: 'boolean', values: false },
                                        { name: 'my', type: 'string' }//我的自定义属性
                                    ],
                                    //url: C_ROOT + 'SUP/MainTree/LoadMenu', //'HR/EmpInfoList/LoadMenu'
                                    url: MyQueryUrl,
                                    listeners: {
                                        'afterrender': function () {
                                            //this.expandAll();
                                        },
                                        'expand': function () {
                                            var me = this;
                                            Ext.apply(this.getStore().proxy.extraParams, { suite: me.suite });
                                            this.getRootNode().expand();
                                        },
                                        'activate': function () {
                                            var me = this;
                                            Ext.apply(this.getStore().proxy.extraParams, { suite: me.suite });
                                            //this.getRootNode().expand();//有些电脑会全部出发这个事件，达不到懒加载目的
                                        },
                                        'itemdblclick': function (view, rcd, item, idx, event, eOpts) {
                                            if (rcd.raw.leaf) {
                                                WF.Center.openTab(rcd.raw.text, rcd.raw.url);
                                            }
                                        },
                                        'checkchange': function (node, checked) {
                                            setChildNodeChecked(node, checked);
                                        }
                                    }
                                });
                                ngCheckSysFuncTree.add(qmenu);
                                Ext.apply(qmenu.getStore().proxy.extraParams, { condition: condition });
                                qmenu.getRootNode().expand();//加载第一个
                                currentTree = qmenu;
                            }
                        }, {
                            //region: 'east',
                            //width: 40,
                            //text: '刷新',
                            iconCls: 'icon-Refresh',
                            anchor: '100%',
                            handler: function () {
                                //alert('刷新');
                                this.ownerCt.queryById('query').setValue('');
                                var ngCheckSysFuncTree = this.findParentByType('ngCheckSysFuncTree');//找到根节点
                                ngCheckSysFuncTree.removeAll();

                                ngCheckSysFuncTree.loadData();
                                //sysFuncTree.removeAll();
                                //var arr = sysFuncTree.suites;
                                //sysFuncTree.add(arr);
                                //Ext.apply(arr[0].getStore().proxy.extraParams, { suite: arr[0].suite });
                                //arr[0].getRootNode().expand();
                            }
                        }]
                }],
                listeners: {
                    'tabchange': function (tabPanel, newCard, oldCard, eOpts) {
                        currentTree = newCard;
                        if (!newCard.loaded) {
                            var me = newCard;
                            Ext.apply(me.getStore().proxy.extraParams, { suite: me.suite });
                            me.getRootNode().expand();
                            newCard.loaded = true;//已经加载
                        }
                    }
                }
            })
            var sysmenupnl = Ext.create('Ext.ng.checkSysFuncTree', {
                region: 'west',
                width: 330,
                id: 'ngCheckSysFuncTree'
            })

            //左右移动节点的按钮区域
            var choosecenterform = Ext.create('Ext.form.Panel', {
                region: 'west',
                style: 'margin-left:2px;margin-right:0px',
                layout: 'border',
                width: 70,
                split: true,
                autoScroll: true,
                frame: false,
                border: false,
                columnsPerRow: 4,
                fieldDefaults: {
                    labelWidth: 60,
                    anchor: '100%',
                    margin: '0 10 5 0',
                    msgTarget: 'side'
                },
                items: [
                    {
                        region: 'north',
                        xtype: 'button',
                        id: 'rightmove',
                        text: '>',
                        margin: '170 0 0 0',
                        width: 20,
                        height: 20
                    },
                    {
                        region: 'north',
                        xtype: 'button',
                        id: 'leftmove',
                        text: '<',
                        margin: '50 0 0 0',
                        width: 20,
                        height: 20
                    }, {
                        labelWidth: 50,
                        region: 'north',
                        xtype: 'button',
                        margin: '50 0 0 0',
                        id: 'save',
                        text: '保存',
                        iconCls: "icon-save",
                        itemWidth: 40,
                        height: 30,
                        width: 50,
                        left: 10
                    }, {
                        labelWidth: 50,
                        region: 'north',
                        xtype: 'button',
                        margin: '50 0 0 0',
                        id: 'cancel',
                        text: '取消',
                        iconCls: "icon-Cancel",
                        itemWidth: 40,
                        height: 30,
                        width: 50
                    }
                ]
            })

            //上下移动节点的按钮区域
            var changeSeqForm = Ext.create('Ext.form.Panel', {
                region: 'east',
                style: 'margin-left:2px;margin-right:0px',
                layout: 'border',
                width: 40,
                split: true,
                autoScroll: true,
                frame: false,
                border: false,
                columnsPerRow: 4,
                fieldDefaults: {
                    labelWidth: 40,
                    anchor: '100%',
                    margin: '0 10 5 0',
                    msgTarget: 'side'
                },
                items: [
                    {
                        region: 'north',
                        xtype: 'button',
                        id: 'upmove',
                        text: '∧',
                        margin: '170 0 0 0',
                        width: 20,
                        height: 20
                    },
                    {
                        region: 'north',
                        xtype: 'button',
                        id: 'downmove',
                        text: '∨',
                        margin: '50 0 0 0',
                        width: 20,
                        height: 20
                    }
                ]
            })
            Ext.define('editParmModel', {
                extend: 'Ext.data.Model',
                fields: [{
                    name: 'name',
                    type: 'string',
                    mapping: 'Name'
                }, {
                    name: 'description',
                    type: 'string',
                    mapping: 'Description'
                }, {
                    name: 'currentValue',
                    type: 'string',
                    mapping: 'CurrentValue'
                }]
            });
            var editParmStore = Ext.create('Ext.data.Store', { //可以加排序函数对数据排序
                model: 'editParmModel',
                autoLoad: true,
                proxy: { //读取原始数据的途径
                    type: 'ajax',
                    url: C_ROOT + 'SUP/MainTree/LoadEditParm'
                }
            });

            Ext.define('Ext.ng.editParmWin', {
                extend: 'Ext.window.Window',
                alias: 'widget.ngEditParmWin', //别名,可通过设置xtype构建,或者通过Ext.widget()方法构建
                title: '参数编辑',
                height: 500,
                width: 400,
                modal: true,
                closeable: true,
                resizable: false,
                closeAction: "hide",
                father: '',
                fieldDefaults: {
                    //labelAlign: 'top',
                    msgTarget: 'side'
                },
                defaults: {
                    anchor: '100%'
                },
                items: [{
                    xtype: 'container',
                    layout: 'auto',
                    border: false,
                    items: [{
                        xtype: 'toolbar',
                        anchor: '100%',
                        items: [
                            "->",
                            {
                                text: '保存',
                                iconCls: 'icon-save',
                                handler: function () {
                                    var window = this.findParentByType('window');
                                    var textArea = window.items.items[0].items.items[1];
                                    var data = textArea.value;
                                    window.father.items.items[0].items.items[2].items.items[0].items.items[0].items.items[0].setValue(data);
                                    window.close();
                                }
                            },
                            {
                                text: '取消',
                                iconCls: 'icon-Cancel',
                                handler: function () {
                                    var window = this.findParentByType('window');
                                    window.close();
                                }
                            }
                        ]
                    }, {
                        emptyText: '添加宏参数',
                        height: 200,
                        width: 390,
                        itemId: 'parmArea',
                        xtype: 'ngTextArea',
                        grow: true,
                        anchor: '100%'
                    }, {
                        xtype: 'grid',
                        anchor: '100%',
                        height: 200,
                        isVisible: true,
                        itemId: 'pramGrid',
                        store: editParmStore,
                        columns: [
                            { text: '宏', dataIndex: 'name', flex: 1 },
                            { text: '描述', dataIndex: 'description', flex: 1 },
                            { text: '当前值', dataIndex: 'currentValue', flex: 1 }
                        ]
                    }]
                }],
                dockedItems: [{
                    xtype: 'toolbar',
                    dock: 'bottom',
                    ui: 'footer',
                    items: [
                         "->", {
                             text: '插入',
                             handler: function () {
                                 var window = this.findParentByType('window');
                                 var data = window.items.items[0].items.items[2].getSelectionModel().lastSelected.data.name;
                                 data = '№*№' + data + '№*№';
                                 var textArea = window.items.items[0].items.items[1];
                                 var rawValue = textArea.rawValue;
                                 textArea.setValue(rawValue + data);
                             }
                         },
                {
                    text: '宏',
                    handler: function () {
                        var window = this.findParentByType('window');
                        if (window.height > 300) {
                            window.setHeight(300);
                        } else {
                            window.setHeight(500);
                        }
                    }
                }
                    ]
                }]
            });

            Ext.define("Ext.ng.importDocWin", {
                extend: 'Ext.window.Window',
                alias: 'widget.ngImportDocWin',
                title: "节点维护",
                modal: true,
                //width: 500,
                //height: 160,
                width: 600,
                height: 180,
                closeable: true,
                resizable: false,
                //closeAction: "hide",
                winType: '',
                editFileField: '',
                items: [
                {
                    xtype: 'ngTableLayoutForm',
                    //id: 'customMenuNodeTextForm',
                    frame: true,
                    split: true,
                    columnsPerRow: 1,
                    padding: '0 0 0 0',
                    fieldDefaults: {
                        labelWidth: 70,
                        anchor: '100%',
                        margin: '3 3 3 3',
                        msgTarget: 'side'
                    },
                    fields: [
					{
					    xtype: 'ngText',
					    fieldLabel: '文件名称',
					    itemId: 'name',
					    value: '',
					    name: 'NodeText',
					    readOnly: false,
					    mustInput: true,
					    colspan: 1
					},
                    {
                        xtype: 'filefield',
                        buttonText: '...',
                        itemId: 'addr',
                        fieldLabel: '文件地址',
                        name: 'NodeAddr',
                        id: 'NodeAddr',
                        labelStyle: 'color:OrangeRed',
                        readOnly: false,
                        emptyText: '可输入文件类型exe/doc/docx/xls/xlsx/ppt/pptx',
                        mustInput: true,
                        colspan: 1,
                        validator: function (value) {
                            var arr = value.split('.');
                            var tp = false;
                            switch (arr[arr.length - 1].toLowerCase()) {
                                case 'exe':
                                case 'doc':
                                case 'docx':
                                case 'xls':
                                case 'xlsx':
                                case 'ppt':
                                case 'pptx': tp = true;
                            }
                            if (tp) {
                                var importDocWin = this.findParentByType('ngImportDocWin');
                                //if (importDocWin.queryById('name').value == '' || typeof (importDocWin.queryById('name').value) == 'undefined') {
                                if (importDocWin.queryById('name').value == '') {
                                    var a = value.lastIndexOf('\\');
                                    if (a == -1) {
                                        a = 0;
                                    }
                                    var b = value.lastIndexOf('.');
                                    var defaultName = value.substring(a + 1, b);
                                    importDocWin.queryById('name').setValue(defaultName);
                                    //editWin.queryById('name').setValue(currentTreenode[0].data.text);

                                    //var f = document.getElementById('NodeAddr');
                                    //var f = document.getElementById('NodeAddr-inputCell');
                                    //var a = this.el.down('NodeAddr').dom;
                                    //f.select();
                                    //alert(document.selection.createRange().text);
                                }
                                return true;
                            }
                            var input = this.el.down('input').dom;
                            input.value = '可输入文件类型exe/doc/docx/xls/xlsx/ppt/pptx';
                            return "可输入文件类型exe/doc/docx/xls/xlsx/ppt/pptx";
                        },
                    }
					, {
					    xtype: 'fieldset',
					    name: 'NodeEdit',
					    itemId: 'editContainer',
					    padding: '0,0,0,0',
					    layout: 'column',
					    border: false,
					    //width:350,
					    items: [{
					        xtype: 'ngText',
					        itemId: 'edit',
					        fieldLabel: '文件编辑',
					        width: 467,
					        readOnly: true,
					        mustInput: false,
					        colspan: 1,
					    }, {
					        xtype: 'button',
					        itemId: 'btn',
					        colspan: 1,
					        text: '...',
					        handler: function () {
					            var fatherWindow = this.findParentByType('window');
					            var editWin = Ext.create('Ext.ng.editParmWin', {
					                father: fatherWindow
					            });
					        }
					    }]
					}]
                }],
                buttons: [
                    "->",
                    {
                        text: '保 存',
                        itemId: 'save',
                        handler: function () {
                            //var win = this.findParentByType('window');
                            //qurrybyid
                            var nodetext = this.findParentByType('ngImportDocWin').items.items[0].items.items[0].items.items[0].items.items[0].lastValue;
                            var nodeaddr = this.findParentByType('ngImportDocWin').queryById('addr').rawValue;
                            var nodeedit = this.findParentByType('ngImportDocWin').items.items[0].items.items[2].items.items[0].items.items[0].items.items[0].lastValue;
                            //nodeaddr = 'LocalSoft' + nodeaddr + '№,№';
                            while (nodetext == '' || nodetext == null) {
                                //alert('文件名称不能为空');
                                Ext.MessageBox.alert('提示', '文件名称不能为空');
                                return;
                            };
                            while (nodeaddr == '' || nodeaddr == null || nodeaddr == '可输入文件类型exe/doc/docx/xls/xlsx/ppt/pptx') {
                                //alert('文件地址不能为空');
                                Ext.MessageBox.alert('提示', '文件地址不能为空');
                                return;
                            };
                            //企业功能树菜单选择项
                            var selectedNode = currentTree.getSelectionModel().getSelection()[0];

                            if (this.findParentByType('ngImportDocWin').winType == 'add') {
                                if (selectedNode == null)
                                    selectedNode = currentTree.getRootNode();
                                if (selectedNode.data.leaf == true) {
                                    selectedNode = selectedNode.parentNode;
                                }
                                //判断是否非按钮节点
                                if (!selectedNode.data.leaf) {
                                    var newChildNode = selectedNode.appendChild({
                                        id: guid(), //获取唯一值,
                                        //MenuType:2,
                                        text: nodetext,
                                        name: nodetext,
                                        url: nodeaddr,
                                        urlparm: nodeedit,
                                        pid: selectedNode.data.id,
                                        leaf: true,
                                        checked: false,
                                        originalcode: "",
                                        expanded: true
                                    });
                                }
                                else {
                                    Ext.MessageBox.alert('提示', '请选择菜单节点！');
                                };
                            } else {
                                selectedNode.set('text', nodetext);
                                selectedNode.set('name', nodetext);
                                selectedNode.set('url', nodeaddr);
                                selectedNode.set('urlparm', nodeedit);
                            }
                            this.findParentByType('ngImportDocWin').close();
                        }
                    },
                    {
                        text: '关 闭',
                        itemId: 'close',
                        handler: function () {
                            this.findParentByType('ngImportDocWin').close();
                        }
                    }
                ]
            });
            Ext.define("Ext.ng.importUrlWin", {
                extend: 'Ext.window.Window',
                alias: 'widget.ngImportUrlWin',
                title: "节点维护",
                modal: true,
                //width: 500,
                //height: 160,
                width: 600,
                height: 180,
                closeable: true,
                resizable: false,
                closeAction: "hide",
                winType: '',
                items: [
                {
                    xtype: 'ngTableLayoutForm',
                    //id: 'customMenuNodeTextForm',
                    frame: true,
                    split: true,
                    columnsPerRow: 1,
                    padding: '0 0 0 0',
                    fieldDefaults: {
                        labelWidth: 70,
                        anchor: '100%',
                        margin: '3 3 3 3',
                        msgTarget: 'side'
                    },
                    fields: [
					{
					    xtype: 'ngText',
					    fieldLabel: '链接名称',
					    itemId: 'name',
					    name: 'NodeText',
					    readOnly: false,
					    mustInput: true,
					    colspan: 1
					}, {
					    xtype: 'ngText',
					    itemId: 'addr',
					    fieldLabel: '链接地址',
					    labelStyle: 'color:OrangeRed',
					    name: 'NodeAddr',
					    readOnly: false,
					    mustInput: true,
					    colspan: 1
					}, {
					    xtype: 'fieldset',
					    name: 'NodeEdit',
					    itemId: 'editContainer',
					    padding: '0,0,0,0',
					    layout: 'column',
					    border: false,
					    colspan: 1,
					    items: [{
					        xtype: 'ngText',
					        itemId: 'edit',
					        fieldLabel: '链接编辑',
					        readOnly: true,
					        //width:387,
					        width: 467,
					        mustInput: false
					    }, {
					        xtype: 'button',
					        itemId: 'btn',
					        text: '...',
					        handler: function () {
					            var fatherWindow = this.findParentByType('window');
					            var editWin = Ext.create('Ext.ng.editParmWin', {
					                father: fatherWindow
					            });
					            var parm = fatherWindow.queryById('edit').value;
					            editWin.queryById('parmArea').setValue(parm);
					            //editWin.queryById('parmArea').focus(true,true);
					            editWin.show();
					        }
					    }]
					}
                    ]
                }
                ],
                buttons: [
                    "->",
                    {
                        text: '保 存',
                        itemId: 'save',
                        handler: function () {
                            //var win = this.findParentByType('window');
                            //qurrybyid
                            var nodetext = this.findParentByType('ngImportUrlWin').items.items[0].items.items[0].items.items[0].items.items[0].lastValue;
                            var nodeaddr = this.findParentByType('ngImportUrlWin').items.items[0].items.items[1].items.items[0].items.items[0].lastValue;
                            var nodeedit = this.findParentByType('ngImportUrlWin').items.items[0].items.items[2].items.items[0].items.items[0].items.items[0].lastValue;
                            //nodeaddr = 'WebBrowseIndividualManager№,№Caption№=№' + nodetext + '№,№Url№=№' + nodeaddr;
                            while (nodetext == '' || nodetext == null) {
                                Ext.MessageBox.alert('提示', '链接名称不能为空');
                                //alert('链接名称不能为空');
                                return;
                            };
                            while (nodeaddr == '' || nodeaddr == null) {
                                Ext.MessageBox.alert('提示', '链接地址不能为空');
                                //alert('链接地址不能为空');
                                return;
                            };
                            //企业功能树菜单选择项
                            var selectedNode = currentTree.getSelectionModel().getSelection()[0];

                            if (this.findParentByType('ngImportUrlWin').winType == 'add') {
                                if (selectedNode == null)
                                    selectedNode = currentTree.getRootNode();
                                if (selectedNode.data.leaf == true) {
                                    selectedNode = selectedNode.parentNode;
                                }
                                //判断是否非按钮节点
                                if (!selectedNode.data.leaf) {
                                    var p = new Object({
                                        alreadyitem: nodetext,
                                        customtext: nodetext,
                                        id: "",
                                        lineid: (gridPanel.store.getCount() + 1),
                                        managername: '',
                                        menuid: '',
                                        menutypecode: "",
                                        moduleno: '',
                                        name: "",
                                        param: nodeedit,
                                        rightkey: '',
                                        rightname: '',
                                        suite: '',
                                        runadr: nodeaddr,
                                    });
                                    gridPanel.store.add(p);
                                    check = false;
                                }
                                else {
                                    Ext.MessageBox.alert('提示', '请选择菜单节点！');
                                };
                            } else {
                                selectedNode.set('text', nodetext);
                                selectedNode.set('name', nodetext);
                                selectedNode.set('url', nodeaddr);
                                selectedNode.set('urlparm', nodeedit);
                            }
                            this.findParentByType('ngImportUrlWin').close();
                        }
                    },
                    {
                        text: '关 闭',
                        itemId: 'close',
                        handler: function () {
                            this.findParentByType('ngImportUrlWin').close();
                        }
                    }
                ],
                listeners: {
                    'beforeclose': function (panel, eOpts) {
                        StoreloadMarsk.hide();
                    }
                }
            });
            //弹出winform时沉默页面
            StoreloadMarsk = new Ext.LoadMask(document.body, {
                //msg: '导入文件',
                disabled: false,
                useMsg: false
            });

            customEditToolbar = new Ext.panel.Panel({
                region: 'north',
                height: 38,
                border: false,
                style: 'margin-top:1px;margin-bottom:1px',
                bodyStyle: "background-color:transparent",
                ////#dfe8f6
                items: [{
                    layout: {
                        type: 'hbox',
                        padding: '0',
                        pack: 'start',
                        align: 'middle'
                    },
                    border: false,
                    defaults: { margins: '0 5 0 0' },
                    bodyStyle: "background-color:transparent", //#dfe8f6
                    items: [
                        {
                            xtype: 'toolbar', text: '我的功能树',
                            items: [
                               {
                                   text: '导入文件',
                                   iconCls: 'icon-Import',
                                   itemId: 'importTxt',
                                   hidden:isWeb,
                                   handler: function () {
                                       //Ext.create("Ext.ng.importDocWin", {
                                       //    title: '导入文件',
                                       //    winType:'add'
                                       //}).show();
                                       //var e = window.event;
                                       //e.stopEvent();
                                       StoreloadMarsk.show();
                                       window.external.UploadProgramme('', '', '', 'add');
                                       //stopEvent();
                                       //alert(s);
                                   }
                               }, {
                                   text: '导入网址',
                                   iconCls: 'icon-Import',
                                   itemId: 'importUrl',
                                   hidden: isWeb,
                                   handler: function () {
                                       StoreloadMarsk.show();
                                       if (isWeb) {
                                           var importUrlWin = Ext.create("Ext.ng.importUrlWin", {
                                               title: '导入网址',
                                               winType: 'add'
                                           });
                                           importUrlWin.queryById('addr').setValue('http://');
                                           importUrlWin.show();
                                       } else {
                                           window.external.UploadWebsite('', '', '', 'add');
                                       }
                                   }
                               //}, {
                               //    text: '图标管理',
                               //    iconCls: 'icon-Import',
                               //    itemId: 'iconManage',
                               //    handler: function () {
                               //    }
                               }, {
                                   text: '编辑',
                                   iconCls: 'cog_edit',
                                   itemId: 'edit',
                                   hidden: true,
                                   handler: function () {
                                       var currentTreenode = gridPanel.getSelectionModel().getSelection();
                                       var arr = currentTreenode[0].raw.runadr.split('.');
                                       var tp = false;
                                       switch (arr[arr.length - 1].toLowerCase()) {
                                           case 'exe':
                                           case 'doc':
                                           case 'docx':
                                           case 'xls':
                                           case 'xlsx':
                                           case 'ppt':
                                           case 'pptx': tp = true;
                                       }
                                       if (tp == true) {
                                           //var editWin = Ext.create("Ext.ng.importDocWin", {
                                           //    title: '编辑文件',
                                           //    winType: 'edit',
                                           //    editFileField: currentTreenode[0].data.runadr
                                           //});
                                           ////editWin.queryById('addr').setValue(currentTreenode[0].raw.url);
                                           //editWin.queryById('addr').on('afterrender', function (fileField) {
                                           //    var input = editWin.queryById('addr').el.down('input').dom;
                                           //    input.value = currentTreenode[0].data.runadr;
                                           //});
                                           //editWin.queryById('name').setValue(currentTreenode[0].data.customtext);
                                           //editWin.queryById('edit').setValue(currentTreenode[0].data.param);
                                           StoreloadMarsk.show();
                                           window.external.UploadProgramme(currentTreenode[0].data.customtext, currentTreenode[0].data.runadr, currentTreenode[0].data.parm, 'edit');

                                       } else {
                                           //var editWin = Ext.create("Ext.ng.importUrlWin", {
                                           //    title: '编辑网址',
                                           //    winType: 'edit'
                                           //});
                                           //editWin.queryById('name').setValue(currentTreenode[0].data.customtext);
                                           //editWin.queryById('addr').setValue(currentTreenode[0].data.runadr);
                                           //editWin.queryById('edit').setValue(currentTreenode[0].data.param);
                                           StoreloadMarsk.show();
                                           window.external.UploadWebsite(currentTreenode[0].data.customtext, currentTreenode[0].data.runadr, currentTreenode[0].data.parm, 'edit');
                                       }
                                   }
                               }
                            ]
                        }]
                }]
            });

            //右侧grid页面
            var itemsPerPage = 20;
            Ext.define('gridModel', {
                extend: 'Ext.data.Model',
                fields: [{
                    name: 'id',
                    type: 'string',
                    mapping: 'id'
                }, {
                    name: 'alreadyitem',
                    type: 'string',
                    mapping: 'alreadyitem'
                }, {
                    name: 'customtext',
                    type: 'string',
                    mapping: 'customtext'
                }, {
                    name: 'runadr',
                    type: 'string',
                    mapping: 'runadr'
                }, {
                    name: 'menutypecode',
                    mapping: 'menutypecode',
                    type: 'string'
                }, {
                    name: 'menuid',
                    mapping: 'menuid',
                    type: 'string'
                }, {
                    name: 'lineid',
                    mapping: 'lineid',
                    type: 'int'
                },
              //fg3_menu.managername,fg3_menu.rightname,fg3_menu.suite,fg3_menu.moduleno,fg3_menu.rightkey
                {
                    name: 'managername',
                    mapping: 'managername',
                    type: 'string'
                },
                {
                    name: 'rightname',
                    mapping: 'rightname',
                    type: 'string'
                },
                {
                    name: 'suite',
                    mapping: 'suite',
                    type: 'string'
                },
                {
                    name: 'moduleno',
                    mapping: 'moduleno',
                    type: 'string'
                },
                {
                    name: 'rightkey',
                    mapping: 'rightkey',
                    type: 'int'
                }, {
                    name: 'name',
                    mapping: 'name',
                    type: 'string'
                }, {
                    name: 'param',
                    mapping: 'param',
                    type: 'string'
                },
                ]
            });


            var gridStore = Ext.create('Ext.data.Store', { //可以加排序函数对数据排序
                model: 'gridModel',
                autoLoad: true,
                pageSize: itemsPerPage,
                sortOnLoad: true,
                proxy: {
                    type: 'ajax',
                    url: C_ROOT + 'SUP/MyCommonFunc/LoadMyMenu',
                    reader: {
                        type: 'json',
                        root: 'Record',
                        totalProperty: 'totalRows'
                    }
                }
            });

            var dataView = Ext.create('Ext.view.View', {
                store: Ext.data.StoreManager.lookup('iconsStore'),
                tpl: new Ext.XTemplate(
                    '<ul style="list-style-type:none;-webkit-padding-start: 3px">',
                        '<tpl for=".">',
                            '<li style="background-color:rgb(158,193,225);width:74px;height:74px;float:left;margin:2px" class="iconview" onclick=ClickIcon("{src}","{id}")>',
                                '<img width="74" height="74" src="{src}" />',
                            '</li>',
                        '</tpl>',
                    '</ul>'
                ),
                id: 'dataView',
                itemSelector: 'li.iconview',
                style: {
                    'top': '-8px'
                    //'overflow-x': 'hidden'
                }
            });

            //分类的数据
            Ext.define('menuTypeModel', {
                extend: 'Ext.data.Model',
                fields: [{
                    name: 'code',
                    type: 'string',
                    mapping: 'code'
                }, {
                    name: 'name',
                    type: 'string',
                    mapping: 'name'
                }]
            });

            var menuTypeStore = Ext.create('Ext.data.Store', {
                model: 'menuTypeModel',
                autoLoad: false,
                proxy: {
                    type: 'ajax',
                    url: C_ROOT + 'SUP/MyCommonFunc/LoadMyMenuType',
                    reader: {
                        type: 'json',
                        root: 'Record',
                        totalProperty: 'totalRows'
                    }
                }
            });

            gridPanel = Ext.create('Ext.ng.GridPanel', {
                region: 'center',
                store: gridStore,
                buskey: 'phid',
                columns: [
                    { header: '', dataIndex: 'id', flex: 1, sortable: true, editable: false, hidden: true },
                    { header: '已加项', dataIndex: 'alreadyitem', flex: 1, sortable: true, editable: false },
                    {
                        header: '显示名', dataIndex: 'customtext', flex: 1, sortable: true, editable: true,
                        editor: {
                            xtype: 'ngText',
                            displayField: 'customtext',
                            valueField: 'customtext',
                            isInGrid: true,
                        }
                    },
                    {
                        header: '分类', dataIndex: 'name', flex: 1, sortable: true,
                        editor: {
                            xtype: 'ngComboBox',
                            store: menuTypeStore,
                            displayField: 'name',
                            valueField: 'code',
                            editable: false,
                            isInGrid: true,
                            listeners: {
                                helpselected: function (obj) {
                                    debugger;
                                    var data = this.findParentByType('ngGridPanel').getSelectionModel().getSelection();
                                    data[0].set('menutypecode', obj.code);
                                },
                            },
                        },
                    },
                    {
                        header: '参数', dataIndex: 'param', flex: 1, sortable: false, editable: true
                        //editor: {
                        //    xtype: 'ngText',
                        //    displayField: 'urlparam',
                        //    valueField: 'urlparam',
                        //    isInGrid: true,
                        //}
                    }
                ],

                dockedItems: [{
                    xtype: 'pagingtoolbar',
                    dock: 'bottom',
                    displayInfo: true,
                    store: gridStore,
                }],
                //uniqueColumn: [{ col: 'shortcutkey' }],
                plugins: [
                    Ext.create('Ext.grid.plugin.CellEditing', {
                        clicksToEdit: 1
                    })
                ],
                listeners: {
                    'itemclick': function (view, rcd, item, idx, event, eOpts) {
                        debugger;
                        var selectedNode = gridPanel.getSelectionModel().getSelection()[0];
                        if (isWeb) {
                            return;
                        }
                        if (selectedNode.raw.suite == '' || selectedNode.raw.suite == null) {
                            customEditToolbar.queryById('edit').show();
                        } else {
                            customEditToolbar.queryById('edit').hide();
                        }
                    },
                }
            });

            //常用功能grid列表
            var custommenupnl = Ext.create('Ext.panel.Panel', {
                region: 'center',
                style: 'margin-left:2px;margin-right:2px',
                //title: '企业功能树菜单',
                layout: 'border',
                border: 0,
                items: [customEditToolbar, gridPanel]
            });

            //布局
            var viewport = Ext.create('Ext.container.Viewport', {
                id: "viewPort",
                layout: 'border',
                items: [
                {
                    id: 'myPanel',
                    xtype: 'panel',
                    //height: 500,
                    //width: 600,
                    region: 'center',
                    layout: 'border',
                    bodyStyle: "padding-right:5px",
                    items: [
                        sysmenupnl,
                        choosecenterform,
                        custommenupnl,
                        changeSeqForm
                    ]
                }
                ]
            });

            ////右移
            //choosecenterform.items.get('rightmove').on('click', function () {
            //    var pNodeData = [];
            //    var checkNodes = currentTree.getView().getChecked();
            //    if (checkNodes.length == 0) {
            //        Ext.MessageBox.alert('提示', '请选择系统节点！');
            //        return;
            //    }
            //    var root = currentTree.getRootNode();
            //    var someNodeExist = false;
            //    Ext.Array.each(checkNodes, function (node1) {
            //        //if (node1.raw.id == 'root') {
            //        //    return true;
            //        //}
            //        var exist = false;
            //        //判断被选中节点中有没有当前节点的父节点
            //        node1.raw.fatherId = false;
            //        node1.raw.exist = false;
            //        Ext.Array.each(checkNodes, function (node2) {
            //            if (node1.data.parentId == node2.data.id) {
            //                node1.raw.fatherId = true;
            //            }
            //        });
            //        //判断树中是否已存在node节点
            //        Ext.Array.each(root, function (node3) {
            //            if (node1.raw.exist != true) {
            //                isNodeExist(node1, node3);
            //            }
            //        });
            //        if (node1.raw.exist == true) {
            //            exist = true;
            //            node1.set('checked', false);
            //        }
            //        if (!exist) {
            //            pNodeData.push({ text: node1.data.text, id: node1.data.id, fatherId: node1.raw.fatherId, pid: (node1.parentNode == null) ? '' : node1.parentNode.id });
            //        } else {
            //            someNodeExist = true;
            //        }
            //    });
            //    if (someNodeExist == true) {
            //        Ext.MessageBox.alert('提示', '某些节点已存在，已从选中节点中排除');
            //        //alert('某些节点已存在，已从选中节点中排除');
            //    }
            //    if (pNodeData.length == 0) return;
            //    //我的功能树菜单选择项
            //    var currentTreenode = currentTree.getSelectionModel().getSelection();
            //    //判断是否非按钮节点
            //    if (currentTreenode.length > 0 && currentTreenode[0].data.leaf) {
            //        Ext.MessageBox.alert('提示', '请选择非叶子节点！');
            //        //Ext.MessageBox.alert('提示', '请选择非叶子节点！');
            //        return;
            //    }
            //    for (var i = 0; i < pNodeData.length; i++) {
            //        //如果该节点的父节点在被选中节点内，不必在此添加该节点
            //        if (pNodeData[i].fatherId == true) {
            //            //var selectedSysNode = currentTree.getStore().getNodeById(pNodeData[i].id);
            //            //AddSystemMenuToCustomMenu(pNodeData[i].pid, selectedSysNode)
            //        }
            //        else
            //            if (currentTreenode == null || currentTreenode.length == 0) {
            //                //没选择我的功能树菜单节点，在根目录添加
            //                var rootNode = currentTree.getRootNode();
            //                var selectedSysNode = currentTree.getStore().getNodeById(pNodeData[i].id);
            //                AddSystemMenuToCustomMenu(rootNode.data.id, selectedSysNode)
            //            }
            //            else {
            //                //选择菜单节点[非按钮节点]
            //                var selectedSysNode = currentTree.getStore().getNodeById(pNodeData[i].id);
            //                AddSystemMenuToCustomMenu(currentTreenode[0].data.id, selectedSysNode)
            //            }
            //    }
            //});

            //右移
            choosecenterform.items.get('rightmove').on('click', function () {

                var checkNode = currentTree.getSelectionModel().getSelection();
                if (checkNode.length == 0) {
                    Ext.MessageBox.alert('提示', '请选择你要添加的常用功能！');
                    return;
                }
                for (var i = 0; i < gridPanel.store.getCount() ; i++) {
                    //debugger;
                    if (gridPanel.store.data.items[i].raw.menuid == checkNode[0].raw.id) {
                        Ext.MessageBox.alert('提示', '该节点已存在！');
                        return;
                    }
                }
                if (checkNode[0].data['leaf']) {
                    var p = new Object({
                        alreadyitem: checkNode[0].data.text,
                        customtext: checkNode[0].data.text,
                        id:"",
                        lineid: (gridPanel.store.getCount()+1),
                        managername: checkNode[0].raw.managername,
                        menuid: checkNode[0].raw.id,
                        menutypecode:"",
                        moduleno: checkNode[0].raw.moduleno,
                        name:"",
                        param:"",
                        rightkey: checkNode[0].raw.rightkey,
                        rightname: checkNode[0].raw.rightname,
                        suite: checkNode[0].raw.suite,
                        runadr: checkNode[0].raw.url,
                    });
                    gridPanel.store.add(p);
                    check = false;
                }
                else {
                    Ext.MessageBox.alert('提示', '只能选择叶子节点作为常用功能！');
                }

            });

            //左移
            choosecenterform.items.get('leftmove').on('click', function () {
                var data = gridPanel.getSelectionModel().getSelection();
                if (data == null || data == '') {
                    Ext.MessageBox.alert('提示', '请选中你要删除的常用功能！');
                }
                else {
                    var lineid = gridPanel.getSelectionModel().getSelection()[0].data.lineid - 1;
                    //gridPanel.store.removeAt(lineid, 1);
                    gridPanel.store.remove(gridPanel.getSelectionModel().getSelection()[0]);
                    check = false;
                }
            });

            //保存
            choosecenterform.items.get('save').on('click', function () {
                var gridData = gridPanel.getAllGridData();
                for (var i = 0; i < gridPanel.store.getCount() ; i++) {
                    if (gridPanel.store.data.items[i].data.menutypecode == '' || gridPanel.store.data.items[i].data.menutypecode == null) {
                        Ext.MessageBox.alert('提示', '请给常用功能选择分类！');
                        return;
                    }
                }
                Ext.Ajax.request({
                    url: C_ROOT + 'SUP/MyCommonFunc/SaveMyMenu',
                    params: {
                        "gridData": gridData,
                    },
                    success: function (response) {
                        if (response.text != null && response.text != '') {
                            Ext.MessageBox.alert('提示', '常用功能保存成功！');
                            check = true;
                        }
                        else {
                            Ext.MessageBox.alert('提示', '常用功能保存失败！');
                        }
                    }
                });

            });

            //取消
            choosecenterform.items.get('cancel').on('click', function () {
                if (!check) {
                    Ext.MessageBox.confirm('提示', '当前页面数据未保存，你确定要离开么？', callBack);
                    function callBack(id) {
                        if (id == 'yes') {
                            $CloseTab();
                        }
                    }
                }
                else {
                    $CloseTab();
                }
            });

            //上移
            changeSeqForm.items.get('upmove').on('click', function () {
                var select = gridPanel.getSelectionModel().getSelection();
                if (select.length== 0) {
                    Ext.MessageBox.alert('提示', '请选择你要移动的常用功能！');
                    return false;
                }
                    var index = select[0].data.lineid-1;
                    if (index == '0') {
                        Ext.MessageBox.alert('提示', '常用功能已经是第一个！');
                    }
                    else {
                        var node1 = gridStore.getAt(index);
                        var node2 = gridStore.getAt(parseInt(index) - 1);

                        value1 = node1.get('lineid');
                        value2 = node2.get('lineid');
                        node1.set('lineid', value2);
                        node2.set('lineid', value1);
                        gridStore.sort('lineid', 'asc');
                        gridPanel.getSelectionModel().select(parseInt(index) - 1);
                    }
            });

            //下移
            changeSeqForm.items.get('downmove').on('click', function () {
                var select = gridPanel.getSelectionModel().getSelection();
                if (select.length == 0) {
                    Ext.MessageBox.alert('提示', '请选择你要移动的常用功能！');
                    return false;
                }
                    var count = gridStore.getTotalCount();

                    var index = select[0].data.lineid - 1;
                    if (index == count - 1) {
                        Ext.MessageBox.alert('提示', '常用功能已经是最后一个！');
                    }
                    else {
                        var node1 = gridStore.getAt(index);
                        var node2 = gridStore.getAt(parseInt(index) + 1);

                        value1 = node1.get('lineid');
                        value2 = node2.get('lineid');
                        gridStore.getAt(index).set('lineid', value2);
                        gridStore.getAt(parseInt(index) + 1).set('lineid', value1);
                        gridStore.sort('lineid', 'asc');
                        gridPanel.getSelectionModel().select(parseInt(index) + 1);
                    }
            });
        });

        function UploadProgrammeCallback(btnFlag, name, addr, pram, winType) {

            if (btnFlag != 'True') {
                StoreloadMarsk.hide();
                return;
            }
            var nodetext = name;
            var nodeaddr = decodeURIComponent(addr);
            var nodeedit = pram;
            if (winType == 'add') {
                var p = new Object({
                    alreadyitem: nodeaddr,
                    customtext: nodetext,
                    id: "",
                    lineid: (gridPanel.store.getCount() + 1),
                    managername: '',
                    menuid: '',
                    menutypecode: "",
                    moduleno: '',
                    name: "",
                    param: nodeedit,
                    rightkey: '',
                    rightname: '',
                    suite: '',
                    runadr: nodeaddr,
                });
                gridPanel.store.add(p);
                check = false;
            } else {
                var select = gridPanel.getSelectionModel().getSelection()[0];
                select.set('customtext', nodetext);
                select.set('alreadyitem', nodeaddr);
                select.set('runadr', nodeaddr);
                select.set('param', nodeedit);
            }



        }

        function UploadWebsiteCallback(btnFlag, name, addr, pram, winType) {
            //var win = this.findParentByType('window');
            //qurrybyid
            //var nodetext = this.findParentByType('ngImportDocWin').items.items[0].items.items[0].items.items[0].items.items[0].lastValue;
            //var nodeaddr = this.findParentByType('ngImportDocWin').queryById('addr').rawValue;
            //var nodeedit = this.findParentByType('ngImportDocWin').items.items[0].items.items[2].items.items[0].items.items[0].items.items[0].lastValue;

            if (btnFlag != 'True') {
                StoreloadMarsk.hide();
                return;
            }
            var nodetext = name;
            //var nodeaddr = unescape(addr);
            var nodeaddr = addr;
            var nodeedit = pram;
            if (winType == 'add') {
                var p = new Object({
                    alreadyitem: nodeaddr,
                    customtext: nodetext,
                    id: "",
                    lineid: (gridPanel.store.getCount() + 1),
                    managername: '',
                    menuid: '',
                    menutypecode: "",
                    moduleno: '',
                    name: "",
                    param: nodeedit,
                    rightkey: '',
                    rightname: '',
                    suite: '',
                    runadr: nodeaddr,
                });
                gridPanel.store.add(p);
                check = false;
            } else {
                var select = gridPanel.getSelectionModel().getSelection()[0];
                select.set('customtext', nodetext);
                select.set('alreadyitem', nodeaddr);
                select.set('runadr', nodeaddr);
                select.set('param', nodeedit);
            }

        }

        function myIsIE() {
            if (!!window.ActiveXObject || "ActiveXObject" in window)
                return true;
            else
                return false;
        }
        function TranTitle(title) {

            var userAgent = navigator.userAgent;
            var reIE = new RegExp("MSIE (\\d+\\.\\d+);");
            reIE.test(userAgent);
            var fIEVersion = parseFloat(RegExp["$1"]);

            var height = '15px';
            var width = title.length * 15;
            var left = title.length * 7.0 + 2;
            if (myIsIE()) {
                width = title.length * 17;
                left = title.length * 7.5;
            }
            if (!myIsIE()) {
                title = "<div style='-o-transform:rotate(90deg);-webkit-transform: rotate(90deg);-moz-transform:rotate(90deg);filter:progid:DXImageTransform.Microsoft.BasicImage(rotation=180);width:" + width + "px;height:" + height + ";left:" + left + "px !important;position: relative;padding: 8px 8px 8px 8px;'>"
                            + title.split('').join('<br>') + "</div>";
            }
            else {
                if (fIEVersion <= 9) {
                    title = title.split('').join('<br>');
                } else {
                    title = "<div style='transform:rotate(90deg);-ms-transform: rotate(90deg);width:" + width + "px;height:" + height + ";left:" + left + "px !important;position: relative;padding: 8px 8px 8px 8px;'>"
                                + title.split('').join('<br>') + "</div>";
                }
            }
            return title;
        };
    </script>


}


