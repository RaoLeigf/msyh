@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Script
{
    <script src="@Url.Script("~/NG3Resource/js/NG3APPcommon.js")" type="text/javascript"></script>
    <script src=@Url.Script("~/NG3Resource/js/help/WorkFlowHelp.js") type="text/javascript" charset="utf-8"></script>
    <script src=@Url.Script("~/NG3Resource/js/help/EmpHelp.js") type="text/javascript" charset="utf-8"></script>
    <script src=@Url.Script("~/NG3Resource/js/help/OrgHelp.js") type="text/javascript" charset="utf-8"></script>
    <script src="@Url.Script("~/Resource/attach/js/loadattach.js")" type="text/javascript" charset="utf-8"></script>

    @*
        <script src=@Url.Script("~/NG3Resource/js/G6H/GHProjNameHelp.js") type="text/javascript" charset="utf-8"></script>*@
    <script src=@Url.Script("~/NG3Resource/js/ExMergeGrid.js") type="text/javascript" charset="utf-8"></script>

    <script src=@Url.Script("~/NG3Resource/IndividualInfo/GXM/XM/ProjectMstEdit.js") type="text/javascript" charset="utf-8"></script>
    <script src=@Url.Script("~/NG3Resource/IndividualInfo/GQT/QT/YJK.js") type="text/javascript" charset="utf-8"></script>
    @*
        <script src="@ViewBag.UserDefScriptUrl" type="text/javascript" charset="utf-8"></script>*@
    <script type="text/javascript">
        //多语言，在Controller调用base.InitialMultiLanguage(busType)方法获取
        var langinfo = Ext.htmlDecode("@ViewBag.NG3Lang");
        var Lang = (langinfo || Ext.isEmpty(langinfo)) ? {} : JSON.parse(langinfo);

        //从viewBag获取自定义信息，在Controller调用base.GetIndividualUI(busType)方法获取
        var defCustomInfo = Ext.htmlDecode('@ViewBag.IndividualInfo');
        if (Ext.isEmpty(defCustomInfo)) {
            //数据库没有，取js模板的individualConfigInfo
            defCustomInfo = individualConfigInfo;
        }

        //自定义信息与多语言合并
        var individualInfo = $DealIndividualInfo(defCustomInfo, Lang);
    </script>
    <script type="text/javascript">
        var otype = '@ViewBag.OType';
        var busid = '@ViewBag.ID';
		//var busno = '@ViewBag.No';
        var ProjStatus = '@ViewBag.ProjStatus'; //页面进来的项目状态
        var midEdit = '@ViewBag.midEdit';   //预立项调整
        var memoRight = '@ViewBag.memoRight'; //是不是批注
        var IndividualinfoId = '@ViewBag.IndividualinfoId';   //自定义界面对应金额主键
        var changeIndividualinfoId = '@ViewBag.changeIndividualinfoId'; //是否是自动切换模板
        var attachGuid = '';
        var attachment;
        var activeTab = 3;
        var tempData;
        
        var XMreference = '@ViewBag.XMreference'; 

        var dataYear = sessionStorage.getItem("FYear");

        var memoWinShow = false;//批注界面有没有打开判断
        var MemoStore = [["FYear", "项目年度(主表)"],
            ["FProjName", "项目名称(主表)"], ["FDeclarationUnit", "申报单位(主表)"], ["FDeclarationDept", "申报部门(主表)"], ["FBudgetDept", "预算部门(主表)"], ["FProjAttr", "项目属性(主表)"], ["FDuration", "存续期限(主表)"],
            ["FExpenseCategory", "项目类型(主表)"], ["FStartDate", "开始日期(主表)"], ["FEndDate", "结束日期(主表)"],
        ["FProjAmount", "项目金额(主表)"], ["FIfPerformanceAppraisal", "是否绩效评价(主表)"], ["FIfKeyEvaluation", "是否重点评价(主表)"], ["FMeetingTime", "会议时间(主表)"],
        ["FMeetiingSummaryNo", "会议纪要编号(主表)"], ["FIfPurchase", "是否集中采购(主表)"], ["FPerformType", "绩效项目类型(主表)"], ["FPerformEvalType", "绩效评价类型(主表)"],
        ["FFunctionalOverview", "部门职能概述(明细表)"], ["FProjOverview", "项目概况(明细表)"], ["FProjBasis", "立项依据(明细表)"], ["FFeasibility", "可行性(明细表)"], ["FNecessity", "必要性(明细表)"],
        ["FLTPerformGoal", "总体绩效目标(明细表)"], ["FAnnualPerformGoal", "年度绩效目标(明细表)"],
            ["FName", "名称(明细表)"], ["FQty", "天数(明细表)"],
        ["FQty2", "人数(明细表)"], ["FPrice", "单价(明细表)"], ["FAmount", "项目明细金额(明细表)"], ["FSourceOfFunds", "项目明细资金来源(明细表)"], ["FBudgetAccounts", "预算科目(明细表)"],
        ["FOtherInstructions", "其他说明(明细表)"], ["FPaymentMethod", "支付方式(明细表)"], ["FExpensesChannel", "支出渠道(明细表)"], ["FFeedback", "反馈意见(明细表)"],
        ["FIfPurchase", "是否集中采购(明细表)"], ["FQtZcgnfl", "支出功能分类科目(明细表)"],
        // ["FSourceOfFunds", "资金申请资金来源(明细表)"], ["FAmount", "资金申请金额(明细表)"],
            ["FImplContent", "实施内容(明细表)"], ["FStartDate", "开始日期(明细表)"], ["FEndDate", "结束日期(明细表)"], ["FNum", "数量(明细表)"]
        ];
        var mainAreaField = ['FYear', "FProjName", "FDeclarationUnit", "FBudgetDept","FDeclarationDept", "FProjAttr", "FDuration", "FExpenseCategory", "FStartDate", "FEndDate",
            "FProjAmount", "FIfPerformanceAppraisal", "FIfKeyEvaluation", "FMeetingTime", "FMeetiingSummaryNo", "FIfPurchase", "FPerformType", "FPerformEvalType"];
        var mainAreaFieldName = ["项目年度(主表)", "项目名称(主表)", "申报单位(主表)", "预算部门(主表)", "申报部门(主表)", "项目属性(主表)", "存续期限(主表)", "项目类型(主表)", "开始日期(主表)", "结束日期(主表)",
            "项目金额(主表)", "是否绩效评价(主表)", "是否重点评价(主表)", "会议时间(主表)", "会议纪要编号(主表)", "是否集中采购(主表)", "绩效项目类型(主表)", "绩效评价类型(主表)"];
        var dtlAreaField = [ "FName",  "FQty", "FQty2",
            "FPrice", "FAmount", "FSourceOfFunds", "FBudgetAccounts", "FOtherInstructions", "FPaymentMethod", "FExpensesChannel", "FFeedback", "FIfPurchase", "FQtZcgnfl", "FNum"];//预算明细
        var dtlAreaFieldName = [ "名称(明细表)",  "天数(明细表)", "人数(明细表)",
            "单价(明细表)", "项目明细金额(明细表)", "项目明细资金来源(明细表)", "预算科目(明细表)", "其他说明(明细表)", "支付方式(明细表)", "支出渠道(明细表)", "反馈意见(明细表)", "是否集中采购(明细表)", "支出功能分类科目(明细表)", "数量(明细表)"];
        var TextAreaField = ["FFunctionalOverview", "FProjOverview", "FProjBasis", "FFeasibility", "FNecessity", "FLTPerformGoal", "FAnnualPerformGoal",];
        var TextAreaFieldName = ["部门职能概述(明细表)", "项目概况(明细表)", "立项依据(明细表)", "可行性(明细表)", "必要性(明细表)", "总体绩效目标(明细表)", "年度绩效目标(明细表)"];//文字区
        var FundApplAreaField = ["FSourceOfFunds", "FAmount"];//资金来源
        var FundApplAreaFieldName = ["资金申请资金来源(明细表)","资金申请金额(明细表)"];
        var ImplPlanAreaField = ["FImplContent", "FStartDate", "FEndDate"];//实施计划
        var ImplPlanAreaFieldName = ["实施内容(明细表)", "开始日期(明细表)", "结束日期(明细表)"];
        var IFchangeValue = ["FIfPerformanceAppraisal", "FIfKeyEvaluation", "FIfPurchase"];//是否值替换（1是，2 否）
        var EXNameValue = ["FSourceOfFunds", "FPaymentMethod", "FBudgetAccounts", "FQtZcgnfl", "FExpensesChannel"];//需要取EXName值的列
        var mainHelpSelected = ["FDeclarationUnit", "FBudgetDept", "FExpenseCategory", "FPerformEvalType", "FPerformType"]; //主表区取值
        var dtlHelpSelected = ["FBudgetAccounts", "FQtZcgnfl", "FExpensesChannel", "FSourceOfFunds", "FPaymentMethod"];//明细项目区取值
        var dateFiled = ["FStartDate", "FEndDate", "FMeetingTime"];
        var memoGridField = true;
        var memoType = "view";
        if (otype == $Otype.ADD) { //明细区默认显示项目预算明细
            activeTab = 0;
        }
        MemoStore = returnMemoArr(MemoStore, individualInfo);

        var YskmIfControl='1';//是否允许一级科目对应多个预算科目  默认为是

        Ext.onReady(function () {
            //审批流控件
            var wfinfojson = "";
            var workflowPanel;
            var wfinfo = Ext.htmlDecode('@ViewBag.WorkFlowInfo');
            var performTargetTypeLevel1 = "", performTargetTypeLevel2 = ""; //绩效目标分解类型级别1、2
            var orgProjectProjectThreshold = 0, orgProjectProjectType = '';; //项目阈值  项目类型
            var budgetDtlFName = "";
            //工具栏
            var snapshotDtl = new Ext.menu.Menu({
                shadow: "drop",
                allowOtherMenus: true,
                items: [
                ]
            });
            var storeDtlStage = Ext.create('Ext.ng.JsonStore', {
				autoLoad: false,
				//pageSize: 14,
				fields: [
                {
                    "name": "PhId",
                    "type": "string",
                    "mapping": "PhId"
                },
                {
                    "name": "Dm",
                    "type": "string",
                    "mapping": "Dm"
                },
                {
                    "name": "Mc",
                    "type": "string",
                    "mapping": "Mc"
                }
				],
				url: C_ROOT + 'GQT/QT/QtDtlStage/GetQtDtlStageList',
				
			});
            storeDtlStage.load(function(){
                for(var i=0;i<storeDtlStage.getCount();i++){
                    snapshotDtl.add(
                        new Ext.menu.Item({
                            text: storeDtlStage.getAt(i).get('Mc'),
                            value:storeDtlStage.getAt(i).get('Dm'),
                            handler: function (e) {
                                Ext.Ajax.request({
                                    params: { 'id': busid,'FDtlstage':e.value },
                                    url: C_ROOT + 'GXM/XM/ProjectMst/SaveSnapshot',
                                    async: false,
                                    success: function (response) {
                                        var resp = Ext.JSON.decode(response.responseText);
                                        if (resp.Status === "success") {
                                            Ext.MessageBox.alert('提示', '快照成功！');
                                        }else{
                                            Ext.MessageBox.alert('提示', resp.Msg);
                                        }
                                    }
                                });
                            }
                        })
                    );
                }
            });
            
            var ngToolbar = Ext.create('Ext.ng.Toolbar', {
                region: 'north',
                showArrowBtn: false,
                layout: {
                    overflowHandler: 'Menu'
                },
                ngbuttons: [
                    'save', { id: "saveAndnew", text: "保存并新增", width: this.itemWidth, iconCls: "icon-Confirm", langkey: "saveAndnew" }, 'attachment',
                    'addrow', { id: "copyRow", text: "复制", width: this.itemWidth, iconCls: "icon-AddRow", langkey: "copyRow" }, 'deleterow',
                    { id: "purchase", text: "集中采购", width: this.itemWidth, iconCls: "icon-Confirm", langkey: "purchase" },
                    { itemId: 'copy', iconCls: "icon-Cancel", text: "批量修改", width: this.itemWidth, langkey: "copy" },
                    { itemId: 'memo', iconCls: "icon-Setup", text: "批注", width: this.itemWidth, langkey: "memo" },
                    { itemId: 'memoRecord', iconCls: "icon-Setup", text: "批注记录", width: this.itemWidth, langkey: "memoRecord" },
                    { itemId: 'snapshot', iconCls: "icon-create", text: "生成快照", width: this.itemWidth, langkey: "snapshot",menu: snapshotDtl },
                    '->', 'print', { itemId: "closeTab", text: "关闭", width: this.itemWidth, iconCls: "icon-Close", langkey: "close" }
                ]
            });
            if (memoRight == "memoRight") { //批注进来的隐藏批注记录
                memoType = "add";
                ngToolbar.get('memoRecord').hide();
            }else{
                ngToolbar.get('memo').hide();
                memoGridField = false;
            }
            ngToolbar.get('addrow').hide();
            ngToolbar.get('deleterow').hide();
            ngToolbar.get('copy').hide();
            ngToolbar.get('purchase').hide();
            ngToolbar.get('copyRow').hide();
            
            ngToolbar.get('snapshot').hide();

            //工作流面板
            if (wfinfo != "" && !Ext.isEmpty(wfinfo)) {
                wfinfojson = Ext.decode(wfinfo);

                workflowPanel = Ext.create('Ext.panel.Panel', {
                    region: 'north',
                    border: 'fit',
                    items: [
                        {
                            xtype: 'ngWorkFlowPanel',
                            toolbar: ngToolbar, //单据toolbar
                            otype: otype, //单据otype
                            bizType: "GHProject", //注册的表单id（原商业对象）
                            bizPhid: busid, //单据phid
                            showToolBarItems: ['attachment', 'memoRecord','memo'], //任务办理时可见toolbar按钮itemid数组
                            workFlowInfo: wfinfojson,
                            bizSaveAsync: true,
                            bizSaveFn: function (callback) { //单据保存方法，方法需返回bool值，Ajax方法需使用同步模式
                                save(callback);
                            },
                            listeners: {
                                taskComplete: function (compId, wfParam) {
                                    //在这里进行自定义组件任务处理，并把工作流参数传到服务端，并在服务端调用工作流api

                                    debugger;
                                }
                            }
                        }
                    ]
                });
            }

            //定义mainPanel_form
            var mainPanel_formInitialConfig = {
                region: 'north',
                frame: true,
                split: true,
                minWidth: 600,
                buskey: 'PhId', //对应的业务表主键
                otype: otype //操作类型,add||edit
            };
            var mainPanel_formConfig = mainPanel_formInitialConfig;
            if (individualInfo.form) {
                Ext.apply(mainPanel_formConfig, individualInfo.form['mainPanel']);
            }
            var mainPanel_form = Ext.create('Ext.ng.TableLayoutForm', mainPanel_formConfig);

            //定义FunctionalOvervPanel_form
            var FunctionalOvervPanel_formInitialConfig = {
                region: 'north',
                frame: true,
                split: true,
                minWidth: 600,
                layout: 'fit',
                columnsPerRow: 1,
                fieldDefaults: {
                    anchor: "111%"
                },
                buskey: 'PhId', //对应的业务表主键
                otype: otype //操作类型,add||edit
            };
            var FunctionalOvervPanel_formConfig = FunctionalOvervPanel_formInitialConfig;
            if (individualInfo.form) {
                Ext.apply(FunctionalOvervPanel_formConfig, individualInfo.form['FunctionalOvervPanel']);
            }
            var FunctionalOvervPanel_form = Ext.create('Ext.ng.TableLayoutForm', FunctionalOvervPanel_formConfig);

            //定义ProjOverviewPanel_form
            var ProjOverviewPanel_formInitialConfig = {
                region: 'north',
                frame: true,
                split: true,
                minWidth: 600,
                layout: "fit",
                columnsPerRow: 1,
                fieldDefaults: {
                    anchor: "111%"
                },
                buskey: 'PhId', //对应的业务表主键
                otype: otype //操作类型,add||edit
            };
            var ProjOverviewPanel_formConfig = ProjOverviewPanel_formInitialConfig;
            if (individualInfo.form) {
                Ext.apply(ProjOverviewPanel_formConfig, individualInfo.form['ProjOverviewPanel']);
            }
            var ProjOverviewPanel_form = Ext.create('Ext.ng.TableLayoutForm', ProjOverviewPanel_formConfig);

            //定义projectStartInfoPanel_form
            var projectStartInfoPanel_formInitialConfig = {
                region: 'north',
                frame: true,
                split: true,
                minWidth: 600,
                fieldDefaults: {
                    anchor: "111%"
                },
                buskey: 'PhId', //对应的业务表主键
                otype: otype //操作类型,add||edit
            };
            var projectStartInfoPanel_formConfig = projectStartInfoPanel_formInitialConfig;
            if (individualInfo.fieldSetForm) {
                //Ext.apply(projectStartInfoPanel_formConfig, individualInfo.fieldSetForm['projectStartInfoPanel']);
                Ext.apply(projectStartInfoPanel_formConfig, individualInfo.form['projectStartInfoPanel']);
            }
            //var projectStartInfoPanel_form = Ext.create('Ext.ng.FieldSetForm', projectStartInfoPanel_formConfig);
            var projectStartInfoPanel_form = Ext.create('Ext.ng.TableLayoutForm', projectStartInfoPanel_formConfig);

            //获取BudgetDtlPanel_grid自带model
            var BudgetDtlPanel_modelFields = [
                {
                    "name": "PhId",
                    "type": "string",
                    "mapping": "PhId"
                },
                {
                    "name": "MstPhid",
                    "type": "string",
                    "mapping": "MstPhid"
                },
                {
                    "name": "FDtlCode",
                    "type": "string",
                    "mapping": "FDtlCode"
                },
                {
                    "name": "FName",
                    "type": "string",
                    "mapping": "FName"
                },
                {
                    "name": "FQty",
                    "type": "float",
                    "mapping": "FQty"
                },
                {
                    "name": "FQty2",
                    "type": "float",
                    "mapping": "FQty2"
                },
                {
                    "name": "FPrice",
                    "type": "float",
                    "mapping": "FPrice"
                },
                {
                    "name": "FAmount",
                    "type": "float",
                    "mapping": "FAmount"
                },
                {
                    "name": "FBudgetAmount",
                    "type": "float",
                    "mapping": "FBudgetAmount"
                },
                {
                    "name": "FSourceOfFunds",
                    "type": "string",
                    "mapping": "FSourceOfFunds"
                },
                {
                    "name": "FSourceOfFunds_EXName",
                    "type": "string",
                    "mapping": "FSourceOfFunds_EXName"
                },
                {
                    "name": "FBudgetAccounts",
                    "type": "string",
                    "mapping": "FBudgetAccounts"
                },
                {
                    "name": "FBudgetAccounts_EXName",
                    "type": "string",
                    "mapping": "FBudgetAccounts_EXName"
                },
                {
                    "name": "FQtZcgnfl",
                    "type": "string",
                    "mapping": "FQtZcgnfl"
                },
                {
                    "name": "FQtZcgnfl_EXName",
                    "type": "string",
                    "mapping": "FQtZcgnfl_EXName"
                },
                {
                    "name": "FExpensesChannel",
                    "type": "string",
                    "mapping": "FExpensesChannel"
                },
                {
                    "name": "FExpensesChannel_EXName",
                    "type": "string",
                    "mapping": "FExpensesChannel_EXName"
                },
                {
                    "name": "FPaymentMethod",
                    "type": "string",
                    "mapping": "FPaymentMethod"
                },
                {
                    "name": "FPaymentMethod_EXName",
                    "type": "string",
                    "mapping": "FPaymentMethod_EXName"
                },
                {
                    "name": "FOtherInstructions",
                    "type": "string",
                    "mapping": "FOtherInstructions"
                },

                {
                    "name": "FFeedback",
                    "type": "string",
                    "mapping": "FFeedback"
                },
                {
                    "name": "FIfPurchase",
                    "type": "int",
                    "mapping": "FIfPurchase"
                },
                {
                    "name": "FMidEdit",
                    "type": "string",
                    "mapping": "FMidEdit"
                },
                {
                    "name": "FNum",
                    "type": "float",
                    "mapping": "FNum"
                },
                {
                    "name": "FAmountEdit",
                    "type": "float",
                    "mapping": "FAmountEdit"
                },
                {
                    "name": "FAmountAfterEdit",
                    "type": "float",
                    "mapping": "FAmountAfterEdit"
                },
                {
                    "name": "FLastYearAmount",
                    "type": "float",
                    "mapping": "FLastYearAmount"
                }
            ]

            //调用$MergIndividualModelCol合并grid的Model
            var BudgetDtlPanel_allFields = $MergIndividualModelCol(BudgetDtlPanel_modelFields, individualInfo, 'BudgetDtlPanel');
            //定义模型
            Ext.define('BudgetDtlPanel_model', {
                extend: 'Ext.data.Model',
                fields: BudgetDtlPanel_allFields
            });
            //定义BudgetDtlPanel_store
            var BudgetDtlPanel_store = Ext.create('Ext.ng.JsonStore', {
                model: 'BudgetDtlPanel_model',
                sorters: [
                    {
                        property: "FDtlCode",
                        direction: "ASC"
                    }
                ],
                pageSize: 20
            });
            //定义BudgetDtlPanel_cellEditing
            var BudgetDtlPanel_cellEditing = Ext.create('Ext.grid.plugin.CellEditing', {
                clicksToEdit: 1    //单击编辑，单元格修改
            });
            //从自定义信息中获取到grid的配置
            var BudgetDtlPanel_indvidualGrid = individualInfo.grid['BudgetDtlPanel'];
            //动态内容的配置不能写在插件中
            var BudgetDtlPanel_gridInitialConfig = {
                stateful: true,
                region: 'center',
                stateId: '292ddc4c-7354-418e-9a81-326eb6811b4d', //这里请使用guid，防止冲突
                store: BudgetDtlPanel_store,
                otype: otype, //操作类型,add||edit
                plugins: [BudgetDtlPanel_cellEditing],
                selModel: Ext.create('Ext.selection.RowModel', { mode: "SIMPLE" }),
                features: [{
                    ftype: 'summary'
                }]
            }
            //动态配置与静态配置合并
            var BudgetDtlPanel_gridConfig = Ext.apply(BudgetDtlPanel_gridInitialConfig, BudgetDtlPanel_indvidualGrid);
            //定义BudgetDtlPanel_grid
            var BudgetDtlPanel_grid = Ext.create('Ext.ng.GridPanel', BudgetDtlPanel_gridConfig);

            //获取BudgetDtlPanel_grid2用作打印/10000
            var BudgetDtlPanel_modelFields2 = [
                {
                    "name": "PhId",
                    "type": "string",
                    "mapping": "PhId"
                },
                {
                    "name": "MstPhid",
                    "type": "string",
                    "mapping": "MstPhid"
                },
                {
                    "name": "FDtlCode",
                    "type": "string",
                    "mapping": "FDtlCode"
                },
                {
                    "name": "FName",
                    "type": "string",
                    "mapping": "FName"
                },
                {
                    "name": "FQty",
                    "type": "float",
                    "mapping": "FQty"
                },
                {
                    "name": "FQty2",
                    "type": "float",
                    "mapping": "FQty2"
                },
                {
                    "name": "FPrice",
                    "type": "float",
                    "mapping": "FPrice"
                },
                {
                    "name": "FAmount",
                    "type": "float",
                    "mapping": "FAmount"
                },
                {
                    "name": "FBudgetAmount",
                    "type": "float",
                    "mapping": "FBudgetAmount"
                },
                {
                    "name": "FSourceOfFunds",
                    "type": "string",
                    "mapping": "FSourceOfFunds"
                },
                {
                    "name": "FSourceOfFunds_EXName",
                    "type": "string",
                    "mapping": "FSourceOfFunds_EXName"
                },
                {
                    "name": "FBudgetAccounts",
                    "type": "string",
                    "mapping": "FBudgetAccounts"
                },
                {
                    "name": "FBudgetAccounts_EXName",
                    "type": "string",
                    "mapping": "FBudgetAccounts_EXName"
                },
                {
                    "name": "FQtZcgnfl",
                    "type": "string",
                    "mapping": "FQtZcgnfl"
                },
                {
                    "name": "FQtZcgnfl_EXName",
                    "type": "string",
                    "mapping": "FQtZcgnfl_EXName"
                },
                {
                    "name": "FExpensesChannel",
                    "type": "string",
                    "mapping": "FExpensesChannel"
                },
                {
                    "name": "FExpensesChannel_EXName",
                    "type": "string",
                    "mapping": "FExpensesChannel_EXName"
                },
                {
                    "name": "FPaymentMethod",
                    "type": "string",
                    "mapping": "FPaymentMethod"
                },
                {
                    "name": "FPaymentMethod_EXName",
                    "type": "string",
                    "mapping": "FPaymentMethod_EXName"
                },
                {
                    "name": "FOtherInstructions",
                    "type": "string",
                    "mapping": "FOtherInstructions"
                },

                {
                    "name": "FFeedback",
                    "type": "string",
                    "mapping": "FFeedback"
                },
                {
                    "name": "FIfPurchase",
                    "type": "int",
                    "mapping": "FIfPurchase"
                },
                {
                    "name": "FMidEdit",
                    "type": "string",
                    "mapping": "FMidEdit"
                },
                {
                    "name": "FNum",
                    "type": "float",
                    "mapping": "FNum"
                },
                {
                    "name": "FAmountEdit",
                    "type": "float",
                    "mapping": "FAmountEdit"
                },
                {
                    "name": "FAmountAfterEdit",
                    "type": "float",
                    "mapping": "FAmountAfterEdit"
                }
            ]

            //调用$MergIndividualModelCol合并grid的Model
            var BudgetDtlPanel_allFields2 = $MergIndividualModelCol(BudgetDtlPanel_modelFields2, individualInfo, 'BudgetDtlPanel');
            //定义模型
            Ext.define('BudgetDtlPanel_model2', {
                extend: 'Ext.data.Model',
                fields: BudgetDtlPanel_allFields2
            });
            //定义BudgetDtlPanel_store
            var BudgetDtlPanel_store2 = Ext.create('Ext.ng.JsonStore', {
                model: 'BudgetDtlPanel_model2',
                sorters: [
                    {
                        property: "FDtlCode",
                        direction: "ASC"
                    }
                ],
                pageSize: 20
            });
            //定义BudgetDtlPanel_cellEditing
            var BudgetDtlPanel_cellEditing2 = Ext.create('Ext.grid.plugin.CellEditing', {
                clicksToEdit: 1    //单击编辑，单元格修改
            });
            //从自定义信息中获取到grid的配置
            var BudgetDtlPanel_indvidualGrid2 = individualInfo.grid['BudgetDtlPanel'];
            //动态内容的配置不能写在插件中
            var BudgetDtlPanel_gridInitialConfig2 = {
                stateful: true,
                region: 'center',
                stateId: '292ddc4c-7354-418e-9a81-326eb6811b4d', //这里请使用guid，防止冲突
                store: BudgetDtlPanel_store2,
                otype: otype, //操作类型,add||edit
                plugins: [BudgetDtlPanel_cellEditing2],
                selModel: Ext.create('Ext.selection.RowModel', { mode: "SIMPLE" })
            }
            //动态配置与静态配置合并
            var BudgetDtlPanel_gridConfig2 = Ext.apply(BudgetDtlPanel_gridInitialConfig2, BudgetDtlPanel_indvidualGrid2);
            //定义BudgetDtlPanel_grid
            var BudgetDtlPanel_grid2 = Ext.create('Ext.ng.GridPanel', BudgetDtlPanel_gridConfig2);

            //获取FundApplPanel_grid自带model
            var FundApplPanel_modelFields = [
                {
                    "name": "PhId",
                    "type": "string",
                    "mapping": "PhId"
                },
                {
                    "name": "MstPhid",
                    "type": "string",
                    "mapping": "MstPhid"
                },
                {
                    "name": "FSourceOfFunds",
                    "type": "string",
                    "mapping": "FSourceOfFunds"
                },
                {
                    "name": "FSourceOfFunds_EXName",
                    "type": "string",
                    "mapping": "FSourceOfFunds_EXName"
                },
                {
                    "name": "FAmount",
                    "type": "float",
                    "mapping": "FAmount"
                }
            ]
            //调用$MergIndividualModelCol合并grid的Model
            var FundApplPanel_allFields = $MergIndividualModelCol(FundApplPanel_modelFields, individualInfo, 'FundApplPanel');
            //定义模型
            Ext.define('FundApplPanel_model', {
                extend: 'Ext.data.Model',
                fields: FundApplPanel_allFields
            });
            //定义FundApplPanel_store
            var FundApplPanel_store = Ext.create('Ext.ng.JsonStore', {
                model: 'FundApplPanel_model',
                pageSize: 20
            });
            //定义FundApplPanel_cellEditing
            var FundApplPanel_cellEditing = Ext.create('Ext.grid.plugin.CellEditing', {
                clicksToEdit: 1    //单击编辑，单元格修改
            });
            //从自定义信息中获取到grid的配置
            var FundApplPanel_indvidualGrid = individualInfo.grid['FundApplPanel'];
            //动态内容的配置不能写在插件中
            var FundApplPanel_gridInitialConfig = {
                stateful: true,
                region: 'center',
                stateId: '8801a567-f358-4c53-9502-df1b6a010489', //这里请使用guid，防止冲突
                store: FundApplPanel_store,
                otype: otype, //操作类型,add||edit
                plugins: [FundApplPanel_cellEditing]
            }
            //动态配置与静态配置合并
            var FundApplPanel_gridConfig = Ext.apply(FundApplPanel_gridInitialConfig, FundApplPanel_indvidualGrid);
            //定义FundApplPanel_grid
            var FundApplPanel_grid = Ext.create('Ext.ng.GridPanel', FundApplPanel_gridConfig);

            //获取ImplPlanPanel_grid自带model
            var ImplPlanPanel_modelFields = [
                {
                    "name": "PhId",
                    "type": "string",
                    "mapping": "PhId"
                },
                {
                    "name": "MstPhid",
                    "type": "string",
                    "mapping": "MstPhid"
                },
                {
                    "name": "FImplContent",
                    "type": "string",
                    "mapping": "FImplContent"
                },
                {
                    "name": "FStartDate",
                    "type": "datetime",
                    "mapping": "FStartDate"
                },
                {
                    "name": "FEndDate",
                    "type": "datetime",
                    "mapping": "FEndDate"
                }
            ]
            //调用$MergIndividualModelCol合并grid的Model
            var ImplPlanPanel_allFields = $MergIndividualModelCol(ImplPlanPanel_modelFields, individualInfo, 'ImplPlanPanel');
            //定义模型
            Ext.define('ImplPlanPanel_model', {
                extend: 'Ext.data.Model',
                fields: ImplPlanPanel_allFields
            });
            //定义ImplPlanPanel_store
            var ImplPlanPanel_store = Ext.create('Ext.ng.JsonStore', {
                model: 'ImplPlanPanel_model',
                pageSize: 20
            });
            //定义ImplPlanPanel_cellEditing
            var ImplPlanPanel_cellEditing = Ext.create('Ext.grid.plugin.CellEditing', {
                clicksToEdit: 1    //单击编辑，单元格修改
            });
            //从自定义信息中获取到grid的配置
            var ImplPlanPanel_indvidualGrid = individualInfo.grid['ImplPlanPanel'];
            //动态内容的配置不能写在插件中
            var ImplPlanPanel_gridInitialConfig = {
                stateful: true,
                region: 'center',
                stateId: '16835f03-7d2c-4464-abca-54eefa09eb42', //这里请使用guid，防止冲突
                store: ImplPlanPanel_store,
                otype: otype, //操作类型,add||edit
                //forceFit: false,
                //scrollOffset: 0,
                plugins: [ImplPlanPanel_cellEditing]
            }
            //动态配置与静态配置合并
            var ImplPlanPanel_gridConfig = Ext.apply(ImplPlanPanel_gridInitialConfig, ImplPlanPanel_indvidualGrid);
            //定义ImplPlanPanel_grid
            var ImplPlanPanel_grid = Ext.create('Ext.ng.GridPanel', ImplPlanPanel_gridConfig);

            //定义longTargetPanel_form
            var longTargetPanel_formInitialConfig = {
                region: 'north',
                frame: true,
                split: true,
                minWidth: 600,
                columnsPerRow: 1,
                fieldDefaults: {
                    anchor: "111%"
                },
                buskey: 'PhId', //对应的业务表主键
                otype: otype //操作类型,add||edit
            };
            var longTargetPanel_formConfig = longTargetPanel_formInitialConfig;
            if (individualInfo.form) {
                Ext.apply(longTargetPanel_formConfig, individualInfo.form['longTargetPanel']);
            }
            var longTargetPanel_form = Ext.create('Ext.ng.TableLayoutForm', longTargetPanel_formConfig);

            //定义yearTargetPanel_form
            var yearTargetPanel_formInitialConfig = {
                region: 'north',
                frame: true,
                split: true,
                minWidth: 600,
                columnsPerRow: 1,
                fieldDefaults: {
                    anchor: "111%"
                },
                buskey: 'PhId', //对应的业务表主键
                otype: otype //操作类型,add||edit
            };
            var yearTargetPanel_formConfig = yearTargetPanel_formInitialConfig;
            if (individualInfo.form) {
                Ext.apply(yearTargetPanel_formConfig, individualInfo.form['yearTargetPanel']);
            }
            var yearTargetPanel_form = Ext.create('Ext.ng.TableLayoutForm', yearTargetPanel_formConfig);

            //获取PerformTargetPanel_grid自带model
            var PerformTargetPanel_modelFields = [
                {
                    "name": "PhId",
                    "type": "string",
                    "mapping": "PhId"
                },
                {
                    "name": "MstPhid",
                    "type": "string",
                    "mapping": "MstPhid"
                },
                {
                    "name": "",
                    "type": "string",
                    "mapping": ""
                },
                {
                    "name": "FTargetTypeCode",
                    "type": "string",
                    "mapping": "FTargetTypeCode"
                },
                {
                    "name": "FTargetTypeCode_EXName",
                    "type": "string",
                    "mapping": "FTargetTypeCode_EXName"
                },
                {
                    "name": "FTargetClassCode",
                    "type": "string",
                    "mapping": "FTargetClassCode"
                },
                {
                    "name": "FTargetClassCode_EXName",
                    "type": "string",
                    "mapping": "FTargetClassCode_EXName"
                },
                {
                    "name": "FTargetCode",
                    "type": "string",
                    "mapping": "FTargetCode"
                },
                {
                    "name": "FTargetCode_EXName",
                    "type": "string",
                    "mapping": "FTargetCode_EXName"
                },
                {
                    "name": "FTargetName",
                    "type": "string",
                    "mapping": "FTargetName"
                },
                {
                    "name": "FTargetValue",
                    "type": "string",
                    "mapping": "FTargetValue"
                },
                {
                    "name": "FTargetWeight",
                    "type": "string",
                    "mapping": "FTargetWeight"
                },
                {
                    "name": "FTargetDescribe",
                    "type": "string",
                    "mapping": "FTargetDescribe"
                },
                {
                    "name": "FIfCustom",
                    "type": "int",
                    "mapping": "FIfCustom"
                },
                {
                    "name": "NgRecordVer",
                    "type": "int",
                    "mapping": "NgRecordVer"
                }
            ]
            //调用$MergIndividualModelCol合并grid的Model
            var PerformTargetPanel_allFields = $MergIndividualModelCol(PerformTargetPanel_modelFields, individualInfo, 'PerformTargetPanel');
            //定义模型
            Ext.define('PerformTargetPanel_model', {
                extend: 'Ext.data.Model',
                fields: PerformTargetPanel_allFields
            });
            //定义PerformTargetPanel_store
            var PerformTargetPanel_store = Ext.create('Ext.ng.JsonStore', {
                sorters: [
                    { property: 'FTargetTypeCode', direction: 'asc' },
                    { property: 'FTargetClassCode', direction: 'asc' },
                    { property: 'FTargetCode', direction: 'asc' }
                ],
                model: 'PerformTargetPanel_model',
                pageSize: 20
            });
            //定义PerformTargetPanel_cellEditing
            var PerformTargetPanel_cellEditing = Ext.create('Ext.grid.plugin.CellEditing', {
                clicksToEdit: 1    //单击编辑，单元格修改
            });
            //从自定义信息中获取到grid的配置
            var PerformTargetPanel_indvidualGrid = individualInfo.grid['PerformTargetPanel'];
            //动态内容的配置不能写在插件中
            var PerformTargetPanel_gridInitialConfig = {
                stateful: true,
                region: 'center',
                stateId: '6708af1f-cb94-46f9-87c4-d1f23d066bf6', //这里请使用guid，防止冲突
                store: PerformTargetPanel_store,
                otype: otype, //操作类型,add||edit
                plugins: [PerformTargetPanel_cellEditing]
            }
            //动态配置与静态配置合并
            var PerformTargetPanel_gridConfig = Ext.apply(PerformTargetPanel_gridInitialConfig, PerformTargetPanel_indvidualGrid);
            //定义PerformTargetPanel_grid
            var PerformTargetPanel_grid = Ext.create('Ext.ng.GridPanel', PerformTargetPanel_gridConfig);
            //缓存数据，在合并单元格后删除，需要用原始数据来加载
            var PerformTargetPanel_CacheData;

            var tabItems = {
                TabPage1: {
                    id: 'TabPage1',
                    layout: 'border',
                    hidden:true,
                    title: '部门职能概述',
                    items: [FunctionalOvervPanel_form]
                },
                TabPage2: {
                    id: 'TabPage2',
                    layout: 'border',
                    title: '项目概况',
                    items: [ProjOverviewPanel_form]
                },
                TabPage3: {
                    id: 'TabPage3',
                    layout: 'border',
                    title: '项目立项情况',
                    items: [projectStartInfoPanel_form]
                },
                TabPage4: {
                    id: 'TabPage4',
                    layout: 'border',
                    title: '项目预算明细',
                    items: [BudgetDtlPanel_grid]
                },
                TabPage5: {
                    id: 'TabPage5',
                    layout: 'border',
                    title: '项目资金申请',
                    items: [FundApplPanel_grid]
                },
                TabPage6: {
                    id: 'TabPage6',
                    layout: 'border',
                    title: '实施计划',
                    items: [ImplPlanPanel_grid]
                },
                TabPage7: {
                    id: 'TabPage7',
                    layout: 'border',
                    title: '总体绩效目标',
                    items: [longTargetPanel_form]
                },
                TabPage9: {
                    id: 'TabPage9',
                    layout: 'border',
                    title: '绩效目标分解',
                    items: [PerformTargetPanel_grid]
                }
                ,
                TabPage8:{
                    id: 'TabPage8',
                    layout: 'border',
                    hidden: true,
                    title: '年度绩效目标',
                    items: [yearTargetPanel_form]
                }
            }

            var tabArr = [];
            var indTabItems = individualInfo.tabPanel['DtlPanel'].items;
            for (var i = 0; i < indTabItems.length; i++) {
                var tab = indTabItems[i];
                if (!tab.hidden) {
                    tabArr.push(Ext.apply(tabItems[tab.id], tab));
                }
            }

            var tabPanel = Ext.create('Ext.tab.Panel', {
                layout: 'border',
                region: 'center',
                deferredRender: false,
                plain: true,
                activeTab: activeTab,
                minHeight: 200,
                minWidth: 600,
                defaults: { bodyStyle: 'padding:3px' },
                items: tabArr
            });


            var myViewport = Ext.create('Ext.container.Viewport', {
                id: "viewPort",
                layout: 'border',
                items:
                    [
                        ngToolbar,
                        {
                            xtype: 'panel',
                            layout: 'border',
                            region: 'center',
                            autoScroll: true,
                            bodyStyle: 'padding-right:20px',
                            //style: 'overflow-y:scroll,padding-right:20px',
                            items: [mainPanel_form, tabPanel]
                        }
                    ]
            });

            //是否允许一级科目对应多个预算科目及支出渠道
            Ext.Ajax.request({
                params: { 'BZ': "G6HBLKZYskm" },
                url: C_ROOT + 'GQT/QT/QTControlSet/GetAllQTControlByBZ',
                async: false,
                success: function (response) {
                    var resp = Ext.JSON.decode(response.responseText);
                    if(resp.Data.length>0 && resp.Data[0].ControlOrNot=='2'){
                        YskmIfControl='2';
                    }else{

                    }
                }
            });

            BudgetDtlPanel_grid.getColumn('FQty').hide();
            BudgetDtlPanel_grid.getColumn('FQty2').hide();
            BudgetDtlPanel_grid.getColumn('FPrice').hide();
            BudgetDtlPanel_grid.getColumn('FNum').hide();

            //当修改、查看时取数、绑定
            if (otype == $Otype.EDIT || otype == $Otype.VIEW) {
                Ext.Ajax.request({
                    params: { 'id': busid, 'tabtype': 'projectmst' },
                    url: C_ROOT + 'GXM/XM/ProjectMst/GetProjectMstInfo',
                    success: function (response) {
                        var resp = Ext.JSON.decode(response.responseText);
                        if (resp.Status === "success") {
                            var mstformobj = mainPanel_form.getForm();
                            mstformobj.setValues(resp.Data);
                            if(resp.Data.FReference=='1'){
                                BudgetDtlPanel_grid.getColumn('FAmount')&&BudgetDtlPanel_grid.getColumn('FAmount').setText('本年申报金额');
                                BudgetDtlPanel_grid.getColumn('FLastYearAmount').show();
                            }else{
                                BudgetDtlPanel_grid.getColumn('FLastYearAmount').hide();
                            }
                            //ProjStatus = resp.Data.FProjStatus;
                            /*if (resp.Data.FProjStatus == "1") {
                                BudgetDtlPanel_grid.getColumn('FBudgetAccounts_EXName').hide();
                                BudgetDtlPanel_grid.getColumn('FExpensesChannel_EXName').hide();
                            } else {
                                BudgetDtlPanel_grid.getColumn('FBudgetAccounts_EXName').show();
                                BudgetDtlPanel_grid.getColumn('FExpensesChannel_EXName').show();
                                BudgetDtlPanel_grid.setMustInputCol("FBudgetAccounts_EXName", true);
                                BudgetDtlPanel_grid.setMustInputCol("FExpensesChannel_EXName", true);
                            }*/

                            //mstformobj绑定完成触发dataready，供二次开发调用（比如代码转名称）；
                            mstformobj.fireEvent('dataready', resp.Data);

                            //代码转名称
                            var codectl = [
                                mainPanel_form.queryById('FDeclarationUnit'),
                                mainPanel_form.queryById('FBudgetDept'),
                                mainPanel_form.queryById('FExpenseCategory'),
                                mainPanel_form.queryById('FPerformType'),
                                mainPanel_form.queryById('FPerformEvalType'),
                                mainPanel_form.queryById('FVenue')
                            ]; //mainPanel_form.queryById('FIfPerformanceAppraisal')
                            BatchBindCombox(codectl);

                            hidePerformTargetTab(false, false); //处理绩效目标分解tab

                            activeTabpage("TabPage4"); //默认展示TabPage4
                            var orgcode = mainPanel_form.queryById("FDeclarationUnit").getValue();
                            getProjectThreshold(orgcode, mainPanel_form.queryById("FExpenseCategory").getValue()); //获取阈值

                            //是否显示天数、人数、单价
                            var unitCode = mainPanel_form.queryById("FDeclarationUnit").getValue();
                            var xmCOde = mainPanel_form.queryById("FExpenseCategory").getValue();
                            //debugger;
                            Ext.Ajax.request({
                                params: { "Dylx": '08', "DefStr1": unitCode },
                                url: C_ROOT + 'GQT/QT/CorrespondenceSettings2/GetCorrespondenceSettings2ListbyRelation',
                                success: function (response) {
                                    var resp = Ext.JSON.decode(response.responseText);
                                    if (resp != null && resp != undefined) {
                                        for (var i = 0; i < resp.Record.length; i++) {
                                            var recordData = resp.Record[i];
                                            if (recordData.Dydm == xmCOde) {
                                                tempData = recordData;
                                                if (recordData.DefStr2 == "0") {
                                                    BudgetDtlPanel_grid.getColumn('FQty').hide();
                                                    BudgetDtlPanel_grid.getColumn('FQty2').hide();
                                                    BudgetDtlPanel_grid.getColumn('FPrice').hide();
                                                    BudgetDtlPanel_grid.getColumn('FNum').hide();
                                                    BudgetDtlPanel_grid.getColumn('FAmount').readOnly = false;
                                                    if (!workflowPanel&&otype == $Otype.VIEW) {

                                                        BudgetDtlPanel_grid.getColumn('FAmount').readOnly = true;
                                                    }

                                                }
                                                if (recordData.DefStr2 == "1") {
                                                    BudgetDtlPanel_grid.getColumn('FQty').show();
                                                    BudgetDtlPanel_grid.getColumn('FQty2').show();
                                                    BudgetDtlPanel_grid.getColumn('FPrice').show();
                                                    BudgetDtlPanel_grid.getColumn('FNum').hide();
                                                    //BudgetDtlPanel_grid.getColumn('FPrice').readOnly = true;
                                                    //BudgetDtlPanel_grid.getColumn('FAmount').readOnly = true;
                                                    BudgetDtlPanel_grid.getColumn('FPrice').readOnly = false;
                                                    BudgetDtlPanel_grid.getColumn('FQty').readOnly = false;
                                                    BudgetDtlPanel_grid.getColumn('FQty2').readOnly = false;
													MemoStore.push(["FQty", "天数(明细表)"]);
													MemoStore.push(["FQty2", "人数(明细表)"]);
                                                    MemoStore.push(["FPrice", "单价(明细表)"]);
                                                    if (otype == $Otype.VIEW) {
                                                        BudgetDtlPanel_grid.getColumn('FPrice').readOnly = true;
                                                        BudgetDtlPanel_grid.getColumn('FQty').readOnly = true;
                                                        BudgetDtlPanel_grid.getColumn('FQty2').readOnly = true;
                                                    }else{
                                                        Ext.Ajax.request({
                                                            params: { 'BZ': "G6HBLKZPrice" ,'OrgCode':unitCode},
                                                            url: C_ROOT + 'GQT/QT/QTControlSet/GetQTControlByBZAndOrg',
                                                            async: false,
                                                            success: function (response) {
                                                                var resp = Ext.JSON.decode(response.responseText);
                                                                if (resp.Status === "success") {
                                                                    var QTControlSet = resp.Msg;
                                                                    if (QTControlSet == "true") {

                                                                    } else {
                                                                        BudgetDtlPanel_grid.getColumn('FPrice').readOnly = true;
                                                                    }

                                                                }
                                                            }
                                                        });
                                                    }
                                                }
                                                if (recordData.DefStr2 == "2") {
                                                    BudgetDtlPanel_grid.getColumn('FQty').hide();
                                                    BudgetDtlPanel_grid.getColumn('FQty2').hide();
                                                    BudgetDtlPanel_grid.getColumn('FPrice').show();
                                                    BudgetDtlPanel_grid.getColumn('FNum').show();
                                                    BudgetDtlPanel_grid.getColumn('FPrice').readOnly = false;
                                                    BudgetDtlPanel_grid.getColumn('FAmount').readOnly = true;
                                                    BudgetDtlPanel_grid.getColumn('FNum').readOnly = false;
													MemoStore.push(["FNum", "数量(明细表)"]);
                                                    MemoStore.push(["FPrice", "单价(明细表)"]);
                                                    if (otype == $Otype.VIEW) {
                                                        BudgetDtlPanel_grid.getColumn('FPrice').readOnly = true;
                                                        BudgetDtlPanel_grid.getColumn('FNum').readOnly = true;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            });

                            /*var FProjAttrvalue=mainPanel_form.queryById("FProjAttr").getValue();
                            if(FProjAttrvalue=="1"){
                                mainPanel_form.queryById("FGoYear")&&mainPanel_form.queryById("FGoYear").show();
                            }else{
                                mainPanel_form.queryById("FGoYear")&&mainPanel_form.queryById("FGoYear").hide();
                            }*/
                            //2019.11.29 改成 存续期限关联执行年度
                            var FDurationvalue=mainPanel_form.queryById("FDuration").getValue();
                            if(FDurationvalue=="1"||FDurationvalue=="2"){
                                mainPanel_form.queryById("FGoYear")&&mainPanel_form.queryById("FGoYear").hide();
                            }else{
                                mainPanel_form.queryById("FGoYear")&&mainPanel_form.queryById("FGoYear").show();
                            }
                            //支出预算分类改为跟着表单自定义设置走（当模板自动切换时）
                            if (otype == $Otype.EDIT && IndividualinfoId!=''){
                                Ext.Ajax.request({
                                    params: { 'id': IndividualinfoId },
                                    url: C_ROOT + 'GQT/QT/QTIndividualInfo/GetQTIndividualInfoInfo',
                                    async: false,
                                    success: function (response) {
                                        var resp = Ext.JSON.decode(response.responseText);
                                        if (resp.Status === "success") {
                                            mainPanel_form.queryById("FZcType")&&mainPanel_form.queryById("FZcType").setValue(resp .Data.DEFSTR4);
                                        }
                                    }
                                });
                            }
                        } else {
                            Ext.MessageBox.alert('取数失败', resp.Msg);
                        }
                    }
                });

                //FunctionalOvervPanel: 通过 projectdtltextcontent 获取
                Ext.Ajax.request({
                    params: { 'id': busid, 'tabtype': 'projectdtltextcontent' },
                    url: C_ROOT + 'GXM/XM/ProjectMst/GetProjectMstInfo',
                    success: function (response) {
                        var resp = Ext.JSON.decode(response.responseText);
                        if (resp.Status === "success") {
                            var mstformobj = FunctionalOvervPanel_form.getForm(); //mainPanel_form.getForm();
                            mstformobj.setValues(resp.Data);

                            var projfromObj = ProjOverviewPanel_form.getForm();
                            projfromObj.setValues(resp.Data);

                            var startfromObj = projectStartInfoPanel_form.getForm();
                            startfromObj.setValues(resp.Data);

                            var longformObj = longTargetPanel_form.getForm();
                            longformObj.setValues(resp.Data);

                            var yearformObj = yearTargetPanel_form.getForm();
                            yearformObj.setValues(resp.Data);

                            //mstformobj绑定完成触发dataready，供二次开发调用（比如代码转名称）；
                            mstformobj.fireEvent('dataready', resp.Data);

                            ////代码转名称
                            //var codectl = [];
                            //BatchBindCombox(codectl);

                        } else {
                            Ext.MessageBox.alert('取数失败', resp.Msg);
                        }
                    }
                });

                //BudgetDtlPanel明细
                Ext.apply(BudgetDtlPanel_store.proxy.url = C_ROOT + 'GXM/XM/ProjectMst/GetProjectMstInfo');
                Ext.apply(BudgetDtlPanel_store.proxy.extraParams, { 'id': busid, 'tabtype': 'ProjectDtlBudgetDtl'.toLowerCase() });
                BudgetDtlPanel_store.cachePageData = false;
                BudgetDtlPanel_store.load();
                BudgetDtlPanel_store.sort();
                BudgetDtlPanel_store.cachePageData = true;

                //FundApplPanel明细
                Ext.apply(FundApplPanel_store.proxy.url = C_ROOT + 'GXM/XM/ProjectMst/GetProjectMstInfo');
                Ext.apply(FundApplPanel_store.proxy.extraParams, { 'id': busid, 'tabtype': 'ProjectDtlFundAppl'.toLowerCase() });
                FundApplPanel_store.cachePageData = false;
                FundApplPanel_store.load();
                FundApplPanel_store.cachePageData = true;

                //ImplPlanPanel明细
                Ext.apply(ImplPlanPanel_store.proxy.url = C_ROOT + 'GXM/XM/ProjectMst/GetProjectMstInfo');
                Ext.apply(ImplPlanPanel_store.proxy.extraParams, { 'id': busid, 'tabtype': 'ProjectDtlImplPlan'.toLowerCase() });
                ImplPlanPanel_store.cachePageData = false;
                ImplPlanPanel_store.load();
                ImplPlanPanel_store.cachePageData = true;

                //PerformTargetPanel明细
                Ext.apply(PerformTargetPanel_store.proxy.url = C_ROOT + 'GXM/XM/ProjectMst/GetProjectMstInfo');
                Ext.apply(PerformTargetPanel_store.proxy.extraParams, { 'id': busid, 'tabtype': 'projectdtlperformtarget' });
                PerformTargetPanel_store.cachePageData = false;
                PerformTargetPanel_store.load({
                    callback: function (records, operation, success) {
                        //合并单元格
                        ExMergeGrid(PerformTargetPanel_grid, [0, 1], false); // 最后一个参数为false逐个列合并
                    }
                });
                PerformTargetPanel_store.cachePageData = true;
            }

            //当新增时
            if (otype == $Otype.ADD) {
                //if (busno != undefined && busno != "") {
                //    Ext.getCmp("No").userSetReadOnly(true);
                //    Ext.getCmp("No").setValue(busno);
                //}
                if (ProjStatus != "2") {//预立项被隐藏时项目立项可以新增
                    mainPanel_form.queryById("FProjStatus")&&mainPanel_form.queryById("FProjStatus").setValue(1); //单位备选
                } else {
                    //BudgetDtlPanel_grid.setMustInputCol("FBudgetAccounts_EXName", true);
                    //BudgetDtlPanel_grid.setMustInputCol("FExpensesChannel_EXName", true);
                    mainPanel_form.queryById("FProjStatus")&&mainPanel_form.queryById("FProjStatus").setValue(2);
                }
                mainPanel_form.queryById("FApproveStatus")&&mainPanel_form.queryById("FApproveStatus").setValue(1); //未上报
                var date = new Date();

                mainPanel_form.queryById("FDateofDeclaration")&&mainPanel_form.queryById("FDateofDeclaration").setValue(date);
                var y = date.getFullYear();
                var startdate = y + '-01-01';
                var enddate = y + '-12-31';
                //mainPanel_form.queryById("FStartDate").setValue(startdate);
                //mainPanel_form.queryById("FEndDate").setValue(enddate);

                mainPanel_form.queryById("FIfPerformanceAppraisal")&&mainPanel_form.queryById("FIfPerformanceAppraisal").setValue(2);
                //mainPanel_form.queryById("FIfPerformanceAppraisal").setValue(1); //广州工会 默认改为是
                mainPanel_form.queryById("FIfKeyEvaluation")&&mainPanel_form.queryById("FIfKeyEvaluation").setValue(2);
                mainPanel_form.queryById("FDeclarer")&&mainPanel_form.queryById("FDeclarer").setValue($appinfo.username);
                mainPanel_form.queryById("FIfPurchase")&&mainPanel_form.queryById("FIfPurchase").setValue(2);

                //mainPanel_form.queryById("FIndividualinfophid").setValue(IndividualinfoId);
                //  mainPanel_form.queryById("FDeclarationUnit").setValue($appinfo.ocode);
                // mainPanel_form.queryById("FBudgetDept").setValue($appinfo.ocode);
                var orgCode = "";
                var dept = "";
                Ext.Ajax.request({
                    params: { 'userID': $user.id },
                    url: C_ROOT + 'GQT/QT/CorrespondenceSettings/FindFDeclarationUnit',
                    async: false,
                    success: function (response) {
                        var resp = Ext.JSON.decode(response.responseText);
                        if (resp.Status === "success") {
                            var orgDept = resp.Msg;
                            var orgDeptArray = orgDept.split(",");
                            orgCode = orgDeptArray[0];
                            dept = orgDeptArray[1];
                        }
                    }
                });
                mainPanel_form.queryById("FDeclarationUnit")&&mainPanel_form.queryById("FDeclarationUnit").setValue(orgCode);
                mainPanel_form.queryById("FBudgetDept")&&mainPanel_form.queryById("FBudgetDept").setValue(dept);
                mainPanel_form.queryById("FDeclarationDept")&&mainPanel_form.queryById("FDeclarationDept").setValue(dept); //申报部门即为默认部门
                if (orgCode) {
                    var filter2 = "(Z_QTDYGX2.DEF_STR1='" + orgCode + "')";
                    mainPanel_form.queryById("FExpenseCategory")&&mainPanel_form.queryById("FExpenseCategory").setClientSqlFilter(filter2);
                    var filter3="(z_qtvenue.orgcode='" + orgCode + "')";
                    mainPanel_form.queryById("FVenue")&&mainPanel_form.queryById("FVenue").setClientSqlFilter(filter3);
                }

                
                //支出类别默认为项目支出
                // mainPanel_form.queryById("FZcType").setValue("1");
                //支出预算分类改为跟着表单自定义设置走
                if (IndividualinfoId != '') {
                    Ext.Ajax.request({
                        params: { 'id': IndividualinfoId },
                        url: C_ROOT + 'GQT/QT/QTIndividualInfo/GetQTIndividualInfoInfo',
                        async: false,
                        success: function (response) {
                            var resp = Ext.JSON.decode(response.responseText);
                            if (resp.Status === "success") {
                                mainPanel_form.queryById("FZcType")&&mainPanel_form.queryById("FZcType").setValue(resp.Data.DEFSTR4);
                            }
                        }
                    });
                }
                    //临时项目默认为否
                    mainPanel_form.queryById("FTemporary")&&mainPanel_form.queryById("FTemporary").setValue(2);

                //根据进度控制设置项目年度(10.28北京改成不控制直接取右上角选择的年度)
                mainPanel_form.queryById("FYear")&&mainPanel_form.queryById("FYear").setValue(dataYear);
                Ext.Ajax.request({
                    params: { 'oCode': orgCode, 'deptCode': dept, 'FYear': dataYear },
                    url: C_ROOT + 'GYS/YS/BudgetMst/FindBudgetProcessCtrl',
                    async: false,
                    success: function (response) {
                        var resp = Ext.JSON.decode(response.responseText);
                        if (resp.Status === "success") {
                            var FProcessStatus = resp.Msg;//预算申报进度
                            if(FProcessStatus=='1'){
                                //mainPanel_form.queryById("FYear").setValue(dataYear-1+2);
                            }else if (FProcessStatus=='3'){
                                //mainPanel_form.queryById("FYear").setValue(dataYear);
                            }else{

                                    //是否允许专项预算录入，如果返回TRUE，临时项目置为是
                                    Ext.Ajax.request({
                                        params: { 'BZ': "G6HBLKZSpecialBudget" },
                                        url: C_ROOT + 'GQT/QT/QTControlSet/GetQTControlByBZ',
                                        async: false,
                                        success: function (response) {
                                            var resp = Ext.JSON.decode(response.responseText);
                                            if (resp.Status === "success") {
                                                var QTControlSet = resp.Msg;
                                                if (QTControlSet == "true") {
                                                    mainPanel_form.queryById("FTemporary")&&mainPanel_form.queryById("FTemporary").setValue(1);//临时项目置为是
                                                    //mainPanel_form.queryById("FYear").setValue(dataYear);//专项预算年度取当年
                                                } else {

                                                }

                                            }
                                        }
                                    });
                            }

                        }
                    }
                });

                
                            
                BudgetDtlPanel_grid.getColumn('FLastYearAmount')&&BudgetDtlPanel_grid.getColumn('FLastYearAmount').hide();
                            
                //代码转名称
                var codectl = [mainPanel_form.queryById('FDeclarationUnit'), mainPanel_form.queryById('FBudgetDept')]; //
                BatchBindCombox(codectl);

                if (otype == $Otype.ADD) {
                    var cbbudgetdtldata = BudgetDtlPanel_grid.getSelectionModel();
                    BudgetDtlPanel_store.insert(BudgetDtlPanel_store.getCount(), cbbudgetdtldata);
                    BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FIfPurchase', 2); //暂时改为1,应为2
                    var cbbudgetdtldata = ImplPlanPanel_grid.getSelectionModel();
                    ImplPlanPanel_store.insert(ImplPlanPanel_store.getCount(), cbbudgetdtldata);

                }

                hidePerformTargetTab(true, false);
                //hidePerformTargetTab(false, false);  //广州工会 绩效评价默认改为是,则默认显示tab   hidePerformTargetTab(true, false)
                activeTabpage("TabPage2"); //默认展示TabPage2

                mainPanel_form.queryById("FGoYear")&& mainPanel_form.queryById("FGoYear").hide();//新增时隐藏执行年度
            }

            if (workflowPanel) {
                SyncWorkFlowUI(wfinfojson);
                ngToolbar.get('saveAndnew').hide();
                //插入审批流控件
                myViewport.insert(1, workflowPanel);

                if (ProjStatus == "2") {
                    //BudgetDtlPanel_grid.setMustInputCol("FBudgetAccounts_EXName", true);
                    //BudgetDtlPanel_grid.setMustInputCol("FExpensesChannel_EXName", true);
                }
            }

            //当修改时
            if (otype == $Otype.EDIT) {
                //mainPanel_form.queryById("FIndividualinfophid").setValue(IndividualinfoId);
            }

            //当查看时
            if (otype == $Otype.VIEW) {
                ngToolbar.get('save').disable();

                ngToolbar.get('saveAndnew').hide();
                BudgetDtlPanel_grid.setReadOnlyCol("FPrice", true);
                BudgetDtlPanel_grid.setReadOnlyCol("FNum", true);

                
                ngToolbar.get('snapshot').show();
            }


            //保存
            ngToolbar.get('save').on('click', function () {
                ngToolbar.get('save').disable();
                save();
                ngToolbar.get('save').setDisabled(false);
            });

            //保存并新增
            ngToolbar.get('saveAndnew').on('click', function () {
                ngToolbar.get('save').disable();
                var res = save('notclose');
                ngToolbar.get('save').setDisabled(false);

            });
            //关闭
            ngToolbar.get('closeTab').on('click', function () {
                if (changeIndividualinfoId == "1") {
                    Ext.MessageBox.alert('提示', "请先保存!");
                    return;
                }
                $CloseTab();
            });

            //附件
            ngToolbar.get('attachment').on('click', function () {
                OpenAttachment();
            });

            //打印
            ngToolbar.get('print').on('click', function () {
                for (var a = 0; a < BudgetDtlPanel_store.getCount(); a++) {
                    BudgetDtlPanel_store2.add(BudgetDtlPanel_store.getAt(a).data);

                }

                for (var i = 0; i < BudgetDtlPanel_store2.getCount(); i++) {
                    var FAmount = parseFloat(BudgetDtlPanel_store2.getAt(i).get('FAmount'));
                    BudgetDtlPanel_store2.getAt(i).set('FAmount', (FAmount / 10000).toFixed(2));
                }


				/*var FAmountList=[];

				for(var i=0;i<BudgetDtlPanel_store.getCount();i++){
					FAmountList.push(BudgetDtlPanel_store.getAt(i).get('FAmount'));
					var FAmount=parseFloat(BudgetDtlPanel_store.getAt(i).get('FAmount'));
					BudgetDtlPanel_store.getAt(i).set('FAmount', (FAmount/10000).toFixed(2));
				}*/
                var forms = [mainPanel_form, FunctionalOvervPanel_form, ProjOverviewPanel_form, projectStartInfoPanel_form, longTargetPanel_form, yearTargetPanel_form];
                var grids = [BudgetDtlPanel_grid2, FundApplPanel_grid, ImplPlanPanel_grid, PerformTargetPanel_grid];


                if (ProjStatus == "1") {
                    var titles = ['预立项申报表', '部门职能描述', '项目概况', '项目立项情况', '长期绩效目标', '年度绩效目标', '项目预算明细', '项目资金申请', '实施计划', '绩效目标分解'];
                    //$PrintForm("ProjectMstEdit", forms, grids, titles);
                    $PrintHelp("BPM_GHProjectInfo", 'BPM_GHProjectInfo', forms, grids, titles);

                } else if (ProjStatus == "2") {
                    var titles = ['项目立项申报表', '部门职能描述', '项目概况', '项目立项情况', '长期绩效目标', '年度绩效目标', '项目预算明细', '项目资金申请', '实施计划', '绩效目标分解'];
                    $PrintHelp("BPM_GHBudgetInfo", 'BPM_GHBudgetInfo', forms, grids, titles);
                }

                /*var forms = [mainPanel_form, FunctionalOvervPanel_form, ProjOverviewPanel_form, projectStartInfoPanel_form, longTargetPanel_form, yearTargetPanel_form];
                var grids = [BudgetDtlPanel_grid, FundApplPanel_grid, ImplPlanPanel_grid, PerformTargetPanel_grid];

                if (ProjStatus == "1") {
                    var titles = ['预立项申报表', '部门职能描述', '项目概况', '项目立项情况', '长期绩效目标', '年度绩效目标', '项目预算明细', '项目资金申请', '实施计划', '绩效目标分解'];
                    //$PrintForm("ProjectMstEdit", forms, grids, titles);
                    $PrintHelp("BPM_GHProjectInfo", 'BPM_GHProjectInfo', forms, grids, titles)
                } else if (ProjStatus == "2") {
                    var titles = ['项目立项申报表', '部门职能描述', '项目概况', '项目立项情况', '长期绩效目标', '年度绩效目标', '项目预算明细', '项目资金申请', '实施计划', '绩效目标分解'];
                    $PrintHelp("BPM_GHBudgetInfo", 'BPM_GHBudgetInfo', forms, grids, titles)
                }*/

            });

            //调用二次开发脚本
            if (typeof AllReady === "function") {
                AllReady();
            }
            //处理toolbar折叠，请在AllReady之后调用，
            //确保实施挂载的toolbar事件在折叠下拉中也有效果
            ngToolbar.dealOverFlowMenu();

            //////集中采购
            var otypePurchase = "";
            otypePurchase = otype;
            if (workflowPanel) {
                otypePurchase = "edit";
            }
            //定义PurchaseDtlPanel_form
            var PurchaseDtlPanel_formInitialConfig = {
                region: 'north',
                frame: true,
                //split: true,
                border: true,// collapsible: true,
                //  minWidth: 600,
                buskey: 'PhId', //对应的业务表主键
                otype: otypePurchase //操作类型,add||edit
            };
            var PurchaseDtlPanel_formConfig = PurchaseDtlPanel_formInitialConfig;
            if (individualInfo.form) {
                Ext.apply(PurchaseDtlPanel_formConfig, individualInfo.form['PurchaseDtlPanel']);
            }
            var PurchaseDtlPanel_form = Ext.create('Ext.ng.TableLayoutForm', PurchaseDtlPanel_formConfig);

            //获取PurDtl4SOFGrid_grid自带model
            var PurDtl4SOFGrid_modelFields = [
                {
                    "name": "FSourceOfFunds",
                    "type": "string",
                    "mapping": "FSourceOfFunds"
                },
                {
                    "name": "FSourceOfFunds_EXName",
                    "type": "string",
                    "mapping": "FSourceOfFunds_EXName"
                },
                {
                    "name": "FAmount",
                    "type": "float",
                    "mapping": "FAmount"
                },
                {
                    "name": "MstPhid",
                    "type": "string",
                    "mapping": "MstPhid"
                },
                {
                    "name": "FDtlCode",
                    "type": "string",
                    "mapping": "FDtlCode"
                },
                {
                    "name": "PhId",
                    "type": "string",
                    "mapping": "PhId"
                },
                {
                    "name": "NgRecordVer",
                    "type": "int",
                    "mapping": "NgRecordVer"
                },
                {
                    "name": "FName",
                    "type": "string",
                    "mapping": "FName"
                },
                {
                    "name": "key",
                    "type": "string",
                    "mapping": "key"
                }
            ]
            //调用$MergIndividualModelCol合并grid的Model
            var PurDtl4SOFGrid_allFields = $MergIndividualModelCol(PurDtl4SOFGrid_modelFields, individualInfo, 'PurDtl4SOFGrid');
            //定义模型
            Ext.define('PurDtl4SOFGrid_model', {
                extend: 'Ext.data.Model',
                fields: PurDtl4SOFGrid_allFields
            });
            //定义PurDtl4SOFGrid_store
            var PurDtl4SOFGrid_store = Ext.create('Ext.ng.JsonStore', {
                model: 'PurDtl4SOFGrid_model',
                pageSize: 20
            });
            //定义PurDtl4SOFGrid_cellEditing
            var PurDtl4SOFGrid_cellEditing = Ext.create('Ext.grid.plugin.CellEditing', {
                clicksToEdit: 1    //单击编辑，单元格修改
            });
            //从自定义信息中获取到grid的配置
            var PurDtl4SOFGrid_indvidualGrid = individualInfo.grid['PurDtl4SOFGrid'];
            //动态内容的配置不能写在插件中
            var PurDtl4SOFGrid_gridInitialConfig = {
                stateful: true,
                region: 'center',
                //split: true, border: true, collapsible: true,
                stateId: 'a27126c8-735c-45c8-835e-a5fc72c1c0f6', //这里请使用guid，防止冲突
                store: PurDtl4SOFGrid_store,
                otype: otypePurchase, //操作类型,add||edit
                plugins: [PurDtl4SOFGrid_cellEditing]
            }
            //动态配置与静态配置合并
            var PurDtl4SOFGrid_gridConfig = Ext.apply(PurDtl4SOFGrid_gridInitialConfig, PurDtl4SOFGrid_indvidualGrid);
            //定义PurDtl4SOFGrid_grid
            var PurDtl4SOFGrid_grid = Ext.create('Ext.ng.GridPanel', PurDtl4SOFGrid_gridConfig);

            var PurchaseTabItems = {
                TabPage10: {
                    id: 'TabPage10',
                    layout: 'border',
                    title: '资金来源',
                    items: [PurDtl4SOFGrid_grid]
                }
            }

            var PurchaseTabArr = [];
            var PurchaseIndTabItems = individualInfo.tabPanel['PurDtl4SOFTab'].items;
            for (var i = 0; i < PurchaseIndTabItems.length; i++) {
                var tab = PurchaseIndTabItems[i];
                if (!tab.hidden) {
                    PurchaseTabArr.push(Ext.apply(PurchaseTabItems[tab.id], tab));
                    //PurchaseTabArr.push(Ext.apply(PurchaseIndTabItems[tab.id], tab));
                }
            }

            var PurchaseTabPanel = Ext.create('Ext.tab.Panel', {
                layout: 'border',
                region: 'center',
                split: true, border: true,// collapsible: true,
                deferredRender: false,
                plain: true,
                activeTab: 0,
                // minHeight: 400,
                // minWidth: 600,
                defaults: { bodyStyle: 'padding:3px' },
                items: PurchaseTabArr
            });

            //定义PurchaseDtlPanelText_form
            var PurchaseDtlPanelText_formInitialConfig = {
                region: 'north',
                frame: true,
                split: true,
                border: true,// collapsible: true,
                //minWidth: 600,
                buskey: 'PhId', //对应的业务表主键
                otype: otype //操作类型,add||edit
            };
            var PurchaseDtlPanelText_formConfig = PurchaseDtlPanelText_formInitialConfig;
            if (individualInfo.form) {
                Ext.apply(PurchaseDtlPanelText_formConfig, individualInfo.form['PurchaseDtlPanelText']);
            }
            var PurchaseDtlPanelText_form = Ext.create('Ext.ng.TableLayoutForm', PurchaseDtlPanelText_formConfig);


            var Purchaseform = Ext.create('Ext.ng.TableLayoutForm', {
                region: 'north',
                frame: true,
                // split: true,
                // minWidth: 400,
                // collapsible: true,
                //autoScroll: true,
                //buskey: 'PhId', //对应的业务表主键属性
                //otype: otype, //操作类型,add||edit||view
                //columnsPerRow: 3,
                //fieldDefaults: {
                //    labelWidth: 87,
                //    anchor: '100%',
                //    margin: '0 10 5 0',
                //    msgTarget: 'side'
                //},
                fields: [
                    {
                        xtype: 'ngText',
                        fieldLabel: '预算单位:',
                        name: 'FDeclarationUnit',
                        colspan: 1,
                        readOnly: true,
                        id: 'FDeclarationUnit'
                    }, {
                        xtype: 'ngText',
                        fieldLabel: '预算部门:',
                        name: 'FBudgetDept',
                        readOnly: true,
                        colspan: 1,
                        id: 'FBudgetDept'
                    }, {
                        xtype: 'ngText',
                        fieldLabel: '项目:',
                        name: 'FProjName',
                        readOnly: true,
                        colspan: 1,
                        id: 'FProjName'
                    }
                ]
            });

            Ext.define('Purchasemodel', {
                extend: 'Ext.data.Model',
                fields: [
                    {
                        name: 'PhId',
                        type: 'System.Int64',
                        mapping: 'PhId'
                    },
                    {
                        name: 'FProjName',
                        type: 'System.String',
                        mapping: 'FProjName'
                    }
                ]
            });
            //采购计划
            Ext.define('PurchaseDtlPanelModel', {
                extend: 'Ext.data.Model',
                fields: [
                    {

                        name: "FContent",
                        type: 'System.String',
                        mapping: 'FContent'
                    },
                    {

                        name: "FCatalogCode",
                        type: 'System.String',
                        mapping: 'FCatalogCode'
                    },
                    {

                        name: "FTypeCode",
                        type: 'System.String',
                        mapping: 'FTypeCode'
                    },
                    {

                        name: "FProcedureCode",
                        type: 'System.String',
                        mapping: 'FProcedureCode'
                    },
                    {

                        name: "FQty",
                        type: 'int',
                        mapping: 'FQty'
                    },
                    {

                        name: "FMeasUnit",
                        type: 'System.String',
                        mapping: 'FMeasUnit'
                    },
                    {

                        name: "FPrice",
                        type: 'float',
                        mapping: 'FPrice'
                    },

                    {

                        name: "MstPhid",
                        type: 'System.Int64',
                        mapping: 'MstPhid'
                    },
                    {

                        name: "FDtlCode",
                        type: 'System.String',
                        mapping: 'FDtlCode'
                    },
                    {

                        name: "FSpecification",
                        type: 'System.String',
                        mapping: 'FSpecification'
                    },
                    {

                        name: "FRemark",
                        type: 'System.String',
                        mapping: 'FRemark'
                    },
                    {

                        name: "FEstimatedPurTime",
                        type: 'System.Datetime',
                        mapping: 'FEstimatedPurTime'
                    },
                    {

                        name: "FIfPerformanceAppraisal",
                        type: 'int',
                        mapping: 'FIfPerformanceAppraisal'
                    },
                    {

                        name: "FAmount",
                        type: 'float',
                        mapping: 'FAmount'
                    },
                    {

                        name: "FName",
                        type: 'System.String',
                        mapping: 'FName'
                    },
                    {
                        "name": "key",
                        "type": "string",
                        "mapping": "key"
                    }
                ]
            });
            var PurchaseDtlPanelStore = Ext.create('Ext.ng.JsonStore', {
                model: 'PurchaseDtlPanelModel',
                autoLoad: false
                // url = C_ROOT + 'GXM/XM/ProjectMst/GetProjectMstInfo'
            })

            var Purchasestore = Ext.create('Ext.ng.JsonStore', {
                model: 'Purchasemodel',
                autoLoad: false
                // url = C_ROOT + 'GXM/XM/ProjectMst/GetProjectMstInfo'
            })


            var Purchasegrid = Ext.create('Ext.ng.GridPanel', {
                region: 'west',
                border: false,
                frame: true,
                width: 200,
                store: Purchasestore,
                columnLines: true,
                buskey: 'PhId', //对应的子表主键属性
                columns: [
                    {
                        header: '项目',
                        dataIndex: 'FProjName',
                        width: 190,
                        sortable: false,
                        // hidden: true
                    }
                ],
                listeners: {
                    'selectionchange': function (view, selected, eOpts) {
                        if (selected[0] != undefined && selected[0].data != undefined) {
                            //切换明细项目时先把原来采购明细保存

                            var PurchaseDtlData = PurchaseDtlPanel_form.getFormData();
                            var PurchaseDtlDataObj = JSON.parse(PurchaseDtlData);
                            var PurchaseDtlFName = "##$$##";
                            if (PurchaseDtlDataObj.form.modifiedRow) {
                                PurchaseDtlFName = PurchaseDtlDataObj.form.modifiedRow.FName;
                                if (PurchaseDtlFName) {
                                    PurchaseDtlPanelStore.clearFilter();
                                    PurchaseDtlPanelStore.filter("FName", PurchaseDtlFName);
                                    if (PurchaseDtlPanelStore.getCount() == 0) {
                                        PurchaseDtlPanelStore.add(PurchaseDtlDataObj.form.modifiedRow);
                                    } else {
                                        PurchaseDtlPanelStore.removeAt(0);
                                        PurchaseDtlPanelStore.add(PurchaseDtlDataObj.form.modifiedRow);
                                    }
                                }
                            }
                            else if (PurchaseDtlDataObj.form.newRow) {
                                PurchaseDtlFName = PurchaseDtlDataObj.form.newRow.FName;
                                if (PurchaseDtlFName) {
                                    PurchaseDtlPanelStore.clearFilter();
                                    PurchaseDtlPanelStore.filter("FName", PurchaseDtlFName);
                                    if (PurchaseDtlPanelStore.getCount() == 0) {
                                        PurchaseDtlPanelStore.add(PurchaseDtlDataObj.form.newRow);
                                    } else {
                                        PurchaseDtlPanelStore.removeAt(0);
                                        PurchaseDtlPanelStore.add(PurchaseDtlDataObj.form.newRow);
                                    }
                                }
                            }



                            PurchaseDtlPanelStore.clearFilter();
                            PurDtl4SOFGrid_store.clearFilter();
                            var FProjName = selected[0].data.FProjName;
                            // alert(FProjName);
                            PurDtl4SOFGrid_store.filter("FName", FProjName);
                            //当没有相关资金来源时,从项目明细中重新获取
                            if (PurDtl4SOFGrid_store.getCount() == 0) {
                                for (var i = 0; i < BudgetDtlPanel_store.getCount(); i++) {
                                    if (BudgetDtlPanel_store.getAt(i).get('FIfPurchase') == 1 && BudgetDtlPanel_store.getAt(i).get('FName') == FProjName) {
                                        //不存在资金来源数据时,添加数据
                                        PurDtl4SOFGrid_store.add({ FName: BudgetDtlPanel_store.getAt(i).get('FName'), FSourceOfFunds: BudgetDtlPanel_store.getAt(i).get('FSourceOfFunds'), FSourceOfFunds_EXName: BudgetDtlPanel_store.getAt(i).get('FSourceOfFunds_EXName'), FAmount: BudgetDtlPanel_store.getAt(i).get('FAmount'), MstPhid: busid, FDtlCode: BudgetDtlPanel_store.getAt(i).get('FDtlCode') });


                                    }
                                }
                            }


                            PurchaseDtlPanelStore.filter("FName", FProjName);
                            if (PurchaseDtlPanelStore.getCount() == 0) {
                                PurchaseDtlPanelStore.add({ FName: FProjName, MstPhid: busid, FDtlCode: BudgetDtlPanel_store.getAt(i).get('FDtlCode'), FIfPerformanceAppraisal: 2 });
                            }
                            //PurchaseDtlPanelStore.data.items[0].data
                            var Purchaseobj = PurchaseDtlPanel_form.getForm();
                            Purchaseobj.setValues(PurchaseDtlPanelStore.data.items[0].data);
                            //代码转名称
                            var codectl = [
                                PurchaseDtlPanel_form.queryById('FCatalogCode'),
                                PurchaseDtlPanel_form.queryById('FTypeCode'),
                                PurchaseDtlPanel_form.queryById('FProcedureCode')

                            ]; //mainPanel_form.queryById('FIfPerformanceAppraisal')
                            BatchBindCombox(codectl);
                        }
                    }
                    ,
                    'afterrender': function (eOpts) {
                        //  Purchasegrid.getSelectionModel().select(0, true);
                    }
                    //,
                    //'beforeselect': function (combo, record, index, eOpts) {
                    //   // alert(11);
                    //}
                }

            });
            //工具栏
            var ngpurchaseToolbar = Ext.create('Ext.ng.Toolbar', {
                region: 'north',
                //rightName: '', //权限名称
                ngbuttons: [
                    'ok'
                ]
            });

            if (otype == $Otype.EDIT || otype == $Otype.VIEW) {
                // if (PurchaseDtlPanelStore.getCount() == 0) {
                Ext.apply(PurchaseDtlPanelStore.proxy.url = C_ROOT + 'GXM/XM/ProjectMst/GetProjectMstInfo');
                Ext.apply(PurchaseDtlPanelStore.proxy.extraParams, { 'id': busid, 'tabtype': 'projectdtlpurchasedtl' });
                PurchaseDtlPanelStore.cachePageData = false;
                PurchaseDtlPanelStore.load();
                PurchaseDtlPanelStore.cachePageData = true;
                // }

                // if (PurDtl4SOFGrid_store.getCount() == 0) {
                Ext.apply(PurDtl4SOFGrid_store.proxy.url = C_ROOT + 'GXM/XM/ProjectMst/GetProjectMstInfo');
                Ext.apply(PurDtl4SOFGrid_store.proxy.extraParams, { 'id': busid, 'tabtype': 'projectdtlpurdtl4sof' });
                PurDtl4SOFGrid_store.cachePageData = false;
                PurDtl4SOFGrid_store.load();
                PurDtl4SOFGrid_store.cachePageData = true;
                // }

            }


            //集中采购
            ngToolbar.get('purchase').on('click', function () {
                var purchaseCount = 0;
                Purchasestore.removeAll();

                //if (otype == $Otype.EDIT || otype == $Otype.VIEW) {
                //    if (PurchaseDtlPanelStore.getCount() == 0) {
                //        Ext.apply(PurchaseDtlPanelStore.proxy.url = C_ROOT + 'GXM/XM/ProjectMst/GetProjectMstInfo');
                //        Ext.apply(PurchaseDtlPanelStore.proxy.extraParams, { 'id': busid, 'tabtype': 'projectdtlpurchasedtl' });
                //        PurchaseDtlPanelStore.cachePageData = false;
                //        PurchaseDtlPanelStore.load();
                //        PurchaseDtlPanelStore.cachePageData = true;
                //    }

                //    if (PurDtl4SOFGrid_store.getCount() == 0) {
                //        Ext.apply(PurDtl4SOFGrid_store.proxy.url = C_ROOT + 'GXM/XM/ProjectMst/GetProjectMstInfo');
                //        Ext.apply(PurDtl4SOFGrid_store.proxy.extraParams, { 'id': busid, 'tabtype': 'projectdtlpurdtl4sof' });
                //        PurDtl4SOFGrid_store.cachePageData = false;
                //        PurDtl4SOFGrid_store.load();
                //        PurDtl4SOFGrid_store.cachePageData = true;
                //    }

                //}
                PurDtl4SOFGrid_store.clearFilter();
                PurchaseDtlPanelStore.clearFilter();
                var PurDtl4SOFGridCount = PurDtl4SOFGrid_store.getCount();
                var PurchaseDtlPanelStoreCount = PurchaseDtlPanelStore.getCount();
                //var PurchaseDtlData = PurchaseDtlPanel_form.getFormData();
                //var PurchaseDtlDataObj = JSON.parse(PurchaseDtlData);
                // PurchaseDtlDataObj.add(PurchaseDtlDataObj.form.newRow);
                for (var i = 0; i < BudgetDtlPanel_store.getCount(); i++) {
                    if (BudgetDtlPanel_store.getAt(i).get('FIfPurchase') == 1 && BudgetDtlPanel_store.getAt(i).get('FName')) {
                        purchaseCount += 1;

                        Purchasestore.add({ 'FProjName': BudgetDtlPanel_store.getAt(i).get('FName') });
                        //不存在资金来源数据时,添加数据
                        if (PurDtl4SOFGridCount == 0) {
                            PurDtl4SOFGrid_store.add({ FName: BudgetDtlPanel_store.getAt(i).get('FName'), FSourceOfFunds: BudgetDtlPanel_store.getAt(i).get('FSourceOfFunds'), FSourceOfFunds_EXName: BudgetDtlPanel_store.getAt(i).get('FSourceOfFunds_EXName'), FAmount: BudgetDtlPanel_store.getAt(i).get('FAmount'), MstPhid: busid, FDtlCode: BudgetDtlPanel_store.getAt(i).get('FDtlCode') });
                        }

                        if (PurchaseDtlPanelStoreCount == 0) {
                            PurchaseDtlPanelStore.clearFilter();
                            PurchaseDtlPanelStore.filter("FName", BudgetDtlPanel_store.getAt(i).get('FName'));
                            if (PurchaseDtlPanelStore.getCount() == 0) {
                                PurchaseDtlPanelStore.add({ FName: BudgetDtlPanel_store.getAt(i).get('FName'), MstPhid: busid, FDtlCode: BudgetDtlPanel_store.getAt(i).get('FDtlCode'), FIfPerformanceAppraisal: 2 });
                            }
                        }
                        //PurDtl4SOFGrid_store.add({ FName: BudgetDtlPanel_store.getAt(i).get('FName'), FSourceOfFunds: BudgetDtlPanel_store.getAt(i).get('FSourceOfFunds'), FAmount: BudgetDtlPanel_store.getAt(i).get('FAmount') });
                    }
                }

                if (purchaseCount == 0) {
                    Ext.MessageBox.alert('提示', "没有选择集中采购的预算明细数据!");
                    return;
                }
                //去掉相同项目名称
                var PurchaseCount = Purchasestore.getCount();
                for (var i = 0; i < PurchaseCount; i++) {
                    Purchasestore.clearFilter();
                    Purchasestore.filter("FProjName", Purchasestore.getAt(i).get("FProjName"));
                    if (Purchasestore.getCount() > 1) {
                        var count = Purchasestore.getCount() - 1;
                        for (var j = 0; j < count; j++) {
                            Purchasestore.removeAt(j);
                            j--;
                            count--;
                            PurchaseCount--;
                        }
                        i--;
                    }
                }
                Purchasestore.clearFilter();

                if (otype == $Otype.EDIT || otype == $Otype.ADD || workflowPanel) {
                    for (var i = 0; i < Purchasestore.getCount(); i++) {
                        var PurchaseFProjName = Purchasestore.getAt(i).get('FProjName');
                        BudgetDtlPanel_store.clearFilter();
                        BudgetDtlPanel_store.filterBy(function (record) {
                            return record.get("FName") == PurchaseFProjName && record.get("FIfPurchase") == 1;
                        })
                        PurDtl4SOFGrid_store.clearFilter();
                        PurDtl4SOFGrid_store.filter("FName", PurchaseFProjName);

                        PurchaseDtlPanelStore.clearFilter();
                        PurchaseDtlPanelStore.filter("FName", PurchaseFProjName);
                        if (BudgetDtlPanel_store.getCount() > 0 && PurchaseDtlPanelStore.getCount() == 0) {
                            PurchaseDtlPanelStore.add({ FName: PurchaseFProjName, MstPhid: busid, FDtlCode: BudgetDtlPanel_store.getAt(0).get('FDtlCode'), FIfPerformanceAppraisal: 2 });
                        }

                        //当明细项目的采购行数跟采购里资金来源行数不同,则移除原来的资金来源,添加新的资金来源
                        if (PurDtl4SOFGrid_store.getCount() != BudgetDtlPanel_store.getCount()) {
                            var count = PurDtl4SOFGrid_store.getCount();
                            for (var j = 0; j < count; j++) {
                                PurDtl4SOFGrid_store.removeAt(j);
                                j--;
                                count--;
                            }
                            for (var j = 0; j < BudgetDtlPanel_store.getCount(); j++) {
                                PurDtl4SOFGrid_store.add({ FName: BudgetDtlPanel_store.getAt(j).get('FName'), FSourceOfFunds: BudgetDtlPanel_store.getAt(j).get('FSourceOfFunds'), FSourceOfFunds_EXName: BudgetDtlPanel_store.getAt(j).get('FSourceOfFunds_EXName'), FAmount: BudgetDtlPanel_store.getAt(j).get('FAmount'), MstPhid: busid, FDtlCode: BudgetDtlPanel_store.getAt(j).get('FDtlCode') });
                            }

                        }


                    }
                }


                //根据明细项目筛选,填入采购计划的总计金额
                for (var i = 0; i < Purchasestore.getCount(); i++) {
                    var PurchaseFProjName = Purchasestore.getAt(i).get('FProjName');
                    PurchaseDtlPanelStore.clearFilter();
                    PurchaseDtlPanelStore.filter("FName", PurchaseFProjName);
                    PurDtl4SOFGrid_store.clearFilter();
                    PurDtl4SOFGrid_store.filter("FName", PurchaseFProjName);
                    var PurchaseDtlPanelAmount = 0, amount = 0;
                    for (var j = 0; j < PurDtl4SOFGrid_store.getCount(); j++) {
                        amount = PurDtl4SOFGrid_store.getAt(j).get('FAmount');
                        if (amount == undefined) {
                            amount = 0;
                        }
                        PurchaseDtlPanelAmount += amount;
                    }
                    PurchaseDtlPanelStore.getAt(0).set("FAmount", PurchaseDtlPanelAmount);
                }
                Purchasestore.clearFilter();
                PurchaseDtlPanelStore.filter("FName", "##$$##");
                PurDtl4SOFGrid_store.filter("FName", "##$$##");
                BudgetDtlPanel_store.clearFilter();

                purchaseWin = Ext.create("Ext.ng.gh.baseWindow", {
                    title: '集中采购',
                    modal: true,
                    height: 515,
                    width: 1000,
                    layout: 'border',
                    items: [
                        //{
                        //    region: 'north',
                        //    layout: 'border',
                        //    height:50,
                        //    border: false,
                        //    item: [ngpurchaseToolbar]
                        //},
                        {
                            region: 'west',
                            layout: 'border',
                            width: '20%',
                            border: false,
                            items: [Purchasegrid]
                        },
                        {
                            region: 'center',
                            layout: 'border',
                            margin: '0 0 0 0',
                            width: '78%',
                            border: false,
                            items: [ngpurchaseToolbar, PurchaseDtlPanel_form, PurchaseTabPanel]
                        }
                    ],
                    invokeCancelback: function () {
                        //点关闭时把修改的同步上去
                        var PurchaseDtlData = PurchaseDtlPanel_form.getFormData();
                        var PurchaseDtlDataObj = JSON.parse(PurchaseDtlData);
                        //var PurchaseDtlFName = "##$$##";
                        if (PurchaseDtlDataObj.form.modifiedRow) {
                            var PurchaseDtlFName = PurchaseDtlDataObj.form.modifiedRow.FName;
                            if (PurchaseDtlFName) {
                                PurchaseDtlPanelStore.clearFilter();
                                PurchaseDtlPanelStore.filter("FName", PurchaseDtlFName);
                                if (PurchaseDtlPanelStore.getCount() == 0) {
                                    PurchaseDtlPanelStore.add(PurchaseDtlDataObj.form.modifiedRow);
                                } else {
                                    PurchaseDtlPanelStore.removeAt(0);
                                    PurchaseDtlPanelStore.add(PurchaseDtlDataObj.form.modifiedRow);
                                }
                            }
                        }
                        else if (PurchaseDtlDataObj.form.newRow) {
                            var PurchaseDtlFName = PurchaseDtlDataObj.form.newRow.FName;
                            if (PurchaseDtlFName) {
                                PurchaseDtlPanelStore.clearFilter();
                                PurchaseDtlPanelStore.filter("FName", PurchaseDtlFName);
                                if (PurchaseDtlPanelStore.getCount() == 0) {
                                    PurchaseDtlPanelStore.add(PurchaseDtlDataObj.form.newRow);
                                } else {
                                    PurchaseDtlPanelStore.removeAt(0);
                                    PurchaseDtlPanelStore.add(PurchaseDtlDataObj.form.newRow);
                                }
                            }
                        }
                        PurchaseDtlPanel_form.getForm().reset();
                        //Ext.getCmp('myFormId').getForm().loadRecord(Ext.create('MyProject.model.MyModel'))

                        //var Purchaseobj = PurchaseDtlPanel_form.getForm();
                        //Purchaseobj.setValues("");


                    }
                    //items: [/*Purchaseform,*/Purchasegrid,PurchaseDtlPanel_form, PurchaseTabPanel/*, PurchaseDtlPanelText_form*/]
                });
                purchaseWin.show();
                for (var i = 0; i < Purchasestore.getCount(); i++) {
                    if (Purchasestore.getAt(i).get('FProjName') == budgetDtlFName) {
                        Purchasegrid.getSelectionModel().select(i, true);
                        break;
                    }
                }
                if (budgetDtlFName == "") {
                    Purchasegrid.getSelectionModel().select(0, true);
                }
                budgetDtlFName = "";
                //Purchasegrid.getSelectionModel().select(0, true);
            });
            //Ext.getCmp('Gridid').getSelectionModel().select(0, true);

            //采购明细确定
            ngpurchaseToolbar.items.get('ok').on('click', function () {
                var PurchaseDtlData = PurchaseDtlPanel_form.getFormData();
                var PurchaseDtlDataObj = JSON.parse(PurchaseDtlData);
                //var PurchaseDtlFName = "##$$##";
                if (PurchaseDtlDataObj.form.modifiedRow) {
                    var PurchaseDtlFName = PurchaseDtlDataObj.form.modifiedRow.FName;
                    if (PurchaseDtlFName) {
                        PurchaseDtlPanelStore.clearFilter();
                        PurchaseDtlPanelStore.filter("FName", PurchaseDtlFName);
                        if (PurchaseDtlPanelStore.getCount() == 0) {
                            PurchaseDtlPanelStore.add(PurchaseDtlDataObj.form.modifiedRow);
                        } else {
                            PurchaseDtlPanelStore.removeAt(0);
                            PurchaseDtlPanelStore.add(PurchaseDtlDataObj.form.modifiedRow);
                        }
                    }
                }
                else if (PurchaseDtlDataObj.form.newRow) {
                    var PurchaseDtlFName = PurchaseDtlDataObj.form.newRow.FName;
                    if (PurchaseDtlFName) {
                        PurchaseDtlPanelStore.clearFilter();
                        PurchaseDtlPanelStore.filter("FName", PurchaseDtlFName);
                        if (PurchaseDtlPanelStore.getCount() == 0) {
                            PurchaseDtlPanelStore.add(PurchaseDtlDataObj.form.newRow);
                        } else {
                            PurchaseDtlPanelStore.removeAt(0);
                            PurchaseDtlPanelStore.add(PurchaseDtlDataObj.form.newRow);
                        }
                    }
                }

                //for (var i = 0; i < Purchasestore.getCount(); i++) {
                //    var PurchaseDtlFName = Purchasestore.getAt(i).get('FProjName');
                //    PurDtl4SOFGrid_store.filter("FName", PurchaseDtlFName);
                //    var PurDtl4SOFGridAmount = 0;
                //    for (var j = 0; j < PurDtl4SOFGrid_store.getCount(); j++) {
                //        PurDtl4SOFGridAmount += PurDtl4SOFGrid_store.getAt(j).get('FAmount')
                //    }

                //    if (PurDtl4SOFGridAmount > PurchaseDtlPanelStore.getAt(0).get('FAmount')) {
                //        Ext.MessageBox.alert('提示', PurchaseDtlFName +  "的资金来源金额不能大于项目金额总计");

                //       return
                //    }
                //}

                for (var i = 0; i < Purchasestore.getCount(); i++) {
                    var PurchaseDtlFName = Purchasestore.getAt(i).get('FProjName');
                    PurDtl4SOFGrid_store.clearFilter();
                    PurDtl4SOFGrid_store.filter("FName", PurchaseDtlFName);
                    var PurDtl4SOFGridAmount = 0;
                    for (var j = 0; j < PurDtl4SOFGrid_store.getCount(); j++) {
                        PurDtl4SOFGridAmount += PurDtl4SOFGrid_store.getAt(j).get('FAmount')
                    }
                    PurchaseDtlPanelStore.clearFilter();
                    PurchaseDtlPanelStore.filter("FName", PurchaseDtlFName);
                    if (+PurDtl4SOFGridAmount > +PurchaseDtlPanelStore.getAt(0).get('FAmount')) {
                        Ext.MessageBox.alert('提示', PurchaseDtlFName + "的资金来源金额不能大于项目金额总计");

                        return
                    }
                }

                PurDtl4SOFGrid_store.clearFilter();
                PurchaseDtlPanelStore.clearFilter();
                //判断必录项是否录了
                for (var i = 0; i < PurchaseDtlPanelStore.getCount(); i++) {
                    var PurchaseDtlFName = PurchaseDtlPanelStore.getAt(i).get('FName');
                    if (!PurchaseDtlPanelStore.getAt(i).get('FContent') || !PurchaseDtlPanelStore.getAt(i).get('FTypeCode') ||
                        !PurchaseDtlPanelStore.getAt(i).get('FProcedureCode') || !PurchaseDtlPanelStore.getAt(i).get('FIfPerformanceAppraisal') ||
                        !PurchaseDtlPanelStore.getAt(i).get('FCatalogCode') || !PurchaseDtlPanelStore.getAt(i).get('FQty') ||
                        !PurchaseDtlPanelStore.getAt(i).get('FMeasUnit') || !PurchaseDtlPanelStore.getAt(i).get('FPrice') ||
                        !PurchaseDtlPanelStore.getAt(i).get('FSpecification') || !PurchaseDtlPanelStore.getAt(i).get('FEstimatedPurTime')
                    ) {
                        Ext.MessageBox.alert('提示', PurchaseDtlFName + "的集中采购必录项未录全!");

                        return
                    }
                    if($GetLength(PurchaseDtlPanelStore.getAt(i).get('FMeasUnit'))>PurchaseDtlPanel_form.queryById("FMeasUnit").maxLength)
                    {
                        Ext.MessageBox.alert('提示', PurchaseDtlFName + "的计量单位输入字符超过最大长度(中文算两个字符)!");

                        return
                    }
                }
                //PurchaseDtlPanelStore.clearFilter();
                //PurDtl4SOFGrid_store.clearFilter();

                PurchaseDtlPanel_form.getForm().reset();
                //var Purchaseobj = PurchaseDtlPanel_form.getForm();
                //Purchaseobj.setValues("");

                purchaseWin.hide();
            });

            //////集中采购



            //增行
            ngToolbar.items.get('addrow').on('click', function () {
                if (tabPanel.activeTab == null) return;

                if (tabPanel.activeTab.id == 'TabPage4' && ProjStatus == "1" ) {
                    var dtlCode = "";
                    //设置项目编码
                    if (otype == $Otype.EDIT && BudgetDtlPanel_store.getCount() > 0) {
                        dtlCode = BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).get("FDtlCode");
                        if (dtlCode) {
                            dtlCode = dtlCode.slice(0, dtlCode.length - 6) + ("000000" + (parseInt(dtlCode.slice(-6)) + 1)).slice(-6);
                        }
                    }

                    var cbbudgetdtldata = BudgetDtlPanel_grid.getSelectionModel();
                    BudgetDtlPanel_store.insert(BudgetDtlPanel_store.getCount(), cbbudgetdtldata);
                    BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('MstPhId', busid);
                    BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FIfPurchase', 2);//是否集中采购 暂时改为1
                    if (dtlCode) {
                        BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FDtlCode', dtlCode);
                    }
                    // 0 新增时保存明细, 1 调整时增加的明细
                    if (midEdit == "midEdit") {
                        BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FMidEdit', "1");
                    } else {
                        BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FMidEdit', "0");
                    }
                    BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FPrice', BudgetDtlPanel_store.getAt(0).get("FPrice"));
                    //当一级项目只允许对应一个预算科目及支出渠道时
                        if(YskmIfControl=='2' && BudgetDtlPanel_store.getCount() - 1>0 ){
                            if(BudgetDtlPanel_store.getAt(0).get('FBudgetAccounts')!=''){
                                BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FBudgetAccounts', BudgetDtlPanel_store.getAt(0).get('FBudgetAccounts'));
                                BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FBudgetAccounts_EXName', BudgetDtlPanel_store.getAt(0).get('FBudgetAccounts_EXName'));
                            }
                            if(BudgetDtlPanel_store.getAt(0).get('FExpensesChannel')!=''){
                                BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FExpensesChannel', BudgetDtlPanel_store.getAt(0).get('FExpensesChannel'));
                                BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FExpensesChannel_EXName', BudgetDtlPanel_store.getAt(0).get('FExpensesChannel_EXName'));
                            }
                        }
                }

                //立项时明细也不能增加新的明细项目   // 20190610 明细增行及复制分开成两个按钮
                if ((tabPanel.activeTab.id == 'TabPage4' && ProjStatus == "2") || (workflowPanel && tabPanel.activeTab.id == 'TabPage4')) {
                    //var selection = BudgetDtlPanel_grid.getSelectionModel().getSelection();
                    //if (selection.length > 0) {
                        //BudgetDtlPanel_store.add(selection[0].data);

						var cbbudgetdtldata = BudgetDtlPanel_grid.getSelectionModel();
						BudgetDtlPanel_store.insert(BudgetDtlPanel_store.getCount(), cbbudgetdtldata);

                        BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('MstPhId', busid);
                        BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FIfPurchase', 2);//是否集中采购 
                        BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FPrice', BudgetDtlPanel_store.getAt(0).get("FPrice"));
                        BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FMidEdit', "1");

                        //当一级项目只允许对应一个预算科目及支出渠道时
                        if(YskmIfControl=='2' && BudgetDtlPanel_store.getCount() - 1>0 ){
                            if(BudgetDtlPanel_store.getAt(0).get('FBudgetAccounts')!=''){
                                BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FBudgetAccounts', BudgetDtlPanel_store.getAt(0).get('FBudgetAccounts'));
                                BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FBudgetAccounts_EXName', BudgetDtlPanel_store.getAt(0).get('FBudgetAccounts_EXName'));
                            }
                            if(BudgetDtlPanel_store.getAt(0).get('FExpensesChannel')!=''){
                                BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FExpensesChannel', BudgetDtlPanel_store.getAt(0).get('FExpensesChannel'));
                                BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FExpensesChannel_EXName', BudgetDtlPanel_store.getAt(0).get('FExpensesChannel_EXName'));
                            }
                        }
						//BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('MstPhId', busid);
						//BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FName', selection[0].data.FName);
						//BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FSourceOfFunds_EXName', selection[0].data.FSourceOfFunds_EXName);
						//BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FSourceOfFunds', selection[0].data.FSourceOfFunds);
						//BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FPaymentMethod_EXName', selection[0].data.FPaymentMethod_EXName);
						//BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FPaymentMethod', selection[0].data.FPaymentMethod);
						///*BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FBudgetAccounts_EXName', selection[0].data.FBudgetAccounts_EXName);
						//BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FBudgetAccounts', selection[0].data.FBudgetAccounts);
						//BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FQtZcgnfl_EXName', selection[0].data.FQtZcgnfl_EXName);
						//BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FQtZcgnfl', selection[0].data.FQtZcgnfl);*/
						//BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FExpensesChannel_EXName', selection[0].data.FExpensesChannel_EXName);
						//BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FExpensesChannel', selection[0].data.FExpensesChannel);
						//BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FMidEdit', "1");
						//BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FPrice', selection[0].data.FPrice);

                        /*BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('MstPhId', busid);
                        BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FAmount', 0);
                        BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FBudgetAccounts_EXName', "");
                        BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FBudgetAccounts', "");
                        BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FExpensesChannel', "");
                        BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FExpensesChannel_EXName', "");
                        BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FFeedback', "");
                        BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FOtherInstructions', "");
                        BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FMidEdit', "1");
                        BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FPrice', BudgetDtlPanel_store.getAt(0).get("FPrice"));

						BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FDtlCode', "");*/


                    //}
                    //else {
                    //    Ext.MessageBox.alert('提示', "请选择需要增加的明细项目");
                    //    return;
                    //}

                }

                if (tabPanel.activeTab.id == 'TabPage6') {
                    var cbbudgetdtldata = ImplPlanPanel_grid.getSelectionModel();
                    ImplPlanPanel_store.insert(ImplPlanPanel_store.getCount(), cbbudgetdtldata);
                    ImplPlanPanel_store.getAt(ImplPlanPanel_store.getCount() - 1).set('MstPhId', busid);
                    if (ImplPlanPanel_store.getCount() == 1) {
                        ImplPlanPanel_store.getAt(0).set('FStartDate', mainPanel_form.queryById("FStartDate").getValue());
                        ImplPlanPanel_store.getAt(0).set('FEndDate', mainPanel_form.queryById("FEndDate").getValue());
                    }
                    if (ImplPlanPanel_store.getCount() > 1) {
                        ImplPlanPanel_store.getAt(ImplPlanPanel_store.getCount() - 1).set('FStartDate', ImplPlanPanel_store.getAt(ImplPlanPanel_store.getCount() - 2).get("FStartDate"));
                        ImplPlanPanel_store.getAt(ImplPlanPanel_store.getCount() - 1).set('FEndDate', ImplPlanPanel_store.getAt(ImplPlanPanel_store.getCount() - 2).get("FEndDate"));
                    }
                }

                if (tabPanel.activeTab.id == 'TabPage9') {
                    if (!performTargetTypeLevel2) {
                        if (PerformTargetPanel_store.getCount() > 0) {
                            performTargetTypeLevel2 = PerformTargetPanel_store.getAt(0).get("FTargetTypeCode");
                        }
                    }

                    if (!performTargetTypeLevel2) {
                        Ext.MessageBox.alert('提示', "请选择绩效项目类型");
                        return;
                    }

                    var cbbudgetdtldata = PerformTargetPanel_grid.getSelectionModel();
                    PerformTargetPanel_store.insert(PerformTargetPanel_store.getCount(), cbbudgetdtldata);
                    PerformTargetPanel_store.getAt(PerformTargetPanel_store.getCount() - 1).set('MstPhId', busid);
                }
                BudgetDtlPanel_grid.view.refresh();
            });



            //删行
            ngToolbar.items.get('deleterow').on('click', function () {
                if (otype == $Otype.VIEW && !workflowPanel) return;

                if (tabPanel.activeTab == null) return;

                if (tabPanel.activeTab.id == 'TabPage4' ) {
                    var selection = BudgetDtlPanel_grid.getSelectionModel().getSelection();
                    if (selection) {
                        if (midEdit == "midEdit" || ProjStatus == "2") {
                            //项目调整时,不能删除原有明细!
                            if (selection[0].data.FMidEdit == 0) {
                                Ext.MessageBox.alert('提示', "不能删除原有明细!");
                                return;
                            }
                            else {
                                BudgetDtlPanel_store.remove(selection);
                            }
                        } else {
                            BudgetDtlPanel_store.remove(selection);
                        }
                        syncFundAppl();

                    }
                }

                if (tabPanel.activeTab.id == 'TabPage6') {
                    var selection = ImplPlanPanel_grid.getSelectionModel().getSelection();
                    if (selection) {
                        ImplPlanPanel_store.remove(selection);
                    }
                }

                if (tabPanel.activeTab.id == 'TabPage9') {
                    var selection = PerformTargetPanel_grid.getSelectionModel().getSelection();
                    if (selection) {
                        PerformTargetPanel_store.remove(selection);
                        PerformTargetPanel_grid.view.refresh();
                        ExsplitGrid(PerformTargetPanel_grid, [3, 4, 5]); //还原单元格
                        ExMergeGrid(PerformTargetPanel_grid, [3, 4, 5], false);
                    }
                }
                BudgetDtlPanel_grid.view.refresh();
            });



            //复制
            ngToolbar.items.get('copyRow').on('click', function () {
                if (tabPanel.activeTab == null) return;
                var selection = BudgetDtlPanel_grid.getSelectionModel().getSelection();
                if (selection.length > 0) {

                    var cbbudgetdtldata = BudgetDtlPanel_grid.getSelectionModel();
                    BudgetDtlPanel_store.insert(BudgetDtlPanel_store.getCount(), cbbudgetdtldata);
                    BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('MstPhId', busid);
                    BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FName', selection[0].data.FName);
                    BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FSourceOfFunds_EXName', selection[0].data.FSourceOfFunds_EXName);
                    BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FSourceOfFunds', selection[0].data.FSourceOfFunds);
                    BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FPaymentMethod_EXName', selection[0].data.FPaymentMethod_EXName);
                    BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FPaymentMethod', selection[0].data.FPaymentMethod);
                    BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FExpensesChannel_EXName', selection[0].data.FExpensesChannel_EXName);
                    BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FExpensesChannel', selection[0].data.FExpensesChannel);
                    BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FMidEdit', "1");
                    BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FPrice', selection[0].data.FPrice);

                    //BudgetDtlPanel_store.add(selection[0].data);
                    //// BudgetDtlPanel_store.insert(BudgetDtlPanel_store.getCount(), dtlValue[0].data);
                    //BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('MstPhId', busid);
                    //BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('Xm3_DtlPhid', "");
                    ////BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FDtlCode', "");
                    //BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FBudgetAmount', 0);
                    ////BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FProjAmount', 0);
                    //BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FBudgetAccounts_EXName', "");
                    //BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FBudgetAccounts', "");
                    //BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FExpensesChannel', "");
                    //BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FExpensesChannel_EXName', "");
                    //BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FFeedback', "");
                    //BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FOtherInstructions', "");
                    //BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FIfPurchase', 2);
                    //BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FMidEdit', "1");

                } else {
                    //直接点击【增行】按钮，即增加一行空的明细行
                    //var cbbudgetdtldata = BudgetDtlPanel_grid.getSelectionModel();
                    //BudgetDtlPanel_store.insert(BudgetDtlPanel_store.getCount(), cbbudgetdtldata);
                    //BudgetDtlPanel_store.getAt(BudgetDtlPanel_store.getCount() - 1).set('FIfPurchase', 2);

                    Ext.MessageBox.alert('提示', "请选择需要增加的明细项目");
                    return;
                }



            });



            //切换tab
            tabPanel.on('tabchange', function (tp, newCard, oldCard, eOpts) {
                if (tp.activeTab == null) return;

                ngToolbar.get('addrow').hide(); //disable();
                ngToolbar.get('deleterow').hide(); //disable();
                ngToolbar.get('copy').hide();
                ngToolbar.get('purchase').hide();
                ngToolbar.get('copyRow').hide(); //disable();
                if (newCard.id == "TabPage9") {
                    //合并单元格
                    ExMergeGrid(PerformTargetPanel_grid, [3, 4, 5], false); // 最后一个参数为false逐个列合并
                }

                if (otype == $Otype.VIEW && !workflowPanel) return;

                if (newCard.id == "TabPage4" || newCard.id == "TabPage6" || newCard.id == "TabPage9") {
                    ngToolbar.get('addrow').show(); //enable();
                    ngToolbar.get('copyRow').show();
                    ngToolbar.get('deleterow').show(); //enable();
                    if (newCard.id == "TabPage4") {
                        ngToolbar.get('copy').show();
                        ngToolbar.get('purchase').show();
                    }
                }

                if (newCard.id == "TabPage5") {
                    syncFundAppl();
                }

                /*if (oldCard.id == "TabPage4" && tempData.DefStr2 == "1") {
                    for (var i = 0; i < BudgetDtlPanel_store.getCount(); i++) {
                        var day = BudgetDtlPanel_store.getAt(i).get("FQty");
                        var people = BudgetDtlPanel_store.getAt(i).get("FQty2");
                        var price = BudgetDtlPanel_store.getAt(i).get("FPrice");
                        BudgetDtlPanel_store.getAt(i).set("FAmount", day * people * price);
                    }
                }*/
            });

            //判断日期格式是否是yyyy-mm-dd
			function IsDate(str){
				var reg=/^(\d{4})-(\d{2})-(\d{2})$/;
				var arr=reg.exec(str);
				if(!reg.test(str)&&RegExp.$2<=12&&RegExp.$3<=31){
					return false;
				}
				return true;
			}

            //保存
            function save(callback) {
                var startdt = mainPanel_form.queryById("FStartDate").getValue();
                var enddt = mainPanel_form.queryById("FEndDate").getValue();
                if (enddt - startdt < 0) {
                    Ext.MessageBox.alert('提示', '输入的开始日期不能小于结束日期!');
                    return;
                }
                for (var i = 0; i < ImplPlanPanel_store.getCount(); i++) {

                    var startdt2 = ImplPlanPanel_store.getAt(i).get('FStartDate');
                    var enddt2 = ImplPlanPanel_store.getAt(i).get('FEndDate');
                    var c = IsDate(startdt2);
                    if (c == true) {
                        startdt2 = new Date(Date.parse(ImplPlanPanel_store.getAt(i).get('FStartDate').replace(/-/g, "/")));
                    }
                    var d = IsDate(enddt2);
                    if (d == true) {
                        enddt2 = new Date(Date.parse(ImplPlanPanel_store.getAt(i).get('FEndDate').replace(/-/g, "/")));
                    }

                    if (enddt2 - startdt2 < 0) {
                        Ext.MessageBox.alert('提示', '实施计划输入的开始日期不能小于结束日期!');
                        return;
                    }


                }

                var mstvf = mainPanel_form.isValid();
                var BudgetDtlPanelvf = BudgetDtlPanel_grid.isValid();
                var FundApplPanelvf = FundApplPanel_grid.isValid();
                var ImplPlanPanelvf = ImplPlanPanel_grid.isValid();

                var projectStartInfoPanellvf = projectStartInfoPanel_form.isValid();
                var FunctionalOvervPanelvf = FunctionalOvervPanel_form.isValid();
                var ProjOverviewPanelvf = ProjOverviewPanel_form.isValid();
                var longTargetPanelvf = longTargetPanel_form.isValid();
                var yearTargetPanelvf = yearTargetPanel_form.isValid();
                var PerformTargetPanel_gridvf = PerformTargetPanel_grid.isValid();

                var XMFProjName = mainPanel_form.queryById("FProjName").getValue();
                if (XMFProjName == "" || XMFProjName == null) {
                    Ext.MessageBox.alert('提示', "请录入项目名称!");
                    return;
                }

                if (!mstvf || !BudgetDtlPanelvf || !FundApplPanelvf || !ImplPlanPanelvf
                    || !FunctionalOvervPanelvf || !ProjOverviewPanelvf || !longTargetPanelvf
                    || !yearTargetPanelvf || !PerformTargetPanel_gridvf || !projectStartInfoPanellvf) {
                    ngToolbar.get('save').setDisabled(false);
                    return;
                }

                syncFundAppl(); //同步资金申请数据

                //检查是否输入了绩效目标分解信息
                if (!checkPerformTarget()) {
                    return;
                }

                //如果没有启用项目绩效，则清除绩效目标分解
                var ifPerEval = mainPanel_form.queryById("FIfPerformanceAppraisal").getValue();
                if (ifPerEval == 2) {
                    PerformTargetPanel_store.removeAll(); //清空绩效目标分解
                } else {   //广州工会特殊要求，绩效目标分解”中，填写至少4项绩效指标
                    var PerformTargetcount = PerformTargetPanel_store.getCount();
                    if (PerformTargetcount < 4) {
                        Ext.MessageBox.alert('提示', "绩效指标不能少于四行!");
                        return;
                    }
                }





                var flg;
                //调用二次开发脚本的校验方法
                if (typeof beforeSaveEdit === "function") {
                    flg = beforeSaveEdit();
                    if (!flg)
                        ngToolbar.get('save').setDisabled(false);
                    return;
                }


                BudgetDtlPanel_store.clearFilter();
                BudgetDtlPanel_store.filter("FIfPurchase", 1);
                if (BudgetDtlPanel_store.getCount() > 0) {
                    if (PurchaseDtlPanelStore.getCount() == 0) {
                        Ext.MessageBox.alert('提示', "请先录入集中采购数据");
                        return;
                    }
                    for (var i = 0; i < BudgetDtlPanel_store.getCount; i++) {
                        var FName = BudgetDtlPanel_store.getAt(i).get("FName");
                        PurchaseDtlPanelStore.clearFilter();
                        PurchaseDtlPanelStore.filter("FName", FName);
                        if (PurchaseDtlPanelStore.getCount() == 0) {
                            Ext.MessageBox.alert('提示', FName + "项目已选择集中采购,但未录入采购明细,请先录入!");
                            return;
                        }

                        // PurchaseDtlPanelStore.getAt(0).get("FAmount")
                    }
                }
                //项目明细删除明细后移除相应采购明细及资金来源
                var PurchaseDtlPanelStoreCount = PurchaseDtlPanelStore.getCount();
                for (var i = 0; i < PurchaseDtlPanelStoreCount; i++) {
                    var FName = PurchaseDtlPanelStore.getAt(i).get("FName");
                    BudgetDtlPanel_store.clearFilter();
                    //BudgetDtlPanel_store.filter("FName", FName);
                    BudgetDtlPanel_store.filterBy(function (record) {
                        return record.get("FName") == FName && record.get("FIfPurchase") == 1;
                    })
                    if (BudgetDtlPanel_store.getCount() == 0) {
                        PurchaseDtlPanelStore.removeAt(i);
                        PurchaseDtlPanelStoreCount--;
                        i--;

                    }
                }

                var PurDtl4SOFGrid_storeCount = PurDtl4SOFGrid_store.getCount();
                for (var i = 0; i < PurDtl4SOFGrid_storeCount; i++) {
                    var FName = PurDtl4SOFGrid_store.getAt(i).get("FName");
                    var FSourceOfFunds = PurDtl4SOFGrid_store.getAt(i).get("FSourceOfFunds");
                    BudgetDtlPanel_store.clearFilter();
                    //BudgetDtlPanel_store.filter("FName", FName);
                    BudgetDtlPanel_store.filterBy(function (record) {
                        return record.get("FName") == FName && record.get("FIfPurchase") == 1 && record.get("FSourceOfFunds") == FSourceOfFunds;
                    })
                    if (BudgetDtlPanel_store.getCount()  == 0) {
                        PurDtl4SOFGrid_store.removeAt(i);
                        PurDtl4SOFGrid_storeCount--;
                        i--;
                    }
                }
                //判断资金金额
                for (var i = 0; i < Purchasestore.getCount(); i++) {
                    var PurchaseDtlFName = Purchasestore.getAt(i).get('FProjName');
                    PurDtl4SOFGrid_store.clearFilter();
                    PurDtl4SOFGrid_store.filter("FName", PurchaseDtlFName);
                    var PurDtl4SOFGridAmount = 0;
                    for (var j = 0; j < PurDtl4SOFGrid_store.getCount(); j++) {
                        PurDtl4SOFGridAmount += PurDtl4SOFGrid_store.getAt(j).get('FAmount')
                    }
                    PurchaseDtlPanelStore.clearFilter();
                    PurchaseDtlPanelStore.filter("FName", PurchaseDtlFName);
                    if (PurchaseDtlPanelStore.getCount() > 0 && +PurDtl4SOFGridAmount > +PurchaseDtlPanelStore.getAt(0).get('FAmount')) {
                        Ext.MessageBox.alert('提示', PurchaseDtlFName + "的资金来源金额不能大于项目金额总计");

                        return
                    }
                }


                ///判断必录项是否录了
                PurDtl4SOFGrid_store.clearFilter();
                PurchaseDtlPanelStore.clearFilter();
                for (var i = 0; i < PurchaseDtlPanelStore.getCount(); i++) {
                    var PurchaseDtlFName = PurchaseDtlPanelStore.getAt(i).get('FName');
                    if (!PurchaseDtlPanelStore.getAt(i).get('FContent') || !PurchaseDtlPanelStore.getAt(i).get('FTypeCode') ||
                        !PurchaseDtlPanelStore.getAt(i).get('FProcedureCode') || !PurchaseDtlPanelStore.getAt(i).get('FIfPerformanceAppraisal') ||
                        !PurchaseDtlPanelStore.getAt(i).get('FCatalogCode') || !PurchaseDtlPanelStore.getAt(i).get('FQty') ||
                            !PurchaseDtlPanelStore.getAt(i).get('FMeasUnit') || !PurchaseDtlPanelStore.getAt(i).get('FPrice') ||
                            !PurchaseDtlPanelStore.getAt(i).get('FSpecification') || !PurchaseDtlPanelStore.getAt(i).get('FEstimatedPurTime')
                    ) {
                        Ext.MessageBox.alert('提示', PurchaseDtlFName + "的集中采购必录项未录全!");
                        BudgetDtlPanel_store.clearFilter();
                        return
                    }
                    if($GetLength(PurchaseDtlPanelStore.getAt(i).get('FMeasUnit'))>PurchaseDtlPanel_form.queryById("FMeasUnit").maxLength)
                    {
                        Ext.MessageBox.alert('提示', PurchaseDtlFName + "的计量单位输入字符超过最大长度(中文算两个字符)!");

                        return
                    }
                }





                BudgetDtlPanel_store.clearFilter();
                //当明细项目有选择集中采购时,主表集中采购置为是
                for (var i = 0; i < BudgetDtlPanel_store.getCount(); i++) {
                    BudgetDtlPanel_store.getAt(i).set('FAmountAfterEdit', BudgetDtlPanel_store.getAt(i).get('FAmount'));
                    if (BudgetDtlPanel_store.getAt(i).get('FIfPurchase') == 1) {
                        mainPanel_form.queryById("FIfPurchase").setValue(1);
                    }
					
					if(!BudgetDtlPanel_grid.getColumn('FQty').hidden && !BudgetDtlPanel_grid.getColumn('FQty2').hidden && !BudgetDtlPanel_grid.getColumn('FPrice').hidden)
					{
						/*if(BudgetDtlPanel_store.getAt(i).get('FQty')*BudgetDtlPanel_store.getAt(i).get('FQty2')*BudgetDtlPanel_store.getAt(i).get('FPrice')!=BudgetDtlPanel_store.getAt(i).get('FAmount'))
						{
							Ext.MessageBox.alert('提示', "天乘以人乘以单价不等于金额!");
							return
						}*/
					}else if(!BudgetDtlPanel_grid.getColumn('FPrice').hidden && !BudgetDtlPanel_grid.getColumn('FNum').hidden)
					{	
						if(BudgetDtlPanel_store.getAt(i).get('FPrice')*BudgetDtlPanel_store.getAt(i).get('FNum')!=BudgetDtlPanel_store.getAt(i).get('FAmount'))
						{
							Ext.MessageBox.alert('提示', "数量乘以单价不等于金额!");
							return
						}
					}
                }
                mainPanel_form.queryById("FIndividualinfophid").setValue(IndividualinfoId);

                var mstformData = mainPanel_form.getFormData();
                var projectdtlbudgetdtlgridData = BudgetDtlPanel_grid.getChangeForEntity();
                var projectdtlfundapplgridData = FundApplPanel_grid.getChangeForEntity();
                var projectdtlimplplangridData = ImplPlanPanel_grid.getChangeForEntity();
                //var projectdtltextcontentgridData = projectStartInfoPanel_form.getFormData();
                var projectdtlperformtargetgridData = PerformTargetPanel_grid.getChangeForEntity();


                //==begin======处理文字内容 xm3_ProjectDtl_TextContent============//
                var FunctionalOverData = FunctionalOvervPanel_form.getFormData(); //所有列在里面了
                var ProjOverviewData = ProjOverviewPanel_form.getFormData();
                var longTargetData = longTargetPanel_form.getFormData();
                var yearTargetData = yearTargetPanel_form.getFormData();
                var projectStartInfoData = projectStartInfoPanel_form.getFormData();

                var projectdtltextcontentDataObj = JSON.parse(FunctionalOverData);
                var ProjOverviewDataObj = JSON.parse(ProjOverviewData);
                var longTargetDataObj = JSON.parse(longTargetData);
                var yearTargetDataObj = JSON.parse(yearTargetData);
                var projectStartInfoDataObj = JSON.parse(projectStartInfoData);


                var mstformDataObj = JSON.parse(mstformData);


                if (otype == $Otype.ADD) {
                    // mstformDataObj.form.FApproveStatus = "1"; //待上报
                    if (Ext.getCmp("TabPage2") != undefined &&(ProjOverviewDataObj.form.newRow.FProjOverview == null || ProjOverviewDataObj.form.newRow.FProjOverview == '')) {
                        Ext.MessageBox.alert('提示',  "项目概况不能为空");
                        return
                    }
                    if (Ext.getCmp("TabPage3") != undefined) {
                        if (projectStartInfoDataObj.form.newRow.FProjBasis == null || projectStartInfoDataObj.form.newRow.FProjBasis == '') {
                            Ext.MessageBox.alert('提示', "项目立项情况下的项目依据不能为空");
                            return
                        }
                        if (projectStartInfoDataObj.form.newRow.FFeasibility == null || projectStartInfoDataObj.form.newRow.FFeasibility == '') {
                            Ext.MessageBox.alert('提示', "项目立项情况下的可行性不能为空");
                            return
                        }
                        if (projectStartInfoDataObj.form.newRow.FNecessity == null || projectStartInfoDataObj.form.newRow.FNecessity == '') {
                            Ext.MessageBox.alert('提示', "项目立项情况下的必要性不能为空");
                            return
                        }
                    }
                    if (Ext.getCmp("TabPage7") != undefined && (longTargetDataObj.form.newRow.FLTPerformGoal == null || longTargetDataObj.form.newRow.FLTPerformGoal == '')) {
                        Ext.MessageBox.alert('提示', "总体绩效目标不能为空");
                        return
                    }
                    projectdtltextcontentDataObj.form.newRow.FProjOverview = ProjOverviewDataObj.form.newRow.FProjOverview;
                    projectdtltextcontentDataObj.form.newRow.FProjBasis = projectStartInfoDataObj.form.newRow.FProjBasis;
                    projectdtltextcontentDataObj.form.newRow.FFeasibility = projectStartInfoDataObj.form.newRow.FFeasibility;
                    projectdtltextcontentDataObj.form.newRow.FNecessity = projectStartInfoDataObj.form.newRow.FNecessity;
                    projectdtltextcontentDataObj.form.newRow.FLTPerformGoal = longTargetDataObj.form.newRow.FLTPerformGoal;
                    projectdtltextcontentDataObj.form.newRow.FAnnualPerformGoal = yearTargetDataObj.form.newRow.FAnnualPerformGoal;
                    //如果是自动带出的绩效评价类型，取lastvalue值
                    if (mainPanel_form.queryById("FPerformEvalType").valueModels.length == 0) {
                        mstformDataObj.form.newRow.FPerformEvalType = mainPanel_form.queryById("FPerformEvalType").defValue;
                    }

                }

                if (otype == $Otype.EDIT || workflowPanel) {


                    var FProjOverviewData, FProjBasisData, FFeasibilityData, FNecessityData, FLTPerformGoalData, FAnnualPerformGoalData;



                    //项目概况
                    if (ProjOverviewDataObj.form.modifiedRow) {
                        if (Ext.getCmp("TabPage2") != undefined && (ProjOverviewDataObj.form.modifiedRow.FProjOverview == null || ProjOverviewDataObj.form.modifiedRow.FProjOverview == '')) {
                            Ext.MessageBox.alert('提示', "项目概况不能为空");
                            return
                        }
                        FProjOverviewData = ProjOverviewDataObj.form.modifiedRow.FProjOverview;
                    }
                    else if (ProjOverviewDataObj.form.newRow) {
                        if (Ext.getCmp("TabPage2") != undefined && (ProjOverviewDataObj.form.newRow.FProjOverview == null || ProjOverviewDataObj.form.newRow.FProjOverview == '')) {
                            Ext.MessageBox.alert('提示', "项目概况不能为空");
                            return
                        }
                        FProjOverviewData = ProjOverviewDataObj.form.newRow.FProjOverview;
                    }
                    projectdtltextcontentDataObj.form.modifiedRow.FProjOverview = FProjOverviewData;

                    //长期绩效目标
                    if (longTargetDataObj.form.modifiedRow) {
                        if (Ext.getCmp("TabPage7") != undefined && (longTargetDataObj.form.modifiedRow.FLTPerformGoal == null || longTargetDataObj.form.modifiedRow.FLTPerformGoal == '')) {
                            Ext.MessageBox.alert('提示', "总体绩效目标不能为空");
                            return
                        }
                        FLTPerformGoalData = longTargetDataObj.form.modifiedRow.FLTPerformGoal;
                    }
                    else if (ProjOverviewDataObj.form.newRow) {
                        if (Ext.getCmp("TabPage7") != undefined && (longTargetDataObj.form.newRow.FLTPerformGoal == null || longTargetDataObj.form.newRow.FLTPerformGoal == '')) {
                            Ext.MessageBox.alert('提示', "总体绩效目标不能为空");
                            return
                        }
                        FLTPerformGoalData = longTargetDataObj.form.newRow.FLTPerformGoal;
                    }
                    projectdtltextcontentDataObj.form.modifiedRow.FLTPerformGoal = FLTPerformGoalData;

                    //年度绩效目标
                    if (yearTargetDataObj.form.modifiedRow) {
                        FAnnualPerformGoalData = yearTargetDataObj.form.modifiedRow.FAnnualPerformGoal;
                    }
                    else if (yearTargetDataObj.form.newRow) {
                        FAnnualPerformGoalData = yearTargetDataObj.form.newRow.FAnnualPerformGoal;
                    }
                    projectdtltextcontentDataObj.form.modifiedRow.FAnnualPerformGoal = FAnnualPerformGoalData;

                    //项目立项情况
                    if (projectStartInfoDataObj.form.modifiedRow) {
                        if (Ext.getCmp("TabPage3") != undefined) {
                            if (projectStartInfoDataObj.form.modifiedRow.FProjBasis == null || projectStartInfoDataObj.form.modifiedRow.FProjBasis == '') {
                                Ext.MessageBox.alert('提示', "项目立项情况下的项目依据不能为空");
                                return
                            }
                            if (projectStartInfoDataObj.form.modifiedRow.FFeasibility == null || projectStartInfoDataObj.form.modifiedRow.FFeasibility == '') {
                                Ext.MessageBox.alert('提示', "项目立项情况下的可行性不能为空");
                                return
                            }
                            if (projectStartInfoDataObj.form.modifiedRow.FNecessity == null || projectStartInfoDataObj.form.modifiedRow.FNecessity == '') {
                                Ext.MessageBox.alert('提示', "项目立项情况下的必要性不能为空");
                                return
                            }
                        }
                        FProjBasisData = projectStartInfoDataObj.form.modifiedRow.FProjBasis;
                        FFeasibilityData = projectStartInfoDataObj.form.modifiedRow.FFeasibility;
                        FNecessityData = projectStartInfoDataObj.form.modifiedRow.FNecessity;
                    }
                    else if (projectStartInfoDataObj.form.newRow) {
                        if (Ext.getCmp("TabPage3") != undefined) {
                            if (projectStartInfoDataObj.form.newRow.FProjBasis == null || projectStartInfoDataObj.form.newRow.FProjBasis == '') {
                                Ext.MessageBox.alert('提示', "项目立项情况下的项目依据不能为空");
                                return
                            }
                            if (projectStartInfoDataObj.form.newRow.FFeasibility == null || projectStartInfoDataObj.form.newRow.FFeasibility == '') {
                                Ext.MessageBox.alert('提示', "项目立项情况下的可行性不能为空");
                                return
                            }
                            if (projectStartInfoDataObj.form.newRow.FNecessity == null || projectStartInfoDataObj.form.newRow.FNecessity == '') {
                                Ext.MessageBox.alert('提示', "项目立项情况下的必要性不能为空");
                                return
                            }
                        }
                        FProjBasisData = projectStartInfoDataObj.form.newRow.FProjBasis;
                        FFeasibilityData = projectStartInfoDataObj.form.newRow.FFeasibility;
                        FNecessityData = projectStartInfoDataObj.form.newRow.FNecessity;
                    }
                    projectdtltextcontentDataObj.form.modifiedRow.FProjBasis = FProjBasisData;
                    projectdtltextcontentDataObj.form.modifiedRow.FFeasibility = FFeasibilityData;
                    projectdtltextcontentDataObj.form.modifiedRow.FNecessity = FNecessityData;
                    //如果是自动带出的绩效评价类型，取lastvalue值
                    if (mainPanel_form.queryById("FPerformEvalType").valueModels.length==0) {
                        mstformDataObj.form.modifiedRow.FPerformEvalType = mainPanel_form.queryById("FPerformEvalType").defValue;
                    }
                }

                var projectdtltextcontentData = JSON.stringify(projectdtltextcontentDataObj);
                //==end========处理文字内容 xm3_ProjectDtl_TextContent============//


                if (otype != $Otype.ADD) {
                    var codes = [];
                    var names = [];
                    var topcode = BudgetDtlPanel_store.getAt(0).get('FDtlCode').substring(0, 12);
                    var maxdtlcode = "0";
                    for (var i = 0; i < BudgetDtlPanel_store.getCount(); i++) {
                        var code = BudgetDtlPanel_store.getAt(i).get('FDtlCode');
                        if (code != "") {
                            if (parseInt(maxdtlcode) < parseInt(code.slice(-6))) {
                                maxdtlcode = code.slice(-6);
                            }
                            if (codes.indexOf(code) < 0) {
                                //var code_name={'FDtlCode':BudgetDtlPanel_store.getAt(i).get('FDtlCode'),'FName':BudgetDtlPanel_store.getAt(i).get('FName')};

                                //if(!codes.indexOf(code_name)){
                                codes.push(code);
                                var name = BudgetDtlPanel_store.getAt(i).get('FName');
                                names.push(name);
                                //}
                            }
                        }
                    }

                    var index_code = [];

                    for (var i = 0; i < BudgetDtlPanel_store.getCount(); i++) {
                        if (BudgetDtlPanel_store.getAt(i).get('FDtlCode') == "") {
                            var codeindex = names.indexOf(BudgetDtlPanel_store.getAt(i).get('FName'));
                            if (codeindex >= 0) {
                                index_code.push({ 'index': i, 'code': codes[codeindex] });
                            } else {
                                maxdtlcode = ("000000" + (parseInt(maxdtlcode) + 1).toString()).slice(-6);
                                BudgetDtlPanel_store.getAt(i).set('FDtlCode', topcode + maxdtlcode);
                            }
                        }
                    }
                }
                projectdtlbudgetdtlgridData = BudgetDtlPanel_grid.getChangeForEntity();

                

                var ifcontinue = true;//判断页面功能控制设置后是否继续执行
				//立项时明细也不能增加新的明细项目
                if (otype != $Otype.ADD && (ProjStatus == "2" || workflowPanel )) {


					if(index_code.length>0) {
						Ext.MessageBox.confirm('提示', '存在相同名称的明细，是否设置代码一致？', callBack);

						function callBack(callBackid) {
							if (callBackid.toString() == "no") {
								//return;
								for(var x=0;x<index_code.length;x++){
									maxdtlcode=("000000" +(parseInt(maxdtlcode)+1).toString()).slice(-6);
									BudgetDtlPanel_store.getAt(index_code[x].index).set('FDtlCode', topcode+maxdtlcode);
								}
							}else if(callBackid.toString() == "cancel"){
								return;
							}else {
								for(var x=0;x<index_code.length;x++){
									BudgetDtlPanel_store.getAt(index_code[x].index).set('FDtlCode', index_code[x].code);
								}
							}

							projectdtlbudgetdtlgridData = BudgetDtlPanel_grid.getChangeForEntity();
							mstformData = JSON.stringify(mstformDataObj);
							var mydata = { 'mstformData': mstformData };

							myData = Ext.apply(mydata, { 'projectdtlbudgetdtlgridData': projectdtlbudgetdtlgridData });//合并
							myData = Ext.apply(mydata, { 'projectdtlfundapplgridData': projectdtlfundapplgridData });//合并
							myData = Ext.apply(mydata, { 'projectdtlimplplangridData': projectdtlimplplangridData });//合并
							myData = Ext.apply(mydata, { 'projectdtltextcontentgridData': projectdtltextcontentData });//合并
							myData = Ext.apply(mydata, { 'projectdtlperformtargetgridData': projectdtlperformtargetgridData });

							if (midEdit == "midEdit") {
								myData = Ext.apply(mydata, { 'midEdit': midEdit });//增加预立项调整
							}

							//采购信息和资金来源
							PurchaseDtlPanelStore.clearFilter();
							var PurchaseDtlRecord = new Array();
							PurchaseDtlPanelStore.each(function (record) {
								PurchaseDtlRecord.push(record.data);
							});
							PurDtl4SOFGrid_store.clearFilter();
							var PurDtl4SOFGridRecord = new Array();
							PurDtl4SOFGrid_store.each(function (record) {
								PurDtl4SOFGridRecord.push(record.data);
							});

							var PurchaseDtlRecordData = new Array();
							for (var i = 0; i < PurchaseDtlRecord.length; i++) {
								PurchaseDtlRecordData.push({ "row": PurchaseDtlRecord[i] });
							};
							var PurchaseDtlRecordDataJson = JSON.stringify({ "table": { "key": "PhId", "newRow": PurchaseDtlRecordData } });

							var PurDtl4SOFGridRecordData = new Array();
							for (var i = 0; i < PurDtl4SOFGridRecord.length; i++) {
								PurDtl4SOFGridRecordData.push({ "row": PurDtl4SOFGridRecord[i] });
							};
							var PurDtl4SOFGridRecordDataJson = JSON.stringify({ "table": { "key": "PhId", "newRow": PurDtl4SOFGridRecordData } });
							

							myData = Ext.apply(mydata, { 'projectdtlpurchasedtlformData': PurchaseDtlRecordDataJson });//合并
							myData = Ext.apply(mydata, { 'projectdtlpurdtl4sofgridData': PurDtl4SOFGridRecordDataJson /*JSON.stringify(PurDtl4SOFGridRecordData)*/ });//合并

							var extendData;
							//调用二开代码获取二开需要保存的数据
							if (typeof getExtendData === "function") {
								extendData = getExtendData();
								myData = Ext.apply(mydata, extendData);//合并
                            }


							//以下URL是获取附件信息，guid为attachGuid，type固定为loadform
							//http://localhost/i8FileSrv/NGInterface.aspx?type=loadform&guid=6c7de5b2-1bfd-40fd-ab4c-361f048a8131

							//异步执行问题还是没有解决，目前先采用在success方法中执行下一个ajax
							//var iuiy = 'i8FileSrv/NGInterface.aspx?type=loadform&guid=' + attachGuid;
							//判断是I8还是I^，目前现根据浏览器地址判断（C_ROOT）
							var TypeProc = C_ROOT.replace("/", "").replace("/","");
							var fileUrl = '/' + TypeProc+'FileSrv/NGInterface.aspx';
							//var fileUrl = '/i8FileSrv/NGInterface.aspx';
							//var fileUrl = '/g6hFileSrv/NGInterface.aspx';
							Ext.Ajax.request({
								params: { type: 'loadform', guid: attachGuid },
								url: fileUrl,
								async:false,
								success: function (atr) {
									var atro = Ext.JSON.decode(atr.responseText);
                                    if (atro.Rows.length == 0) {
                                        if (otype == $Otype.ADD) {
                                            if (mstformDataObj.form.newRow.FTemporary == 1) {
                                                Ext.MessageBox.alert('提示', "临时项目时必须上传附件");
                                                ifcontinue = false;
                                            }
                                        } else {
                                            if (mstformDataObj.form.modifiedRow.FTemporary == 1) {
                                                Ext.MessageBox.alert('提示', "临时项目时必须上传附件");
                                                ifcontinue = false;
                                            }
                                        }
                                        //传入功能点标识和控制单据的组织，如果返回TRUE，则要进行控制
                                        Ext.Ajax.request({
                                            params: { 'BZ': "G6HBLKZLoadform", 'DWDM': mainPanel_form.queryById("FDeclarationUnit").getValue() },
                                            url: C_ROOT + 'GXM/XM/ProjectMst/FindQTControlSet',
                                            async: false,
                                            success: function (response) {
                                                var resp = Ext.JSON.decode(response.responseText);
                                                if (resp.Status === "success") {
                                                    var QTControlSet = resp.Msg;
                                                    if (QTControlSet == "true") {
                                                        if (otype == $Otype.ADD) {
                                                            if (mstformDataObj.form.newRow.FProjAttr == '2') {
                                                                Ext.MessageBox.alert('提示', "新增项目时必须上传附件");
                                                                ifcontinue = false;
                                                            }
                                                        } else {
                                                            if (mstformDataObj.form.modifiedRow.FProjAttr == '2') {
                                                                Ext.MessageBox.alert('提示', "新增项目时必须上传附件");
                                                                ifcontinue = false;
                                                            }
                                                        }
                                                    }

                                                }
                                            }
                                        });

									}
									//**********save
                                    if (ifcontinue == true) {
                                        Ext.Ajax.request({
                                            params: mydata,
                                            url: C_ROOT + 'GXM/XM/ProjectMst/save',
                                            async: false,
                                            success: function (response) {
                                                var resp = Ext.JSON.decode(response.responseText);
                                                if (resp.Status === "success") {
                                                    LoadAttach.Save("", attachGuid, resp.KeyCodes[0]);//保存附件

                                                    if (callback && callback != 'notclose') {
                                                        //单据保存后如果有引用过的则进行保存批注数据
                                                        SaveMemogridData();
                                                        callback();
                                                    }
                                                    else {
                                                        var New_IndividualinfoId="";
                                                        if(mainPanel_form.queryById("FTemporary")&&mainPanel_form.queryById("FTemporary").getValue()=='1'){
                                                        //临时项目不需要切换模板
                                                        }else{
                                                            New_IndividualinfoId = FindIndividualInfo(resp.KeyCodes[0]);
                                                        }
                                                        
                                                        if (New_IndividualinfoId != IndividualinfoId && New_IndividualinfoId != "") {
                                                            Ext.MessageBox.alert('提示', "实际项目金额与模板不符合，将自动为您切换模板!", function () {
                                                                //单据保存后如果有引用过的则进行保存批注数据
                                                                SaveMemogridData();
                                                                if (window.external.RefreshWebListPage != undefined) {
                                                                    window.external.RefreshWebListPage();
                                                                } else {
                                                                    $NG3Refresh();
                                                                }
                                                                var f = $GetWFrame();
                                                                var tab = f.Center.getActiveTab();
                                                                if (ProjStatus == "2") {
                                                                    $OpenTab( '项目立项-修改模板', C_ROOT + 'GXM/XM/ProjectMst/ProjectMstEdit?otype=edit&changeIndividualinfoId=1&id=' + resp.KeyCodes[0] + "&ProjStatus=" + ProjStatus + '&IndividualinfoId=' + New_IndividualinfoId, "", false);
                                                                } else {
                                                                    $OpenTab( '项目预立项-修改模板', C_ROOT + 'GXM/XM/ProjectMst/ProjectMstEdit?otype=edit&changeIndividualinfoId=1&id=' + resp.KeyCodes[0] + "&ProjStatus=" + ProjStatus + '&IndividualinfoId=' + New_IndividualinfoId, "", false);
                                                                }
                                                               
                                                                f.Center.remove(tab);
                                                            });


                                                          
                                                            
                                                        } else {
                                                            Ext.MessageBox.alert('提示', "保存成功", function () {

                                                                //单据保存后如果有引用过的则进行保存批注数据
                                                                SaveMemogridData();
                                                                if (window.external.RefreshWebListPage != undefined) {
                                                                    window.external.RefreshWebListPage();
                                                                } else {
                                                                    $NG3Refresh();
                                                                }
                                                                if (callback != 'notclose' || otype == $Otype.EDIT) {
                                                                    $CloseTab();

                                                                } else {
                                                                    if (otype == $Otype.ADD) {
                                                                        location.reload();
                                                                    } else {
                                                                        var f = $GetWFrame();
                                                                        var tab = f.Center.getActiveTab();
                                                                        if (ProjStatus == "2") {
                                                                            $OpenTab('项目立项-新增', C_ROOT + 'GXM/XM/ProjectMst/ProjectMstEdit?otype=add&ProjStatus=' + 2);
                                                                        } else {
                                                                            $OpenTab('项目预立项-新增', C_ROOT + 'GXM/XM/ProjectMst/ProjectMstEdit?otype=add&ProjStatus=' + 1);
                                                                        }
                                                                        f.Center.remove(tab);

                                                                    }
                                                                }
                                                            });
                                                        }


                                                       
                                                    }
                                                    $NG3Refresh();
                                                } else {
                                                    ngToolbar.get('save').setDisabled(false);
                                                    Ext.MessageBox.alert('保存失败', resp.Msg);
                                                }
                                            }
                                        });
                                    }


									//**************
								}
							});

						}
						return;
					}
					//return;
				}

				mstformData = JSON.stringify(mstformDataObj);
				var mydata = { 'mstformData': mstformData };

				myData = Ext.apply(mydata, { 'projectdtlbudgetdtlgridData': projectdtlbudgetdtlgridData });//合并
				myData = Ext.apply(mydata, { 'projectdtlfundapplgridData': projectdtlfundapplgridData });//合并
				myData = Ext.apply(mydata, { 'projectdtlimplplangridData': projectdtlimplplangridData });//合并
				myData = Ext.apply(mydata, { 'projectdtltextcontentgridData': projectdtltextcontentData });//合并
				myData = Ext.apply(mydata, { 'projectdtlperformtargetgridData': projectdtlperformtargetgridData });

				if (midEdit == "midEdit") {
					myData = Ext.apply(mydata, { 'midEdit': midEdit });//增加预立项调整
				}

				//采购信息和资金来源
				PurchaseDtlPanelStore.clearFilter();
				var PurchaseDtlRecord = new Array();
				PurchaseDtlPanelStore.each(function (record) {
					PurchaseDtlRecord.push(record.data);
				});
				PurDtl4SOFGrid_store.clearFilter();
				var PurDtl4SOFGridRecord = new Array();
				PurDtl4SOFGrid_store.each(function (record) {
					PurDtl4SOFGridRecord.push(record.data);
				});

				var PurchaseDtlRecordData = new Array();
				for (var i = 0; i < PurchaseDtlRecord.length; i++) {
					PurchaseDtlRecordData.push({ "row": PurchaseDtlRecord[i] });
				};
				var PurchaseDtlRecordDataJson = JSON.stringify({ "table": { "key": "PhId", "newRow": PurchaseDtlRecordData } });

				var PurDtl4SOFGridRecordData = new Array();
				for (var i = 0; i < PurDtl4SOFGridRecord.length; i++) {
					PurDtl4SOFGridRecordData.push({ "row": PurDtl4SOFGridRecord[i] });
				};
				var PurDtl4SOFGridRecordDataJson = JSON.stringify({ "table": { "key": "PhId", "newRow": PurDtl4SOFGridRecordData } });
				

				myData = Ext.apply(mydata, { 'projectdtlpurchasedtlformData': PurchaseDtlRecordDataJson });//合并
				myData = Ext.apply(mydata, { 'projectdtlpurdtl4sofgridData': PurDtl4SOFGridRecordDataJson /*JSON.stringify(PurDtl4SOFGridRecordData)*/ });//合并

				var extendData;
				//调用二开代码获取二开需要保存的数据
				if (typeof getExtendData === "function") {
					extendData = getExtendData();
					myData = Ext.apply(mydata, extendData);//合并
				}
				//以下URL是获取附件信息，guid为attachGuid，type固定为loadform
				//http://localhost/i8FileSrv/NGInterface.aspx?type=loadform&guid=6c7de5b2-1bfd-40fd-ab4c-361f048a8131

				//异步执行问题还是没有解决，目前先采用在success方法中执行下一个ajax
				//var iuiy = 'i8FileSrv/NGInterface.aspx?type=loadform&guid=' + attachGuid;
				//判断是I8还是I^，目前现根据浏览器地址判断（C_ROOT）
				var TypeProc = C_ROOT.replace("/", "").replace("/","");
				var fileUrl = '/' + TypeProc+'FileSrv/NGInterface.aspx';
				//var fileUrl = '/i8FileSrv/NGInterface.aspx';
				//var fileUrl = '/g6hFileSrv/NGInterface.aspx';
				Ext.Ajax.request({
					params: { type: 'loadform', guid: attachGuid },
					url: fileUrl,
					async:false,
					success: function (atr) {
						var atro = Ext.JSON.decode(atr.responseText);
						if (atro.Rows.length == 0) {
                            if (otype == $Otype.ADD) {
                                if (mstformDataObj.form.newRow.FTemporary == 1) {
                                    Ext.MessageBox.alert('提示', "临时项目时必须上传附件");
                                    ifcontinue = false;
                                }
                            } else {
                                if (mstformDataObj.form.modifiedRow.FTemporary == 1) {
                                    Ext.MessageBox.alert('提示', "临时项目时必须上传附件");
                                    ifcontinue = false;
                                }
                            }

                            //传入功能点标识和控制单据的组织，如果返回TRUE，则要进行控制
                            Ext.Ajax.request({
                                params: { 'BZ': "G6HBLKZLoadform", 'DWDM': mainPanel_form.queryById("FDeclarationUnit").getValue() },
                                url: C_ROOT + 'GXM/XM/ProjectMst/FindQTControlSet',
                                async: false,
                                success: function (response) {
                                    var resp = Ext.JSON.decode(response.responseText);
                                    if (resp.Status === "success") {
                                        var QTControlSet = resp.Msg;
                                        if (QTControlSet == "true") {
                                            if (otype == $Otype.ADD) {
                                                if (mstformDataObj.form.newRow.FProjAttr == '2') {
                                                    Ext.MessageBox.alert('提示', "新增项目时必须上传附件");
                                                    ifcontinue = false;
                                                }
                                            } else {
                                                if (mstformDataObj.form.modifiedRow.FProjAttr == '2') {
                                                    Ext.MessageBox.alert('提示', "新增项目时必须上传附件");
                                                    ifcontinue = false;
                                                }
                                            }
                                        }

                                    }
                                }
                            });
                        }
                        if (ifcontinue == true) {
                            //**********save
                            if(otype == $Otype.ADD || XMreference=='1'){
                                Ext.Ajax.request({
                                    params: { 'BZ': "G6HBLKZPurchase" ,'OrgCode':mainPanel_form.queryById("FDeclarationUnit").getValue()},
                                    url: C_ROOT + 'GQT/QT/QTControlSet/GetQTControlByBZAndOrg',
                                    async: false,
                                    success: function (response) {
                                        var resp = Ext.JSON.decode(response.responseText);
                                        if (resp.Status === "success") {
                                            var QTControlSet = resp.Msg;
                                            if (QTControlSet == "true") {
                                                Ext.MessageBox.confirm('提示', '请确认当前预算项目是否需要列入采购预算，如需要列入，请在单据下方项目预算明细中维护启用集中采购并维护信息，如已经维护，请忽略此消息。是否继续维护集中采购信息。', callBack);
                                                function callBack(callBackid) {
                                                    if(callBackid.toString() =='yes'){

                                                    }else{
                                                        Ext.Ajax.request({
                                                            params: mydata,
                                                            url: C_ROOT + 'GXM/XM/ProjectMst/save',
                                                            async: false,
                                                            success: function (response) {
                                                                var resp = Ext.JSON.decode(response.responseText);
                                                                if (resp.Status === "success") {
                                                                    LoadAttach.Save("", attachGuid, resp.KeyCodes[0]);//保存附件

                                                                    if (callback && callback != 'notclose') {
                                                                        //单据保存后如果有引用过的则进行保存批注数据
                                                                        SaveMemogridData();
                                                                        $NG3Refresh();
                                                                        callback();

                                                                    }
                                                                    else {
                                                                        var New_IndividualinfoId="";
                                                                        if(mainPanel_form.queryById("FTemporary")&&mainPanel_form.queryById("FTemporary").getValue()=='1'){
                                                                        //临时项目不需要切换模板
                                                                        }else{
                                                                            New_IndividualinfoId = FindIndividualInfo(resp.KeyCodes[0]);
                                                                        }
                                                                        if (New_IndividualinfoId != IndividualinfoId && New_IndividualinfoId != "") {
                                                                            Ext.MessageBox.alert('提示', "实际项目金额与模板不符合，将自动为您切换模板!", function () {
                                                                                //单据保存后如果有引用过的则进行保存批注数据
                                                                                SaveMemogridData();
                                                                                if (window.external.RefreshWebListPage != undefined) {
                                                                                    window.external.RefreshWebListPage();
                                                                                } else {
                                                                                    $NG3Refresh();
                                                                                }
                                                                                var f = $GetWFrame();
                                                                                var tab = f.Center.getActiveTab();
                                                                                if (ProjStatus == "2") {
                                                                                    $OpenTab('项目立项-修改模板', C_ROOT + 'GXM/XM/ProjectMst/ProjectMstEdit?otype=edit&changeIndividualinfoId=1&id=' + resp.KeyCodes[0] + "&ProjStatus=" + ProjStatus + '&IndividualinfoId=' + New_IndividualinfoId, "", false);
                                                                                } else {
                                                                                    $OpenTab('项目预立项-修改模板', C_ROOT + 'GXM/XM/ProjectMst/ProjectMstEdit?otype=edit&changeIndividualinfoId=1&id=' + resp.KeyCodes[0] + "&ProjStatus=" + ProjStatus + '&IndividualinfoId=' + New_IndividualinfoId, "", false);
                                                                                }
                                                                                f.Center.remove(tab);
                                                                            });

                                                                        } else {
                                                                            Ext.MessageBox.alert('提示', "保存成功", function () {

                                                                                //单据保存后如果有引用过的则进行保存批注数据
                                                                                SaveMemogridData();

                                                                                if (window.external.RefreshWebListPage != undefined) {
                                                                                    window.external.RefreshWebListPage();
                                                                                } else {
                                                                                    $NG3Refresh();
                                                                                }
                                                                                if (callback != 'notclose' || otype == $Otype.EDIT) {
                                                                                    $CloseTab();

                                                                                } else {
                                                                                    if (otype == $Otype.ADD) {
                                                                                        location.reload();
                                                                                    } else {
                                                                                        var f = $GetWFrame();
                                                                                        var tab = f.Center.getActiveTab();
                                                                                        if (ProjStatus == "2") {
                                                                                            $OpenTab('项目立项-新增', C_ROOT + 'GXM/XM/ProjectMst/ProjectMstEdit?otype=add&ProjStatus=' + 2);
                                                                                        } else {
                                                                                            $OpenTab('项目预立项-新增', C_ROOT + 'GXM/XM/ProjectMst/ProjectMstEdit?otype=add&ProjStatus=' + 1);
                                                                                        }
                                                                                        f.Center.remove(tab);
                                                                                    }
                                                                                }
                                                                            });
                                                                        }

                                                                        
                                                                    }

                                                                } else {
                                                                    ngToolbar.get('save').setDisabled(false);
                                                                    Ext.MessageBox.alert('保存失败', resp.Msg);
                                                                }
                                                            }
                                                        });
                                                    }
                                                }

                                            } else {
                                                Ext.Ajax.request({
                                                    params: mydata,
                                                    url: C_ROOT + 'GXM/XM/ProjectMst/save',
                                                    async: false,
                                                    success: function (response) {
                                                        var resp = Ext.JSON.decode(response.responseText);
                                                        if (resp.Status === "success") {
                                                            LoadAttach.Save("", attachGuid, resp.KeyCodes[0]);//保存附件

                                                            if (callback && callback != 'notclose') {
                                                                //单据保存后如果有引用过的则进行保存批注数据
                                                                SaveMemogridData();
                                                                $NG3Refresh();
                                                                callback();

                                                            }
                                                            else {
                                                                var New_IndividualinfoId="";
                                                                if(mainPanel_form.queryById("FTemporary")&&mainPanel_form.queryById("FTemporary").getValue()=='1'){
                                                                //临时项目不需要切换模板
                                                                }else{
                                                                    New_IndividualinfoId = FindIndividualInfo(resp.KeyCodes[0]);
                                                                }
                                                                if (New_IndividualinfoId != IndividualinfoId && New_IndividualinfoId != "") {
                                                                    Ext.MessageBox.alert('提示', "实际项目金额与模板不符合，将自动为您切换模板!", function () {
                                                                        //单据保存后如果有引用过的则进行保存批注数据
                                                                        SaveMemogridData();
                                                                        if (window.external.RefreshWebListPage != undefined) {
                                                                            window.external.RefreshWebListPage();
                                                                        } else {
                                                                            $NG3Refresh();
                                                                        }
                                                                        var f = $GetWFrame();
                                                                        var tab = f.Center.getActiveTab();
                                                                        if (ProjStatus == "2") {
                                                                            $OpenTab('项目立项-修改模板', C_ROOT + 'GXM/XM/ProjectMst/ProjectMstEdit?otype=edit&changeIndividualinfoId=1&id=' + resp.KeyCodes[0] + "&ProjStatus=" + ProjStatus + '&IndividualinfoId=' + New_IndividualinfoId, "", false);
                                                                        } else {
                                                                            $OpenTab('项目预立项-修改模板', C_ROOT + 'GXM/XM/ProjectMst/ProjectMstEdit?otype=edit&changeIndividualinfoId=1&id=' + resp.KeyCodes[0] + "&ProjStatus=" + ProjStatus + '&IndividualinfoId=' + New_IndividualinfoId, "", false);
                                                                        }
                                                                        f.Center.remove(tab);
                                                                    });

                                                                } else {
                                                                    Ext.MessageBox.alert('提示', "保存成功", function () {

                                                                        //单据保存后如果有引用过的则进行保存批注数据
                                                                        SaveMemogridData();

                                                                        if (window.external.RefreshWebListPage != undefined) {
                                                                            window.external.RefreshWebListPage();
                                                                        } else {
                                                                            $NG3Refresh();
                                                                        }
                                                                        if (callback != 'notclose' || otype == $Otype.EDIT) {
                                                                            $CloseTab();

                                                                        } else {
                                                                            if (otype == $Otype.ADD) {
                                                                                location.reload();
                                                                            } else {
                                                                                var f = $GetWFrame();
                                                                                var tab = f.Center.getActiveTab();
                                                                                if (ProjStatus == "2") {
                                                                                    $OpenTab('项目立项-新增', C_ROOT + 'GXM/XM/ProjectMst/ProjectMstEdit?otype=add&ProjStatus=' + 2);
                                                                                } else {
                                                                                    $OpenTab('项目预立项-新增', C_ROOT + 'GXM/XM/ProjectMst/ProjectMstEdit?otype=add&ProjStatus=' + 1);
                                                                                }
                                                                                f.Center.remove(tab);
                                                                            }
                                                                        }
                                                                    });
                                                                }

                                                                
                                                            }

                                                        } else {
                                                            ngToolbar.get('save').setDisabled(false);
                                                            Ext.MessageBox.alert('保存失败', resp.Msg);
                                                        }
                                                    }
                                                });
                                            }

                                        }
                                    }
                                });
                            }else{
                                Ext.Ajax.request({
                                    params: mydata,
                                    url: C_ROOT + 'GXM/XM/ProjectMst/save',
                                    async: false,
                                    success: function (response) {
                                        var resp = Ext.JSON.decode(response.responseText);
                                        if (resp.Status === "success") {
                                            LoadAttach.Save("", attachGuid, resp.KeyCodes[0]);//保存附件

                                            if (callback && callback != 'notclose') {
                                                //单据保存后如果有引用过的则进行保存批注数据
                                                SaveMemogridData();
                                                $NG3Refresh();
                                                callback();

                                            }
                                            else {
                                                var New_IndividualinfoId="";
                                                if(mainPanel_form.queryById("FTemporary")&&mainPanel_form.queryById("FTemporary").getValue()=='1'){
                                                //临时项目不需要切换模板
                                                }else{
                                                    New_IndividualinfoId = FindIndividualInfo(resp.KeyCodes[0]);
                                                }
                                                if (New_IndividualinfoId != IndividualinfoId && New_IndividualinfoId != "") {
                                                    Ext.MessageBox.alert('提示', "实际项目金额与模板不符合，将自动为您切换模板!", function () {
                                                        //单据保存后如果有引用过的则进行保存批注数据
                                                        SaveMemogridData();
                                                        if (window.external.RefreshWebListPage != undefined) {
                                                            window.external.RefreshWebListPage();
                                                        } else {
                                                            $NG3Refresh();
                                                        }
                                                        var f = $GetWFrame();
                                                        var tab = f.Center.getActiveTab();
                                                        if (ProjStatus == "2") {
                                                            $OpenTab('项目立项-修改模板', C_ROOT + 'GXM/XM/ProjectMst/ProjectMstEdit?otype=edit&changeIndividualinfoId=1&id=' + resp.KeyCodes[0] + "&ProjStatus=" + ProjStatus + '&IndividualinfoId=' + New_IndividualinfoId, "", false);
                                                        } else {
                                                            $OpenTab('项目预立项-修改模板', C_ROOT + 'GXM/XM/ProjectMst/ProjectMstEdit?otype=edit&changeIndividualinfoId=1&id=' + resp.KeyCodes[0] + "&ProjStatus=" + ProjStatus + '&IndividualinfoId=' + New_IndividualinfoId, "", false);
                                                        }
                                                        f.Center.remove(tab);
                                                    });

                                                } else {
                                                    Ext.MessageBox.alert('提示', "保存成功", function () {

                                                        //单据保存后如果有引用过的则进行保存批注数据
                                                        SaveMemogridData();

                                                        if (window.external.RefreshWebListPage != undefined) {
                                                            window.external.RefreshWebListPage();
                                                        } else {
                                                            $NG3Refresh();
                                                        }
                                                        if (callback != 'notclose' || otype == $Otype.EDIT) {
                                                            $CloseTab();

                                                        } else {
                                                            if (otype == $Otype.ADD) {
                                                                location.reload();
                                                            } else {
                                                                var f = $GetWFrame();
                                                                var tab = f.Center.getActiveTab();
                                                                if (ProjStatus == "2") {
                                                                    $OpenTab('项目立项-新增', C_ROOT + 'GXM/XM/ProjectMst/ProjectMstEdit?otype=add&ProjStatus=' + 2);
                                                                } else {
                                                                    $OpenTab('项目预立项-新增', C_ROOT + 'GXM/XM/ProjectMst/ProjectMstEdit?otype=add&ProjStatus=' + 1);
                                                                }
                                                                f.Center.remove(tab);
                                                            }
                                                        }
                                                    });
                                                }

                                                
                                            }

                                        } else {
                                            ngToolbar.get('save').setDisabled(false);
                                            Ext.MessageBox.alert('保存失败', resp.Msg);
                                        }
                                    }
                                });
                            }
                            
                                
                            
                        }

						//**************
					}
				});
            }

            function noclose(){
            }

            //同步预算明细数据到资金申请
            function syncFundAppl() {
                var count = FundApplPanel_store.getCount();
                if (!BudgetDtlPanel_grid.hasModifyed() && count>0) return;

                var record, dSourceOfFunds, amount, budgetmoney, find, fundName, projectAmount = 0, budgetAmount = 0;
                var funds = new Array();
                var fundsName = new Array();
                for (var i = 0; i < BudgetDtlPanel_store.getCount() ; i++) {
                    record = BudgetDtlPanel_store.getAt(i);
                    dSourceOfFunds = record.get('FSourceOfFunds');
                    amount = record.get('FAmount');
                    budgetmoney = record.get('FBudgetAmount')
                    if (amount == undefined) {
                        amount = 0;
                    }
                    fundName = record.get('FSourceOfFunds_EXName');

                    if (funds[dSourceOfFunds]) {
                        funds[dSourceOfFunds] = { Amount: funds[dSourceOfFunds].Amount + amount, Name: fundName }; //funds[dSourceOfFunds] + amount;
                    } else {
                        funds[dSourceOfFunds] = { Amount: amount, Name: fundName };
                    }

                    projectAmount = projectAmount + amount;
                    budgetAmount = budgetAmount + budgetmoney;
                }
                mainPanel_form.queryById("FProjAmount")&&mainPanel_form.queryById("FProjAmount").setValue(projectAmount);
                mainPanel_form.queryById("FBudgetAmount")&&mainPanel_form.queryById("FBudgetAmount").setValue(budgetAmount);
                //同步更新
                for (var v in funds) {
                    find = FundApplPanel_store.findExact("FSourceOfFunds", v)
                    if (find == -1) {
                        FundApplPanel_store.insert(FundApplPanel_store.getCount(), { PhId: "", MstPhid: "", FSourceOfFunds: v, FAmount: funds[v].Amount, FSourceOfFunds_EXName: funds[v].Name });
                    }
                    else {
                        record = FundApplPanel_store.getAt(find);
                        record.set("FAmount", funds[v].Amount);
                    }
                }

                //同步删除：把预算明细中不存在对应资金来源的数据，在资金申请中删除
                for (var i = 0; i < FundApplPanel_store.getCount() ; i++)
                {
                    v = FundApplPanel_store.getAt(i).get("FSourceOfFunds");
                    find = BudgetDtlPanel_store.findExact("FSourceOfFunds", v);
                    if (find == -1) {
                        FundApplPanel_store.removeAt(i);
                        i--;
                    }
                }
                FundApplPanel_grid.view.refresh();

            }

            //通用帮助设置条件
            //按当前操作员过滤申报单位
            mainPanel_form.queryById("FDeclarationUnit")&&mainPanel_form.queryById("FDeclarationUnit").setOutFilter({ userid: $appinfo.userID });

            if (mainPanel_form.queryById("FDeclarationUnit")) {
                //按当前申报单位过滤预算部门、支出类别
                mainPanel_form.queryById("FDeclarationUnit").on("helpselected", function (obj) {
                    if (memoWinShow == true) {   //批注界面打开的，则为批注时触发
                        var selection = Memogrid.getSelectionModel().getSelection();
                        mainPanel_form.queryById("FDeclarationUnit").setValue(selection[0].get('BeforeCode'));
                        var codectl = [mainPanel_form.queryById('FDeclarationUnit')]; //
                        BatchBindCombox(codectl);
                        selection[0].set('AfterCode', obj.code);//代码
                        selection[0].set('AfterName', obj.name);//名称
                        return false;
                    }

                    var unitCode = obj.code;
                    var filter, filter2,filter3;
                    if (unitCode) {
                        filter = "(Z_QTDYGX.dwdm='" + $appinfo.logid + "' and Z_QTDYGX.dylx = '97' and  fg_orglist.ocode like '" + unitCode + "%')";
                        filter2 = "(Z_QTDYGX2.DEF_STR1='" + unitCode + "')";
                        filter3="(z_qtvenue.orgcode='" + unitCode + "')";
                    } else {
                        Ext.MessageBox.alert('请先选择申报单位');
                        return;
                    }
                    //选择组织之后部门重置
                    mainPanel_form.queryById("FBudgetDept")&&mainPanel_form.queryById("FBudgetDept").setValue("");
                    //预算单位
                    if (filter) {
                        mainPanel_form.queryById("FBudgetDept")&&mainPanel_form.queryById("FBudgetDept").setClientSqlFilter(filter);
                    }

                    //支出类别
                    if (filter2) {
                        mainPanel_form.queryById("FExpenseCategory")&&mainPanel_form.queryById("FExpenseCategory").setClientSqlFilter(filter2);
                    }
                    if (filter3) {
                        mainPanel_form.queryById("FVenue")&&mainPanel_form.queryById("FVenue").setClientSqlFilter(filter3);
                    }
                    //获得阈值
                    //getProjectThreshold(unitCode);


                });
            }
            if (mainPanel_form.queryById("FBudgetDept")) {
                mainPanel_form.queryById("FBudgetDept").on("beforetriggerclick", function (str) {
                    //var FDeclarationUnit = Ext.getCmp('FDeclarationUnit').getValue();
                    var unitCode = mainPanel_form.queryById("FDeclarationUnit").getValue();
                    var filter, filter2;
                    if (unitCode) {
                        filter = "(Z_QTDYGX.dwdm='" + $appinfo.logid + "' and Z_QTDYGX.dylx = '97' and fg_orglist.ocode like '" + unitCode + "%')";
                        filter2 = "(Z_QTDYGX2.DEF_STR1='" + unitCode + "')";
                    }
                    else {
                        Ext.MessageBox.alert('提示', '请先选择申报单位');
                        return false;
                    }

                    //预算单位
                    if (filter) {
                        mainPanel_form.queryById("FBudgetDept").setClientSqlFilter(filter);
                    }
                    //支出类别
                    if (filter2) {
                        mainPanel_form.queryById("FExpenseCategory") && mainPanel_form.queryById("FExpenseCategory").setClientSqlFilter(filter2);
                    }

                });


                mainPanel_form.queryById("FBudgetDept").on("helpselected", function (obj) {
                    if (memoWinShow == true) {   //批注界面打开的，则为批注时触发
                        var selection = Memogrid.getSelectionModel().getSelection();
                        mainPanel_form.queryById("FBudgetDept").setValue(selection[0].get('BeforeCode'));
                        var codectl = [mainPanel_form.queryById('FBudgetDept')]; //
                        BatchBindCombox(codectl);
                        selection[0].set('AfterCode', obj.code);//代码
                        selection[0].set('AfterName', obj.name);//名称
                        return false;
                    }

                });
            }
            if (mainPanel_form.queryById("FExpenseCategory")) {
                //项目类型
                mainPanel_form.queryById("FExpenseCategory").on("beforetriggerclick", function (str) {

                    var unitCode = mainPanel_form.queryById("FDeclarationUnit").getValue();
                    var filter2;
                    if (unitCode) {
                        filter2 = "(Z_QTDYGX2.DEF_STR1='" + unitCode + "')";
                    }
                    else {
                        Ext.MessageBox.alert('提示', '请先选择申报单位');
                        return false;
                    }
                    //支出类别
                    if (filter2) {
                        mainPanel_form.queryById("FExpenseCategory").setClientSqlFilter(filter2);
                    }

                });

                //是否显示天数、人数、单价
                mainPanel_form.queryById("FExpenseCategory").on("helpselected", function (obj) {

                    if (memoWinShow == true) {   //批注界面打开的，则为批注时触发
                        var selection = Memogrid.getSelectionModel().getSelection();
                        mainPanel_form.queryById("FExpenseCategory").setValue(selection[0].get('BeforeCode'));
                        var codectl = [mainPanel_form.queryById('FExpenseCategory')]; //
                        BatchBindCombox(codectl);
                        selection[0].set('AfterCode', obj.code);//代码
                        selection[0].set('AfterName', obj.name);//名称
                        return false;
                    }

                    //判断项目类型是否是末级组织
                    var expenseCategoryCode = mainPanel_form.queryById("FExpenseCategory").getValue();
                    var IsEnd=true;
                    //debugger;
                    Ext.Ajax.request({
                        params: { "expenseCategoryCode": expenseCategoryCode },
                        url: C_ROOT + 'GQT/QT/ExpenseCategory/IfLastStage',
                        async:false,
                        success: function (response) {
                            var resp = Ext.JSON.decode(response.responseText);
                            //debugger;
                            if (resp != null && resp != undefined) {
                                if (resp.Data.length > 0) {
                                    mainPanel_form.queryById("FExpenseCategory").setValue("");
                                    BudgetDtlPanel_grid.getColumn('FQty').hide();
                                    BudgetDtlPanel_grid.getColumn('FQty2').hide();
                                    BudgetDtlPanel_grid.getColumn('FPrice').hide();
                                    BudgetDtlPanel_grid.getColumn('FNum').hide();
                                    BudgetDtlPanel_grid.getColumn('FAmount').readOnly = false;
                                    if (!workflowPanel&&otype == $Otype.VIEW) {

                                        BudgetDtlPanel_grid.getColumn('FAmount').readOnly = true;
                                    }
                                    Ext.MessageBox.alert("提示", '请选择末级项目类型');
                                    IsEnd=false;
                                    return false;
                                }
                            }
                        }

                    });
                    if(IsEnd==true){
                        var unitCode = mainPanel_form.queryById("FDeclarationUnit").getValue();
                        var xmCOde = obj.code;
                        getProjectThreshold(unitCode, xmCOde); //获取阈值
                        //debugger;
                        Ext.Ajax.request({
                            params: { "Dylx": '08', "DefStr1": unitCode },
                            url: C_ROOT + 'GQT/QT/CorrespondenceSettings2/GetCorrespondenceSettings2ListbyRelation',
                            success: function (response) {
                                var resp = Ext.JSON.decode(response.responseText);
                                if (resp != null && resp != undefined) {
                                    for (var i = 0; i < resp.Record.length; i++) {
                                        var recordData = resp.Record[i];
                                        if (recordData.Dydm == xmCOde) {
                                            tempData = recordData;
                                            if (recordData.DefStr2 == "0") {
                                                BudgetDtlPanel_grid.getColumn('FQty').hide();
                                                BudgetDtlPanel_grid.getColumn('FQty2').hide();
                                                BudgetDtlPanel_grid.getColumn('FPrice').hide();
                                                BudgetDtlPanel_grid.getColumn('FNum').hide();
                                                BudgetDtlPanel_grid.getColumn('FAmount').readOnly = false;

                                                if (!workflowPanel&&otype == $Otype.VIEW) {

                                                    BudgetDtlPanel_grid.getColumn('FAmount').readOnly = true;
                                                }
                                            }
                                            if (recordData.DefStr2 == "1") {
                                                BudgetDtlPanel_grid.getColumn('FQty').show();
                                                BudgetDtlPanel_grid.getColumn('FQty2').show();
                                                BudgetDtlPanel_grid.getColumn('FPrice').show();
                                                BudgetDtlPanel_grid.getColumn('FNum').hide();
                                                //BudgetDtlPanel_grid.getColumn('FPrice').readOnly = true;
                                                // BudgetDtlPanel_grid.getColumn('FAmount').readOnly = true;
                                                BudgetDtlPanel_grid.getColumn('FQty').readOnly = false;
                                                BudgetDtlPanel_grid.getColumn('FQty2').readOnly = false;
                                                BudgetDtlPanel_grid.getColumn('FPrice').readOnly = false;
                                                for (var j = 0; j < BudgetDtlPanel_store.getCount(); j++) {
                                                    BudgetDtlPanel_store.getAt(j).set("FPrice", recordData.DefStr3);
                                                }
                                                if (otype == $Otype.VIEW) {

                                                    BudgetDtlPanel_grid.getColumn('FQty').readOnly = true;
                                                    BudgetDtlPanel_grid.getColumn('FQty2').readOnly = true;
                                                    BudgetDtlPanel_grid.getColumn('FPrice').readOnly = true;
                                                }else{
                                                    Ext.Ajax.request({
                                                        params: { 'BZ': "G6HBLKZPrice" ,'OrgCode':unitCode},
                                                        url: C_ROOT + 'GQT/QT/QTControlSet/GetQTControlByBZAndOrg',
                                                        async: false,
                                                        success: function (response) {
                                                            var resp = Ext.JSON.decode(response.responseText);
                                                            if (resp.Status === "success") {
                                                                var QTControlSet = resp.Msg;
                                                                if (QTControlSet == "true") {
                                                                    
                                                                } else {
                                                                    BudgetDtlPanel_grid.getColumn('FPrice').readOnly = true;
                                                                }

                                                            }
                                                        }
                                                    });
                                                }
                                                MemoStore.push(["FQty", "天数(明细表)"]);
                                                MemoStore.push(["FQty2", "人数(明细表)"]);
                                                MemoStore.push(["FPrice", "单价(明细表)"]);
                                            }
                                            if (recordData.DefStr2 == "2") {
                                                BudgetDtlPanel_grid.getColumn('FQty').hide();
                                                BudgetDtlPanel_grid.getColumn('FQty2').hide();
                                                BudgetDtlPanel_grid.getColumn('FPrice').show();
                                                BudgetDtlPanel_grid.getColumn('FNum').show();
                                                BudgetDtlPanel_grid.getColumn('FAmount').readOnly = true;
                                                BudgetDtlPanel_grid.getColumn('FNum').readOnly = false;
                                                BudgetDtlPanel_grid.getColumn('FPrice').readOnly = false;
                                                for (var j = 0; j < BudgetDtlPanel_store.getCount(); j++) {
                                                    BudgetDtlPanel_store.getAt(j).set("FPrice", recordData.DefStr3);
                                                }
                                                if (otype == $Otype.VIEW) {

                                                    BudgetDtlPanel_grid.getColumn('FPrice').readOnly = true;
                                                    BudgetDtlPanel_grid.getColumn('FNum').readOnly = true;
                                                }
                                                MemoStore.push(["FNum", "数量(明细表)"]);
                                                MemoStore.push(["FPrice", "单价(明细表)"]);
                                            }
                                        }
                                    }
                                }
                                //debugger;
                            }
                        });
                    }
                });
            }

            //编辑人数、天数的时候自动求总金额
            BudgetDtlPanel_grid.on('edit', function (editor, context) {
                if (context.field == "FQty") {
                    if(context.record.data.FQty-0<0){
                        context.record.data.FQty = context.originalValue;
                        Ext.MessageBox.alert("提示", '不能为负!');
                        this.getView().refresh(true);
                    }else{
                        context.record.data.FAmount = context.record.data.FQty * context.record.data.FQty2 * context.record.data.FPrice;
                        this.getView().refresh(true);
                        syncFundAppl();
                    }
                }
                if (context.field == "FQty2") {
                    if(context.record.data.FQty2-0<0){
                        context.record.data.FQty2 = context.originalValue;
                        Ext.MessageBox.alert("提示", '不能为负!');
                        this.getView().refresh(true);
                    }else{
                        context.record.data.FAmount = context.record.data.FQty * context.record.data.FQty2 * context.record.data.FPrice;
                        this.getView().refresh(true);
                        syncFundAppl();
                    }
                }
                if (context.field == "FAmount") {
                    syncFundAppl();
                }
                if (context.field == "FName") {
                    if (context.record.data.FIfPurchase == "1") {
                        context.record.data.FName = context.originalValue;
                        Ext.MessageBox.alert("提示", '集中采购时不能修改明细项目名称!');
                        this.getView().refresh(true);
                    }

                }
                if (context.field == "FNum") {
                    if(context.record.data.FNum-0<0){
                        context.record.data.FNum = context.originalValue;
                        Ext.MessageBox.alert("提示", '不能为负!');
                        this.getView().refresh(true);
                    }else{
                        context.record.data.FAmount = context.record.data.FNum * context.record.data.FPrice;
                        this.getView().refresh(true);
                        syncFundAppl();
                    }
                }
                if (context.field == "FPrice") {//只有数量*单价的时候 单价是可以改变的
                    if(context.record.data.FPrice-0<0){
                        context.record.data.FPrice = context.originalValue;
                        Ext.MessageBox.alert("提示", '不能为负!');
                        this.getView().refresh(true);
                    }else{
                        if(editor.grid.getColumn('FQty').hidden){
                            context.record.data.FAmount = context.record.data.FNum * context.record.data.FPrice;
                        }else{
                            context.record.data.FAmount = context.record.data.FQty * context.record.data.FQty2 * context.record.data.FPrice;
                        }
                        this.getView().refresh(true);
                        syncFundAppl();
                    }
                }
            });



            //实施计划的实施内容长度不能超过200
            ImplPlanPanel_grid.on('edit', function (editor, context) {
                if (context.field == "FImplContent" && context.record.data.FImplContent.length > 100) {
                    //debugger;
                    Ext.MessageBox.alert("提示", '实施内容长度不能超过100');
                    context.record.data.FImplContent = context.originalValue;
                    this.getView().refresh(true);
                }
            });
            if (mainPanel_form.queryById("FIfPerformanceAppraisal")) {
                mainPanel_form.queryById("FIfPerformanceAppraisal").on("helpselected", function (str) {

                    if (memoWinShow == true) {   //批注界面打开的，则为批注时触发
                        var selection = Memogrid.getSelectionModel().getSelection();
                        mainPanel_form.queryById("FIfPerformanceAppraisal").setValue(selection[0].get('BeforeCode'));
                        var codectl = [mainPanel_form.queryById('FIfPerformanceAppraisal')]; //
                        BatchBindCombox(codectl);
                        selection[0].set('AfterCode', obj.code);//代码
                        selection[0].set('AfterName', obj.name);//名称
                        return false;
                    }

                    var Code = str.code;
                    if (Code == 2) {
                        if((mainPanel_form.queryById("FTemporary")&&mainPanel_form.queryById("FTemporary").getValue()=='1')||(mainPanel_form.queryById("FZcType")&&(mainPanel_form.queryById("FZcType").getValue()=='2'||mainPanel_form.queryById("FZcType").getValue()=='3'))){
                            //临时项目、基本支出项目不需要判断绩效阈值
                        }else{
                        //检查阈值
                            if (!controlProjectProjectThreshold()) {
                                return false;
                            }
                        }

                        var iyi = mainPanel_form.queryById("FPerformEvalType");
                        mainPanel_form.queryById("FIfKeyEvaluation").setValue(2);//绩效为否时,重点评价也为否
                        mainPanel_form.queryById("FPerformType").setValue("");
                        mainPanel_form.queryById("FPerformEvalType").setValue("");

                        //PerformTargetPanel_store.removeAll(); //清空绩效目标分解

                        hidePerformTargetTab(true, true);
                    }
                    else if (Code == 1) {
                        hidePerformTargetTab(false, true);
                        Ext.Ajax.request({
                            params: { "helpid": 'GHPerformEvalType', "ORMMode": "true" },
                            url: C_ROOT + 'SUP/RichHelp/GetHelpList',
                            success: function (response) {
                                var resp = Ext.JSON.decode(response.responseText);
                                var data = {
                                    FCode: resp.Record[0].FCode,
                                    FName: resp.Record[0].FName,
                                    PhId: resp.Record[0].PhId
                                };
                                var model = {
                                    data: data,
                                    row: data
                                }
                                var iiouu = mainPanel_form.queryById("FPerformEvalType");
                                //mainPanel_form.queryById("FPerformEvalType").valueModels.push(model);
                                mainPanel_form.queryById("FPerformEvalType").defValue = resp.Record[0].FCode;
                                mainPanel_form.queryById("FPerformEvalType").rawValue = resp.Record[0].FName;
                                mainPanel_form.queryById("FPerformEvalType").setValue(resp.Record[0].FName);
                            }
                        });

                    }
                });

            }
            if (mainPanel_form.queryById("FIfKeyEvaluation")) {
                //重点评价只有在绩效评价为是是才能选是
                mainPanel_form.queryById("FIfKeyEvaluation").on("beforetriggerclick", function () {

                    //var FDeclarationUnit = Ext.getCmp('FDeclarationUnit').getValue();
                    var FIfPerformanceAppraisal = mainPanel_form.queryById("FIfPerformanceAppraisal").getValue();
                    if (FIfPerformanceAppraisal != 1) {
                        Ext.MessageBox.alert("提示", '请先选择绩效评价');
                        return false;
                    }
                });
            }
            if (BudgetDtlPanel_grid.getColumn('FBudgetAccounts_EXName').getEditor()) {
                //预算科目过滤
                // BudgetDtlPanel_grid.getColumn("FBudgetAccounts_EXName").getEditor().setClientSqlFilter("kmlb='1'");
                BudgetDtlPanel_grid.getColumn('FBudgetAccounts_EXName').getEditor().on("beforetriggerclick", function (str) {
                    //var FDeclarationUnit = Ext.getCmp('FDeclarationUnit').getValue();
                    var FDeclarationUnit = mainPanel_form.queryById("FDeclarationUnit").getValue();
                    if (!FDeclarationUnit) {
                        Ext.MessageBox.alert("提示", '申报单位不能为空');
                        return false;
                    }
                    var filter = "(Z_QTDYGX.DEF_STR1='" + FDeclarationUnit + "' and Z_QTYSKM.KMLB='1')";
                    BudgetDtlPanel_grid.getColumn('FBudgetAccounts_EXName').getEditor().setClientSqlFilter(filter);

                });


                BudgetDtlPanel_grid.getColumn('FBudgetAccounts_EXName').getEditor().on('helpselected', function (obj) {


                    if (memoWinShow == true) {   //批注界面打开的，则为批注时触发

                        Ext.Ajax.request({
                            params: { "budgetAccountsCode": obj.code },
                            url: C_ROOT + 'GQT/QT/BudgetAccounts/IfLastStage',
                            success: function (response) {
                                var resp = Ext.JSON.decode(response.responseText);
                                //debugger;
                                if (resp != null && resp != undefined) {
                                    if (resp.Data.length > 0) {
                                        Ext.MessageBox.alert("提示", '请选择末级预算科目');
                                        return false;
                                    } else {
                                        var selection = Memogrid.getSelectionModel().getSelection();
                                        selection[0].set('AfterCode', obj.code);//代码
                                        selection[0].set('AfterName', obj.name);//名称
                                        return false;
                                    }
                                }
                            }

                        });
                        //var selection = Memogrid.getSelectionModel().getSelection();
                        //selection[0].set('AfterCode', obj.code);//代码
                        //selection[0].set('AfterName', obj.name);//名称
                        return false;
                    }

                    var data = BudgetDtlPanel_grid.getSelectionModel().getSelection();
                    //判断预算科目是否是末级

                    Ext.Ajax.request({
                        params: { "budgetAccountsCode": obj.code },
                        url: C_ROOT + 'GQT/QT/BudgetAccounts/IfLastStage',
                        success: function (response) {
                            var resp = Ext.JSON.decode(response.responseText);
                            //debugger;
                            if (resp != null && resp != undefined) {
                                if (resp.Data.length > 0) {
                                    data[0].set('FBudgetAccounts', '');
                                    data[0].set('FBudgetAccounts_EXName', '');
                                    Ext.MessageBox.alert("提示", '请选择末级预算科目');
                                } else {
                                    //当一级项目只允许对应一个预算科目及支出渠道时
                                    if (YskmIfControl == '2' && BudgetDtlPanel_store.getCount() > 0) {
                                        for (var i = 0; i < BudgetDtlPanel_store.getCount(); i++) {
                                            BudgetDtlPanel_store.getAt(i).set('FBudgetAccounts', obj.code);
                                            BudgetDtlPanel_store.getAt(i).set('FBudgetAccounts_EXName', obj.name);
                                        }
                                    } else {
                                        data[0].set('FBudgetAccounts', obj.code);
                                        data[0].set('FBudgetAccounts_EXName', obj.name);
                                    }
                                }
                            }
                        }

                    });
                });
            }
            if (BudgetDtlPanel_grid.getColumn('FQtZcgnfl_EXName').getEditor()) {
                //支出功能分类科目是否末级
                BudgetDtlPanel_grid.getColumn('FQtZcgnfl_EXName').getEditor().on('helpselected', function (obj) {

                    if (memoWinShow == true) {   //批注界面打开的，则为批注时触发

                        Ext.Ajax.request({
                            params: { "QtZcgnflCode": obj.code },
                            url: C_ROOT + 'GQT/QT/QtZcgnfl/IfLastStage',
                            success: function (response) {
                                var resp = Ext.JSON.decode(response.responseText);
                                //debugger;
                                if (resp != null && resp != undefined) {
                                    if (resp.Data.length > 0) {
                                        Ext.MessageBox.alert("提示", '请选择末级支出功能分类科目');
                                        return false;
                                    } else {
                                        var selection = Memogrid.getSelectionModel().getSelection();
                                        selection[0].set('AfterCode', obj.code);//代码
                                        selection[0].set('AfterName', obj.name);//名称
                                        return false;
                                    }
                                }
                            }

                        });

                        //var selection = Memogrid.getSelectionModel().getSelection();
                        //selection[0].set('AfterCode', obj.code);//代码
                        //selection[0].set('AfterName', obj.name);//名称
                        return false;
                    }

                    var data = BudgetDtlPanel_grid.getSelectionModel().getSelection();

                    Ext.Ajax.request({
                        params: { "QtZcgnflCode": obj.code },
                        url: C_ROOT + 'GQT/QT/QtZcgnfl/IfLastStage',
                        success: function (response) {
                            var resp = Ext.JSON.decode(response.responseText);
                            //debugger;
                            if (resp != null && resp != undefined) {
                                if (resp.Data.length > 0) {
                                    data[0].set('FQtZcgnfl', '');
                                    data[0].set('FQtZcgnfl_EXName', '');
                                    Ext.MessageBox.alert("提示", '请选择末级支出功能分类科目');
                                } else {
                                    data[0].set('FQtZcgnfl', obj.code);
                                    data[0].set('FQtZcgnfl_EXName', obj.name);
                                }
                            }
                        }

                    });
                });
            }
            if (BudgetDtlPanel_grid.getColumn('FExpensesChannel_EXName').getEditor()) {
                //支出渠道
                BudgetDtlPanel_grid.getColumn('FExpensesChannel_EXName').getEditor().on("beforetriggerclick", function (str) {
                    //var FDeclarationUnit = Ext.getCmp('FDeclarationUnit').getValue();
                    var FDeclarationUnit = mainPanel_form.queryById("FDeclarationUnit").getValue();
                    if (!FDeclarationUnit) {
                        Ext.MessageBox.alert("提示", '申报单位不能为空');
                        return false;
                    }
                    BudgetDtlPanel_grid.getColumn('FExpensesChannel_EXName').getEditor().setOutFilter({ DWDM: FDeclarationUnit });

                });

                BudgetDtlPanel_grid.getColumn('FExpensesChannel_EXName').getEditor().on('helpselected', function (obj) {

                    if (memoWinShow == true) {   //批注界面打开的，则为批注时触发
                        var selection = Memogrid.getSelectionModel().getSelection();
                        selection[0].set('AfterCode', obj.code);//代码
                        selection[0].set('AfterName', obj.name);//名称
                        return false;
                    }

                    //当一级项目只允许对应一个预算科目及支出渠道时
                    if (YskmIfControl == '2' && BudgetDtlPanel_store.getCount() > 0) {
                        for (var i = 0; i < BudgetDtlPanel_store.getCount(); i++) {
                            BudgetDtlPanel_store.getAt(i).set('FExpensesChannel', obj.code);
                            BudgetDtlPanel_store.getAt(i).set('FExpensesChannel_EXName', obj.name);
                        }
                    } else {
                        var data = BudgetDtlPanel_grid.getSelectionModel().getSelection();
                        data[0].set('FExpensesChannel', obj.code);
                        data[0].set('FExpensesChannel_EXName', obj.name);
                    }

                });
            }
            if (mainPanel_form.queryById("FPerformType")) {
                //绩效项目类型
                mainPanel_form.queryById("FPerformType").on('beforetriggerclick', function (obj) {
                    var FIfPerformanceAppraisal = mainPanel_form.queryById("FIfPerformanceAppraisal").getValue();
                    if (FIfPerformanceAppraisal != 1) {
                        Ext.MessageBox.alert("提示", '请先选择绩效评价');
                        return false;
                    }
                    var typecode = mainPanel_form.queryById("FPerformType").getValue();
                    if (typecode) {
                        mainPanel_form.queryById("FPerformType").setClientSqlFilter("a.f_code<>" + typecode);
                    }
                });

                mainPanel_form.queryById("FPerformType").on("helpselected", function (obj) {

                    if (memoWinShow == true) {   //批注界面打开的，则为批注时触发
                        var selection = Memogrid.getSelectionModel().getSelection();
                        mainPanel_form.queryById("FPerformType").setValue(selection[0].get('BeforeCode'));
                        var codectl = [mainPanel_form.queryById('FPerformType')]; //
                        BatchBindCombox(codectl);
                        selection[0].set('AfterCode', obj.code);//代码
                        selection[0].set('AfterName', obj.name);//名称
                        return false;
                    }

                    var parentCode = obj.data.f_parentcode;
                    if (!parentCode) {
                        Ext.MessageBox.alert("提示", "请选择二级类型");
                        return false;
                    }

                    //缓存类型级别，在指标选择时控制层次
                    performTargetTypeLevel1 = parentCode;
                    performTargetTypeLevel2 = obj.data.f_code;

                    getPerformTarget(performTargetTypeLevel2, true);
                });
            }

            if (PerformTargetPanel_grid.getColumn("FTargetCode").getEditor()) {
                //过滤指标
                PerformTargetPanel_grid.getColumn("FTargetCode").getEditor().on('beforetriggerclick', function (obj) {
                    if (!performTargetTypeLevel2) {
                        Ext.MessageBox.alert('提示', "请选择绩效项目类型");
                        return false;
                    }

                    //过滤掉已经选择的指标
                    var codes = "", code;
                    for (var i = 0; i < PerformTargetPanel_store.getCount(); i++) {
                        code = PerformTargetPanel_store.getAt(i).get('FTargetCode');
                        if (code) {
                            if (codes == "") {
                                codes = "'" + code + "'";
                            }
                            else {
                                codes = codes + ",'" + code + "'";
                            }
                        }
                    }

                    var sqlFilter = "Z_QTPerformEvalTarget.f_TargetTypeCode='" + performTargetTypeLevel2 + "'";
                    if (codes) {
                        sqlFilter = sqlFilter + " and Z_QTPerformEvalTarget.f_TargetCode not in(" + codes + ")";
                    }
                    PerformTargetPanel_grid.getColumn("FTargetCode").getEditor().setClientSqlFilter(sqlFilter);
                });
            }


            BudgetDtlPanel_grid.getColumn('FIfPurchase').renderer = function (val) {
                switch (val) {
                    case 1:
                        return "是";
                    case 2:
                        return "否";
                }
            };
            if (BudgetDtlPanel_grid.getColumn('FIfPurchase').getEditor()) {
                BudgetDtlPanel_grid.getColumn('FIfPurchase').getEditor().on('helpselected', function (obj) {
                    if (obj.code == 1) {
                        var data = BudgetDtlPanel_grid.getSelectionModel().getSelection();
                        data[0].set('FIfPurchase', obj.code);
                        budgetDtlFName = data[0].data.FName;
                        ngToolbar.get('purchase').fireEvent('click');
                    }

                });
            }
            //实施计划开始结束时间修改
            mainPanel_form.queryById("FStartDate").on("select", function (str) {
                var data = str.rawValue;
                for (var i = 0; i < ImplPlanPanel_store.getCount(); i++) {
                    //if (!ImplPlanPanel_store.getAt(i).get("FStartDate")) {
                        ImplPlanPanel_store.getAt(i).set('FStartDate', data);
                    //}
                }
            });

            mainPanel_form.queryById("FEndDate").on("select", function (str) {
                var data = str.rawValue;
                for (var i = 0; i < ImplPlanPanel_store.getCount(); i++) {
                    //if (!ImplPlanPanel_store.getAt(i).get("FEndDate")) {
                        ImplPlanPanel_store.getAt(i).set('FEndDate', data);
                    //}
                }
            });

            //延续项目显示执行年度
            /*mainPanel_form.queryById("FProjAttr").on("select", function (str) {
                if (mainPanel_form.queryById("FGoYear")) {
                    var data = str.value;
                    if (data == "1") {
                        mainPanel_form.queryById("FGoYear").setValue(dataYear);
                        mainPanel_form.queryById("FGoYear").show();
                    } else {
                        mainPanel_form.queryById("FGoYear").setValue('');
                        mainPanel_form.queryById("FGoYear").hide();
                    }
                }
            });*/
            //2019.11.29 改成 存续期限关联执行年度
            mainPanel_form.queryById("FDuration").on("select", function (str) {
                if (mainPanel_form.queryById("FGoYear")) {
                    var data = str.value;
                    if (data != "1" && data != "2") {
                        mainPanel_form.queryById("FGoYear").setValue(dataYear);
                        mainPanel_form.queryById("FGoYear").show();
                    } else {
                        mainPanel_form.queryById("FGoYear").setValue('');
                        mainPanel_form.queryById("FGoYear").hide();
                    }
                }
            });


            if (PerformTargetPanel_grid.getColumn("FTargetTypeCode_EXName").getEditor()) {
                //过滤指标类型
                PerformTargetPanel_grid.getColumn("FTargetTypeCode_EXName").getEditor().on('beforetriggerclick', function (obj) {
                    var sqlFilter = "f_code='" + performTargetTypeLevel2 + "'";
                    PerformTargetPanel_grid.getColumn("FTargetTypeCode_EXName").getEditor().setClientSqlFilter(sqlFilter); //只能选同样的二级类别
                });
            }


            var MemoWin;
            Ext.define('MemoPanelModel', {
                extend: 'Ext.data.Model',
                fields: [
                    {
                        "name": "PhId",
                        "type": "string",
                        "mapping": "PhId"
                    },
                    {
                        "name": "Memophid",
                        "type": "string",
                        "mapping": "Memophid"
                    },
                    {
                        "name": "UserCode",
                        "type": "string",
                        "mapping": "UserCode"
                    },
                    {
                        "name": "UserName",
                        "type": "string",
                        "mapping": "UserName"
                    },
                    {
                        "name": "MemoTime",
                        "type": "date",
                        "mapping": "MemoTime"
                    },
                    {
                        "name": "IP",
                        "type": "string",
                        "mapping": "IP"
                    },
                    {
                        "name": "MemoCode",
                        "type": "string",
                        "mapping": "MemoCode"
                    },
                    {
                        "name": "MenoName",
                        "type": "string",
                        "mapping": "MenoName"
                    },
                    {
                        "name": "MemoArea",
                        "type": "string",
                        "mapping": "MemoArea"
                    },
                    {
                        "name": "BeforeCode",
                        "type": "string",
                        "mapping": "BeforeCode"
                    },
                    {
                        "name": "BeforeName",
                        "type": "string",
                        "mapping": "BeforeName"
                    },
                    {
                        "name": "AfterCode",
                        "type": "string",
                        "mapping": "AfterCode"
                    },
                    {
                        "name": "AfterName",
                        "type": "string",
                        "mapping": "AfterName"
                    },
                    {
                        "name": "IfChoose",
                        "type": "string",
                        "mapping": "IfChoose"
                    },
                    {
                        "name": "FProjCode",
                        "type": "string",
                        "mapping": "FProjCode"
                    },
                    {
                        "name": "FProjName",
                        "type": "string",
                        "mapping": "FProjName"
                    },
                    {
                        "name": "TabName",
                        "type": "string",
                        "mapping": "TabName"
                    },
                    {
                        "name": "DEFSTR1",
                        "type": "string",
                        "mapping": "DEFSTR1"
                    },
                    {
                        "name": "DEFSTR2",
                        "type": "string",
                        "mapping": "DEFSTR2"
                    },
                    {
                        "name": "DEFSTR3",
                        "type": "string",
                        "mapping": "DEFSTR3"
                    },
                    {
                        "name": "DEFINT1",
                        "type": "string",
                        "mapping": "DEFINT1"
                    },
                    {
                        "name": "DEFINT2",
                        "type": "string",
                        "mapping": "DEFINT2"
                    },
                    {
                        "name": "DEFNUM1",
                        "type": "float",
                        "mapping": "DEFNUM1"
                    },
                    {
                        "name": "DEFNUM2",
                        "type": "float",
                        "mapping": "DEFNUM2"
                    },
                    {
                        "name": "DEFDate1",
                        "type": "date",
                        "mapping": "DEFDate1"
                    },
                    {
                        "name": "DEFDate2",
                        "type": "date",
                        "mapping": "DEFDate2"
                    },

                    {
                        "name": "NgRecordVer",
                        "type": "int",
                        "mapping": "NgRecordVer"
                    }
                ]
            });
            var MemoPanelStore = Ext.create('Ext.ng.JsonStore', {
                model: 'MemoPanelModel',
                async: false,
                autoLoad: false,
                url: C_ROOT + 'GQT/QT/QTEditMemo/GetQTEditMemoList'
            })

            var pagingbar = Ext.create('Ext.ng.PagingBar', {
                store: MemoPanelStore
            });

            var Memogrid = Ext.create('Ext.ng.GridPanel', {
                region: 'west',
                border: false,
                frame: true,
                width: 1000,
                store: MemoPanelStore,
                columnLines: true,
                stateful: true,
                stateId: 'd3ec76d5-fc15-2252-ae01-0433961de23b',
                buskey: 'PhId', //对应的子表主键属性
                otype: memoType,
                viewConfig: {
                    forceFit: true,
                    scrollOffset: 0
                },
                bbar: [pagingbar],
                plugins: [
                    Ext.create('Ext.grid.plugin.CellEditing', {
                        clicksToEdit: 1   //单击编辑，单元格修改
                        //autoEncode: false  //不解析成html
                    })
                ],
                selModel: Ext.create('Ext.selection.CheckboxModel', { mode: "SIMPLE" }),
                columns: [
                    {
                        "xtype": "rownumberer",
                        "stateId": "lineid",
                        "text": "行号",
                        "width": 35
                    }, {
                        "LangKey": "PhId",
                        "dataIndex": "PhId",
                        "width": 51,
                        "header": "主键",
                        "hidden": true
                    },
                    {
                        "LangKey": "Memophid",
                        "dataIndex": "Memophid",
                        "width": 100,
                        "header": "批注单据主键",
                        "hidden": true
                    },
                    {
                        "LangKey": "UserCode",
                        "dataIndex": "UserCode",
                        "width": 100,
                        "header": "用户编码",
                        "hidden": memoGridField
                    },
                    {
                        "LangKey": "UserName",
                        "dataIndex": "UserName",
                        "width": 100,
                        "header": "用户名称",
                        "hidden": memoGridField
                    },
                    {
                        "LangKey": "IP",
                        "dataIndex": "IP",
                        "width": 120,
                        "header": "用户ip",
                        "hidden": memoGridField
                    },
                    {
                        "LangKey": "MemoTime",
                        "dataIndex": "MemoTime",
                        "width": 150,
                        "hidden": memoGridField,
                        "header": "批注时间",
                        "editor": {
                            "xtype": "ngDate"
                        }
                    },

                    {
                        "LangKey": "MemoCode",
                        "dataIndex": "MemoCode",
                        "width": 100,
                        "header": "批注字段代码",
                        "hidden": true
                    },
                    {
                        "LangKey": "MenoName",
                        "dataIndex": "MenoName",
                        "width": 300,
                        "header": "批注字段",
                        "editor": {
                            "xtype": "ngComboBox",
                            "valueField": "code",
                            "displayField": "name",
                            "QueryMode": "local",
                            "valueType": "string",
                            "store": MemoStore,
                            listeners: {

                                'select': function (record, index, eOpts) {

                                    var code = index[0].data.field1;
                                    if (mainHelpSelected.indexOf(code) >= 0) {
                                        mainPanel_form.queryById(code).onTriggerClick();
                                    } else if (dtlHelpSelected.indexOf(code) >= 0) {
                                        BudgetDtlPanel_grid.getColumn(code + '_EXName').getEditor().onTriggerClick();
                                    } else {
                                        Ext.MessageBox.alert("提示", '该批注内容仅支持手动输入!');
                                        return false;
                                    }

                                    //var selectData = index[0].data.field1;
                                    //var bool = getMemoData(selectData);
                                    //if (!bool) {
                                    //    Ext.MessageBox.alert("提示", '请先选择一行明细数据!');
                                    //    var data = Memogrid.getSelectionModel().getSelection();
                                    //    data[0].set('MenoName', "");
                                    //    data[0].set('BeforeCode', "");
                                    //    data[0].set('BeforeName', "");
                                    //    return false;
                                    //}

                                },
                                'beforeselect': function (combo, record, index, eOpts) {
                                    var selectData = record.data.field1;
                                    var bool = getMemoData(selectData);
                                    if (!bool) {
                                        Ext.MessageBox.alert("提示", '请先选择一行明细数据!');
                                        //var data = Memogrid.getSelectionModel().getSelection();
                                        //data[0].set('MenoName', "");
                                        //data[0].set('BeforeCode', "");
                                        //data[0].set('BeforeName', "");
                                        return false;
                                    }
                                }


                            }

                        }
                    },

                    {
                        "LangKey": "MemoArea",
                        "dataIndex": "MemoArea",
                        "width": 100,
                        "header": "批注区域",
                        "hidden": true
                    },
                    {
                        "LangKey": "BeforeCode",
                        "dataIndex": "BeforeCode",
                        "width": 100,
                        "header": "批注前代码",
                        "hidden": true
                    },
                    {
                        "LangKey": "BeforeName",
                        "dataIndex": "BeforeName",
                        "width": 240,
                        "header": "原内容"
                    },
                    {
                        "LangKey": "AfterCode",
                        "dataIndex": "AfterCode",
                        "width": 100,
                        "header": "批注后代码",
                        "hidden": true
                    },
                    {
                        "LangKey": "AfterName",
                        "dataIndex": "AfterName",
                        "width": 240,
                        "header": "批注内容",
                        "editor": {
                            "xtype": "ngText",
                            listeners: {

                            }

                        }
                    },
                    {
                        xtype: 'actioncolumn',
                        width: 30,
                        sortable: false,
                        "hidden": !memoGridField,
                        items: [{
                            icon: C_ROOT + "/NG3Resource/New_Login/img/xz.png",
                            tooltip: '数据选择',
                            handler: function (grid, rowIndex, colIndex, a, b, c, d, e) {
                                //var data = Memogrid.getSelectionModel().getSelection();
                                //var code = "";
                                //if (data.length > 0) {
                                //    code = data[0].get("MenoName");
                                //}
                                var code = MemoPanelStore.getAt(rowIndex).get('MenoName')
                                if (code == "") {
                                    Ext.MessageBox.alert("提示", '请先选择要批注的字段!');
                                    return false;
                                }
                                if (code == "FStartDate" || code == "FEndDate") {

                                }

                                if (mainHelpSelected.indexOf(code) >= 0) {
                                    mainPanel_form.queryById(code).onTriggerClick();
                                } else if (dtlHelpSelected.indexOf(code) >= 0) {
                                    BudgetDtlPanel_grid.getColumn(code + '_EXName').getEditor().onTriggerClick();
                                } else {
                                    Ext.MessageBox.alert("提示", '该批注内容仅支持手动输入!');
                                    return false;
                                }

                                //Memogrid.queryById("DEFDate1").onTriggerClick();
                                //ImplPlanPanel_grid.getColumn('FStartDate').getEditor().fireEvent('select');
                                //ImplPlanPanel_grid.getColumn('FStartDate').getEditor().show();
                                //Memogrid.getColumn('DEFDate1').getEditor().fireEvent('click');;
                                //alert(11);
                                //Memogrid.getColumn('DEFDate1').show();
                                //Memogrid.getColumn('DEFDate1').getEditor().onTriggerClick();
                                //alert(11);
                                //Memogrid.getColumn('DEFDate1').onTriggerClick();
                            }
                        }]
                        //listeners: {

                        //    'click': function (e, eOpts) {
                        //        var data = Memogrid.getSelectionModel().getSelection();
                        //        alert(6);
                        //    },
                        //    //'dblclick': function (e, eOpts) {
                        //    //    alert(7);
                        //    //},
                        //    //'mousedown': function (e, eOpts) {
                        //    //    alert(8);
                        //    //},
                        //    'itemclick': function (item, record, it, index, e, eOpts) {
                        //        var data = Memogrid.getSelectionModel().getSelection();
                        //        alert(33);
                        //    },
                        //    //'cellclick': function (item, record, it, index, e, eOpts) {
                        //    //    alert(43);
                        //    //},
                        //    //'keydown': function (el, e, eOpts) {
                        //    //    alert(11);
                        //    //}

                        //}

                    },
                    {
                        "LangKey": "IfChoose",
                        "dataIndex": "IfChoose",
                        "width": 100,
                        "header": "是否引用",
                        "hidden": memoGridField
                    },
                    {
                        "LangKey": "FProjCode",
                        "dataIndex": "FProjCode",
                        "width": 10,
                        "header": "项目代码",
                        "hidden": true
                    },
                    {
                        "LangKey": "FProjName",
                        "dataIndex": "FProjName",
                        "width": 100,
                        "header": "项目名称",
                        "hidden": true
                    },

                    {
                        "LangKey": "TabName",
                        "dataIndex": "TabName",
                        "width": 10,
                        "header": "NGColumn16",
                        "hidden": true
                    },
                    {
                        "LangKey": "DEFSTR1",
                        "dataIndex": "DEFSTR1",
                        "width": 100,
                        "header": "单据phid",
                        "hidden": true
                    },
                    {
                        "LangKey": "DEFSTR2",
                        "dataIndex": "DEFSTR2",
                        "width": 200,
                        "header": "说明",
                        //"hidden": true
                        "editor": {
                            "xtype": "ngText"
                        }
                    },
                    {
                        "LangKey": "DEFSTR3",
                        "dataIndex": "DEFSTR3",
                        "width": 100,
                        "header": "NGColumn19",
                        "hidden": true
                    },
                    {
                        "LangKey": "DEFINT1",
                        "dataIndex": "DEFINT1",
                        "width": 100,
                        "header": "NGColumn20",
                        "hidden": true
                    },
                    {
                        "LangKey": "DEFINT2",
                        "dataIndex": "DEFINT2",
                        "width": 100,
                        "header": "NGColumn21",
                        "hidden": true
                    },
                    {
                        "LangKey": "DEFNUM1",
                        "dataIndex": "DEFNUM1",
                        "width": 100,
                        "header": "NGColumn22",
                        "hidden": true
                    },
                    {
                        "LangKey": "DEFNUM2",
                        "dataIndex": "DEFNUM2",
                        "width": 100,
                        "header": "NGColumn23",
                        "hidden": true
                    },
                    {
                        "LangKey": "DEFDate1",
                        "dataIndex": "DEFDate1",
                        "width": 100,
                        "header": "NGColumn24",
                        "editor": {
                            "xtype": "ngDate"
                        },
                        "hidden": true
                    },
                    {
                        "LangKey": "DEFDate2",
                        "dataIndex": "DEFDate2",
                        "width": 100,
                        "header": "NGColumn25",
                        "hidden": true
                    }
                ],

                listeners: {
                    'itemdblclick': function (item, record, it, index, e, eOpts) {
                        var data = Memogrid.getSelectionModel().getSelection();

                        if (data.length > 0) {

                           // MemoWin.close();

                        }
                    }


                }


            });


            var MemoToolbar = Ext.create('Ext.ng.Toolbar', {
                region: 'north',
                ngbuttons: [
                    'addrow', 'deleterow', 'save', { itemId: "chooseMemo", text: "引用", width: this.itemWidth, iconCls: "icon-assign", langkey: "chooseMemo" },
                    '->', 'refresh', { itemId: "closeMemo", text: "关闭", width: this.itemWidth, iconCls: "icon-Close", langkey: "close" }
                ]
            });
            if (memoRight == "memoRight") { //批注进来的隐藏批注记录
                MemoToolbar.items.get('chooseMemo').hide();
            } else {
                MemoToolbar.items.get('addrow').hide();
                MemoToolbar.items.get('deleterow').hide();
                MemoToolbar.items.get('save').hide();
            }

            Memogrid.getColumn('MenoName').renderer = function (val) {
                switch (val) {
                    case mainAreaField[0]:
                        return mainAreaFieldName[0];
                    case mainAreaField[1]:
                        return mainAreaFieldName[1];
                    case mainAreaField[2]:
                        return mainAreaFieldName[2];
                    case mainAreaField[3]:
                        return mainAreaFieldName[3];
                    case mainAreaField[4]:
                        return mainAreaFieldName[4];
                    case mainAreaField[5]:
                        return mainAreaFieldName[5];
                    case mainAreaField[6]:
                        return mainAreaFieldName[6];
                    case mainAreaField[7]:
                        return mainAreaFieldName[7];
                    case mainAreaField[8]:
                        return mainAreaFieldName[8];
                    case mainAreaField[9]:
                        return mainAreaFieldName[9];
                    case mainAreaField[10]:
                        return mainAreaFieldName[10];
                    case mainAreaField[11]:
                        return mainAreaFieldName[11];
                    case mainAreaField[12]:
                        return mainAreaFieldName[12];
                    case mainAreaField[13]:
                        return mainAreaFieldName[13];
                    case mainAreaField[14]:
                        return mainAreaFieldName[14];
                    case mainAreaField[15]:
                        return mainAreaFieldName[15];
                    case mainAreaField[16]:
                        return mainAreaFieldName[16];
                    case dtlAreaField[0]:
                        return dtlAreaFieldName[0];
                    case dtlAreaField[1]:
                        return dtlAreaFieldName[1];
                    case dtlAreaField[2]:
                        return dtlAreaFieldName[2];
                    case dtlAreaField[3]:
                        return dtlAreaFieldName[3];
                    case dtlAreaField[4]:
                        return dtlAreaFieldName[4];
                    case dtlAreaField[5]:
                        return dtlAreaFieldName[5];
                    case dtlAreaField[6]:
                        return dtlAreaFieldName[6];
                    case dtlAreaField[7]:
                        return dtlAreaFieldName[7];
                    case dtlAreaField[8]:
                        return dtlAreaFieldName[8];
                    case dtlAreaField[9]:
                        return dtlAreaFieldName[9];
                    case dtlAreaField[10]:
                        return dtlAreaFieldName[10];
                    case dtlAreaField[11]:
                        return dtlAreaFieldName[11];
                    case dtlAreaField[12]:
                        return dtlAreaFieldName[12];
                    case dtlAreaField[13]:
                        return dtlAreaFieldName[13];
                    case dtlAreaField[14]:
                        return dtlAreaFieldName[14];
                    case TextAreaField[0]:
                        return TextAreaFieldName[0];
                    case TextAreaField[1]:
                        return TextAreaFieldName[1];
                    case TextAreaField[2]:
                        return TextAreaFieldName[2];
                    case TextAreaField[3]:
                        return TextAreaFieldName[3];
                    case TextAreaField[4]:
                        return TextAreaFieldName[4];
                    case TextAreaField[5]:
                        return TextAreaFieldName[5];
                    case TextAreaField[6]:
                        return TextAreaFieldName[6];
                    case FundApplAreaField[0]:
                        return FundApplAreaFieldName[0];
                    case FundApplAreaField[1]:
                        return FundApplAreaFieldName[1];
                    case ImplPlanAreaField[0]:
                        return ImplPlanAreaFieldName[0];
                    case ImplPlanAreaField[1]:
                        return ImplPlanAreaFieldName[1];
                    case ImplPlanAreaField[2]:
                        return ImplPlanAreaFieldName[2];
                    //case dtlAreaField[14]:
                    //    return dtlAreaFieldName[14];
                    //case dtlAreaField[15]:
                    //    return dtlAreaFieldName[15];
                    //case dtlAreaField[16]:
                    //    return dtlAreaFieldName[16];
                    //case dtlAreaField[17]:
                    //    return dtlAreaFieldName[17];
                    //case dtlAreaField[18]:
                    //    return dtlAreaFieldName[18];
                    //case dtlAreaField[19]:
                    //    return dtlAreaFieldName[19];
                    //case dtlAreaField[20]:
                    //    return dtlAreaFieldName[20];
                    //case dtlAreaField[21]:
                    //    return dtlAreaFieldName[21];
                    //case dtlAreaField[22]:
                    //    return dtlAreaFieldName[22];
                    //case dtlAreaField[23]:
                    //    return dtlAreaFieldName[23];
                    //case dtlAreaField[24]:
                    //    return dtlAreaFieldName[24];
                    //case dtlAreaField[25]:
                    //    return dtlAreaFieldName[25];

                }
            };
            Memogrid.getColumn('MemoTime').renderer = function (val) {
                if (val) {
                    var str = Ext.util.Format.date(val, 'Y-m-d');
                    return str;
                } else {
                    return '';
                }
            };
            //Memogrid.getColumn('IfChoose').renderer = function (val) {
            //    switch (val) {
            //        case "1":
            //            return "是";
            //        case "2":
            //            return "否";
            //    }
            //};

            ngToolbar.get('memo').on('click', function () {

                showMemo();

            });

            ngToolbar.get('memoRecord').on('click', function () {
                //mainPanel_form.queryById("FStartDate").onTriggerClick();
                // BudgetDtlPanel_grid.getColumn('FSourceOfFunds_EXName').getEditor().onTriggerClick();
                showMemo();
            });

            function showMemo() {
                if (otype == $Otype.ADD) {
                    Ext.MessageBox.alert("提示", '新增时不能进行批注!');
                    return;
                }

                MemoWin = Ext.create("Ext.ng.gh.baseWindow", {
                    title: '批注',
                    modal: true,
                    height: 450,
                    width: 1020,//1050
                    layout: 'border',
                    // hideAction: 'close',
                    items: [
                        MemoToolbar,
                        Memogrid
                    ],
                    invokeCancelback: function () {
                        memoWinShow = false;
                    }

                });
                if (MemoPanelStore.getCount() == 0) {
                    Ext.apply(MemoPanelStore.proxy.extraParams, { 'Memophid': mainPanel_form.queryById("PhId").getValue() });
                    MemoPanelStore.cachePageData = false;
                    MemoPanelStore.load();
                    MemoPanelStore.cachePageData = true;
                }
                //Ext.apply(MemoPanelStore.proxy.extraParams, { 'Memophid': mainPanel_form.queryById("PhId").getValue() });
                //MemoPanelStore.cachePageData = false;
                //MemoPanelStore.load();
                //MemoPanelStore.cachePageData = true;

                MemoWin.show();
                memoWinShow = true;
            }
            MemoToolbar.items.get('addrow').on('click', function () {
                var dtldata = Memogrid.getSelectionModel();
                MemoPanelStore.insert(MemoPanelStore.getCount(), dtldata);
                MemoPanelStore.getAt(MemoPanelStore.getCount() - 1).set('Memophid', mainPanel_form.queryById("PhId").getValue());
                //MemoPanelStore.getAt(MemoPanelStore.getCount() - 1).set('UserCode', $appinfo.logid);
                //MemoPanelStore.getAt(MemoPanelStore.getCount() - 1).set('UserName', $appinfo.username);
                //MemoPanelStore.getAt(MemoPanelStore.getCount() - 1).set('MemoTime', $appinfo.username);

            });
            MemoToolbar.items.get('deleterow').on('click', function () {
                var selection = Memogrid.getSelectionModel().getSelection();

                if (selection) {

                    if (selection[0].get('PhId') == "0" || selection[0].get('PhId') == "") {
                        MemoPanelStore.remove(selection);
                        return;
                    }

                    Ext.MessageBox.confirm('提示', '是否删除此记录？', callBack);

                    function callBack(callBackid) {
                        if (callBackid.toString() == "no" || callBackid.toString() == "cancel") {
                            return;
                        } else {
                            Ext.Ajax.request({
                                params: { 'id': selection[0].get('PhId') },
                                url: C_ROOT + 'GQT/QT/QTEditMemo/Delete',
                                success: function (response) {
                                    var resp = Ext.JSON.decode(response.responseText);
                                    if (resp.Status === "success") {

                                        MemoPanelStore.remove(selection);

                                        NGMsg.Info('删除成功！');
                                    } else {
                                        NGMsg.Info('删除失败！');
                                    }
                                }
                            });
                        }
                    }


                }

            });

            MemoToolbar.items.get('save').on('click', function () {

                var griddata = Memogrid.getChange();

                if (!Memogrid.hasModifyed()) {
                      NGMsg.Info("单据并无更新,无需保存!");
                      return;
                  }

                //if (!Memogrid.isValid()) {
                //      return;
                //  }

                  MemoToolbar.items.get("save").disable();//禁用保存按钮
                  var myMask = new Ext.LoadMask(document.body, { msg: "正在保存中,请稍候..." });
                  myMask.show();//锁屏
                  Ext.Ajax.request({
                      params: { 'qteditmemoformData': griddata },
                      url: '@Url.Content("~/GQT/QT/QTEditMemo/Save")',
                      success: function (response) {
                          var resp = Ext.JSON.decode(response.responseText);
                          if (resp.Status === "success") {
                              //infostore.commitChanges();
                              NGMsg.Success('保存成功');
                              Ext.apply(MemoPanelStore.proxy.extraParams, { 'Memophid': mainPanel_form.queryById("PhId").getValue() });
                              MemoPanelStore.cachePageData = false;
                              MemoPanelStore.load();
                              MemoPanelStore.cachePageData = true;
                          } else {
                              NGMsg.Error('保存失败' + resp.Msg);
                          }
                          myMask.hide();//停止锁屏
                          MemoToolbar.items.get("save").enable();//保存失败，保存按钮设置为可用
                      }
                  });

                //mainPanel_form.queryById("FStartDate").onTriggerClick();
                //MemoPanelStore.load();
            });
            MemoToolbar.items.get('refresh').on('click', function () {

                Ext.apply(MemoPanelStore.proxy.extraParams, { 'Memophid': mainPanel_form.queryById("PhId").getValue() });
                MemoPanelStore.cachePageData = false;
                MemoPanelStore.load();
                MemoPanelStore.cachePageData = true;
            });
            MemoToolbar.items.get('closeMemo').on('click', function () {

                MemoWin.close();
            });

            MemoToolbar.items.get('chooseMemo').on('click', function () {
                var selection = Memogrid.getSelectionModel().getSelection();
                var menonameValue = "";
                if (selection.length > 0) {
                    for (var i = 0; i < selection.length; i++) {
                        menonameValue = selection[i].get('MenoName');
                        if (setMemoData(menonameValue,i)) {
                            for (var j = 0; j < MemoPanelStore.getCount(); j++) {
                                if (MemoPanelStore.getAt(j).get('MenoName') == menonameValue && MemoPanelStore.getAt(j).get('PhId') != selection[i].get('PhId')) {
                                    MemoPanelStore.getAt(j).set('IfChoose', '否');
                                }
                            }
                        } else {
                            Ext.MessageBox.alert("提示", '引用失败，请重试!');
                            return;
                        }
                    }
                    Ext.MessageBox.alert("提示", '引用成功，请保存!');
                } else {
                    Ext.MessageBox.alert("提示", '请先选择要引用的数据!');
                    return;
                }
                //if (selection) {
                //    if (selection[0].get('PhId') == '0' || selection[0].get('PhId') == "") {
                //        Ext.MessageBox.alert("提示", '请先保存要引用的数据!');
                //        return;
                //    }
                //    var menonameValue = selection[0].get('MenoName');
                    //if (setMemoData(menonameValue)) {
                    //    //当前已引用的，则把其他的全部设为未引用
                    //    for (var i = 0; i < MemoPanelStore.getCount(); i++) {
                    //        if (MemoPanelStore.getAt(i).get('MenoName') == menonameValue && MemoPanelStore.getAt(i).get('PhId') != selection[0].get('PhId')) {
                    //            MemoPanelStore.getAt(i).set('IfChoose', '否');
                    //        }
                    //    }
                    //    Ext.MessageBox.alert("提示", '引用成功，请保存!');
                    //} else {
                    //    Ext.MessageBox.alert("提示", '引用失败，请重试!');
                    //}

                //} else {
                //    Ext.MessageBox.alert("提示", '请先选择要引用的数据!');
                //    return;
                //}
            });


            Memogrid.on('edit', function (editor, context) {
                if (context.field == "AfterName") {
                    if (context.record.data.MenoName == "FProjAttr" || context.record.data.MenoName == "FDuration") { //项目属性,存续期限 处理
                        if (context.record.data.AfterName == "延续项目" || context.record.data.AfterName == "一次性项目") {
                            context.record.data.AfterCode = '1';
                        } else if (context.record.data.AfterName == "新增项目" || context.record.data.AfterName == "经常性项目") {
                            context.record.data.AfterCode = '2';
                        } else {
                            Ext.MessageBox.alert("提示", '请录入正确数据!');
                            context.record.data.AfterName = "";
                        }
                    } else if (context.record.data.MenoName == "FStartDate" || context.record.data.MenoName == "FEndDate") {
                        if (context.record.data.AfterName.substr(4, 1) != "-" || context.record.data.AfterName.substr(7, 1) != "-" || context.record.data.AfterName.length != 10) {
                            Ext.MessageBox.alert("提示", '请录入正确数据!');
                            context.record.data.AfterName = "";
                        }
                    }

                    this.getView().refresh(true);

                }


            });
            //Memogrid.on('beforestartedit', function (editor, context) {
            //    alert(11);
            //});
            //Memogrid.on('focus', function (aa,editor, context) {
            //    alert(11);
            //});

            function getMemoData(filed) {
                if (mainAreaField.indexOf(filed) >= 0) {  //查找数组中是否包含该字段
                    var code = mainPanel_form.queryById(filed).getValue();//实际代码
                    var name = mainPanel_form.queryById(filed).rawValue; //显示值
                    name = IfchangeValue(filed, name);

                    var data = Memogrid.getSelectionModel().getSelection();
                    if (data.length > 0) {
                        data[0].set('BeforeCode', code);//代码
                        data[0].set('BeforeName', name);//名称
                        data[0].set('AfterCode', "");//清空原有值
                        data[0].set('AfterName', "");//清空原有值
                        data[0].set('DEFSTR1', mainPanel_form.queryById("PhId").getValue() );
                        return true;
                    }

                } else if (dtlAreaField.indexOf(filed) >= 0) {
                    var valueSelect = BudgetDtlPanel_grid.getSelectionModel().getSelection();//预算明细
                    var code = "";
                    var name = "";

                    if (valueSelect.length > 0) {

                        if (valueSelect[0].get("PhId") == "" || valueSelect[0].get("PhId") == "0") {
                            Ext.MessageBox.alert("提示", '新增明细不能进行批注!');
                            return false;
                        }

                        code = valueSelect[0].get(filed);
                        name = valueSelect[0].get(filed);
                        if (EXNameValue.indexOf(filed) >= 0) {
                            name = valueSelect[0].get(filed + "_EXName");
                        }
                        name = IfchangeValue(filed, name);//判断是否需要值转换
                    } else {
                        return false;
                    }
                    var count = 0;
                    for (var i = 0; i < BudgetDtlPanel_store.getCount(); i++) {
                        if (BudgetDtlPanel_store.getAt(i).get("PhId") == valueSelect[0].get("PhId")) {
                            count = i + 1;
                            break;
                        }
                    }

                    var data = Memogrid.getSelectionModel().getSelection();
                    if (data.length > 0) {
                        data[0].set('BeforeCode', code);
                        data[0].set('BeforeName', name + "第(" + count + ")行");
                        data[0].set('AfterCode', "");//清空原有值
                        data[0].set('AfterName', "");//清空原有值
                        data[0].set('DEFSTR1', valueSelect[0].get("PhId"));
                        return true;
                    }

                } else if (TextAreaField.indexOf(filed) >= 0) {
                    var value = FunctionalOvervPanel_form.queryById(filed).getValue();//明细文字区
                    var data = Memogrid.getSelectionModel().getSelection();
                    if (data.length > 0) {
                        data[0].set('BeforeCode', value);
                        data[0].set('BeforeName', value);
                        data[0].set('AfterCode', "");//清空原有值
                        data[0].set('AfterName', "");//清空原有值
                        data[0].set('DEFSTR1', FunctionalOvervPanel_form.queryById("PhId").getValue());
                        return true;
                    }
                } else if (FundApplAreaField.indexOf(filed) >= 0) {

                    var valueSelect = FundApplPanel_grid.getSelectionModel().getSelection();//
                    var name = "";
                    var code = "";
                    if (valueSelect.length > 0) {

                        if (valueSelect[0].get("PhId") == "" || valueSelect[0].get("PhId") == "0") {
                            Ext.MessageBox.alert("提示", '新增明细不能进行批注!');
                            return ;
                        }

                        code = valueSelect[0].get(filed);
                        name = valueSelect[0].get(filed);
                        if (EXNameValue.indexOf(filed) >= 0) {
                            name = valueSelect[0].get(filed + "_EXName");
                        }
                    } else {
                        return false;
                    }

                    var count = 0;
                    for (var i = 0; i < FundApplPanel_store.getCount(); i++) {
                        if (FundApplPanel_store.getAt(i).get("PhId") == valueSelect[0].get("PhId")) {
                            count = i + 1;
                            break;
                        }
                    }

                    var data = Memogrid.getSelectionModel().getSelection();
                    if (data.length > 0) {
                        data[0].set('BeforeCode', code);
                        data[0].set('BeforeName', name + "第(" + count + ")行");
                        data[0].set('AfterCode', "");//清空原有值
                        data[0].set('AfterName', "");//清空原有值
                        data[0].set('DEFSTR1', valueSelect[0].get("PhId"));
                        return true;
                    }
                }
                else if (ImplPlanAreaField.indexOf(filed) >= 0) {
                    var valueSelect = ImplPlanPanel_grid.getSelectionModel().getSelection();//
                    var code = "";
                    var name = "";
                    if (valueSelect.length > 0) {

                        if (valueSelect[0].get("PhId") == "" || valueSelect[0].get("PhId") == "0") {
                            Ext.MessageBox.alert("提示", '新增明细不能进行批注!');
                            return false;
                        }

                        code = valueSelect[0].get(filed);
                        name = valueSelect[0].get(filed);
                    } else {
                        return false;
                    }

                    var count = 0;
                    for (var i = 0; i < FundApplPanel_store.getCount(); i++) {
                        if (FundApplPanel_store.getAt(i).get("PhId") == valueSelect[0].get("PhId")) {
                            count = i + 1;
                            break;
                        }
                    }

                    var data = Memogrid.getSelectionModel().getSelection();
                    if (data.length > 0) {
                        data[0].set('BeforeCode', code);
                        data[0].set('BeforeName', name + "第(" + count + ")行");
                        data[0].set('AfterCode', "");//清空原有值
                        data[0].set('AfterName', "");//清空原有值
                        data[0].set('DEFSTR1', valueSelect[0].get("PhId"));
                        return true;
                    }

                }
                return true;
            }

            function setMemoData(filed,index) {
                if (mainAreaField.indexOf(filed) >= 0) {  //查找数组中是否包含该字段

                    var data = Memogrid.getSelectionModel().getSelection();
                    if (data.length > 0) {

                       //要代码转名称的取代码，其他直接取值
                        if (mainHelpSelected.indexOf(filed) >= 0) {
                            mainPanel_form.queryById(filed).setValue(data[index].get("AfterCode"));//引用批注值
                            var codectl = [mainPanel_form.queryById(filed)]; //是否需要代码转名称
                            BatchBindCombox(codectl);
                        } else if (IFchangeValue.indexOf(filed) >= 0) {
                            if (data[index].get("AfterName") == '是') {
                                mainPanel_form.queryById(filed).setValue('1');
                            } else {
                                mainPanel_form.queryById(filed).setValue('2');
                            }
                        } else if (filed == "FProjAttr" || filed == "FDuration") { //项目属性,存续期限 处理
                            mainPanel_form.queryById(filed).setValue(data[index].get("AfterCode"));//引用批注值
                        }
                        else {
                            mainPanel_form.queryById(filed).setValue(data[index].get("AfterName"));//引用批注值
                        }
                        data[index].set('IfChoose', '是');//已引用标志
                        return true;
                    }

                }
                else if (dtlAreaField.indexOf(filed) >= 0) {

                    var data = Memogrid.getSelectionModel().getSelection();

                    for (var i = 0; i < BudgetDtlPanel_store.getCount(); i++) {
                        if (BudgetDtlPanel_store.getAt(i).get("PhId") == data[index].get("DEFSTR1")) {
                            if (EXNameValue.indexOf(filed) >= 0) {
                                BudgetDtlPanel_store.getAt(i).set(filed, data[index].get("AfterCode"));
                                BudgetDtlPanel_store.getAt(i).set(filed + "_EXName", data[index].get("AfterName"));
                            }
                            else if (IFchangeValue.indexOf(filed) >= 0) {
                                if (data[index].get("AfterName") == '是') {
                                    BudgetDtlPanel_store.getAt(i).set(filed, '1');
                                } else {
                                    BudgetDtlPanel_store.getAt(i).set(filed, '2');
                                }
                            }
                            else {
                                BudgetDtlPanel_store.getAt(i).set(filed, data[index].get("AfterName"));
                            }
                            data[index].set('IfChoose', '是');//已引用标志
                            return true;
                        }
                    }
                    return false;

                    //var valueSelect = BudgetDtlPanel_grid.getSelectionModel().getSelection();//预算明细
                    //var code = "";
                    //var name = "";
                    //if (valueSelect.length > 0) {
                    //    var data = Memogrid.getSelectionModel().getSelection();
                    //    if (EXNameValue.indexOf(filed) >= 0) {
                    //        valueSelect[0].set(filed, data[0].get("AfterCode"));
                    //        valueSelect[0].set(filed + "_EXName", data[0].get("AfterName"));
                    //    } else if (IFchangeValue.indexOf(filed) >= 0) {
                    //        if (data[0].get("AfterName") == '是') {
                    //            valueSelect[0].set(filed, '1');
                    //        } else {
                    //            valueSelect[0].set(filed, '2');
                    //        }
                    //    } else {
                    //        valueSelect[0].set(filed, data[0].get("AfterName"));
                    //    }
                    //    data[0].set('IfChoose', '是');//已引用标志
                    //    return true;
                    //} else {
                    //    Ext.MessageBox.alert("提示", '请先选择一行明细数据!');
                    //    return false;
                    //}
                }
                else if (TextAreaField.indexOf(filed) >= 0) {

                    var data = Memogrid.getSelectionModel().getSelection();
                    if (data.length > 0) {
                        FunctionalOvervPanel_form.queryById(filed).setValue(data[index].get("AfterName"));
                        data[index].set('IfChoose', '是');//已引用标志

                        if (filed == "FProjOverview") {
                            ProjOverviewPanel_form.queryById(filed).setValue(data[index].get("AfterName"));
                        } else if (filed == "FLTPerformGoal") {
                            longTargetPanel_form.queryById(filed).setValue(data[index].get("AfterName"));
                        } else if (filed == "FAnnualPerformGoal") {
                            yearTargetPanel_form.queryById(filed).setValue(data[index].get("AfterName"));
                        } else if (filed == "FProjBasis" || filed == "FFeasibility" || filed == "FNecessity") {
                            projectStartInfoPanel_form.queryById(filed).setValue(data[index].get("AfterName"));
                        }
                        return true;
                    }
                }
                else if (FundApplAreaField.indexOf(filed) >= 0) {

                    //var valueSelect = FundApplPanel_grid.getSelectionModel().getSelection();//
                    //var name = "";
                    //var code = "";
                    //if (valueSelect.length > 0) {
                    //    var data = Memogrid.getSelectionModel().getSelection();
                    //    if (EXNameValue.indexOf(filed) >= 0) {
                    //        valueSelect[0].set(filed, data[0].get("AfterCode"));
                    //        valueSelect[0].set(filed + "_EXName", data[0].get("AfterName"));
                    //    }
                    //    else {
                    //        valueSelect[0].set(filed, data[0].get("AfterName"));
                    //    }
                    //    data[0].set('IfChoose', '是');//已引用标志
                    //    return true;
                    //} else {
                    //    Ext.MessageBox.alert("提示", '请先选择一行明细数据!');
                    //    return false;
                    //}
                    var data = Memogrid.getSelectionModel().getSelection();
                    for (var i = 0; i < FundApplPanel_store.getCount(); i++) {
                        if (FundApplPanel_store.getAt(i).get("PhId") == data[index].get("DEFSTR1")) {
                            if (EXNameValue.indexOf(filed) >= 0) {
                                FundApplPanel_store.getAt(i).set(filed, data[index].get("AfterCode"));
                                FundApplPanel_store.getAt(i).set(filed + "_EXName", data[index].get("AfterName"));
                            }

                            else {
                                FundApplPanel_store.getAt(i).set(filed, data[index].get("AfterName"));
                            }
                            data[index].set('IfChoose', '是');//已引用标志
                            return true;
                        }
                    }
                    return false;
                }
                else if (ImplPlanAreaField.indexOf(filed) >= 0) {
                    //var valueSelect = ImplPlanPanel_grid.getSelectionModel().getSelection();//
                    //var code = "";
                    //var name = "";
                    //if (valueSelect.length > 0) {
                    //    var data = Memogrid.getSelectionModel().getSelection();
                    //    valueSelect[0].set(filed, data[0].get("AfterName"));
                    //    data[0].set('IfChoose', '是');//已引用标志
                    //    return true;

                    //} else {
                    //    Ext.MessageBox.alert("提示", '请先选择一行明细数据!');
                    //    return false;
                    //}
                    var data = Memogrid.getSelectionModel().getSelection();
                    for (var i = 0; i < ImplPlanPanel_store.getCount(); i++) {
                        if (ImplPlanPanel_store.getAt(i).get("PhId") == data[index].get("DEFSTR1")) {
                            ImplPlanPanel_store.getAt(i).set(filed, data[index].get("AfterName"));
                            data[index].set('IfChoose', '是');//已引用标志
                            return true;
                        }
                    }
                    return false;

                }
                return false;
            }

            function IfchangeValue(field,name) {
                if (IFchangeValue.indexOf(field) >= 0) {
                    if (name == "1") {
                        return "是";
                    } else {
                        return "否";
                    }
                }
                return name;
            }

            function SaveMemogridData() {
                //单据保存后如果有引用过的则进行保存批注数据
                var griddata = Memogrid.getChange();
                if (Memogrid.hasModifyed()) {
                    Ext.Ajax.request({
                        params: { 'qteditmemoformData': griddata },
                        url: '@Url.Content("~/GQT/QT/QTEditMemo/Save")',
                        success: function (response) {
                            var resp = Ext.JSON.decode(response.responseText);
                            if (resp.Status === "success") {
                                //infostore.commitChanges();
                            }
                        }
                    });
                }
            }

            function FindIndividualInfo(valueId) {
                var busType = "GHBudgetXMLX";
                var New_IndividualinfoId = "";
                if (ProjStatus != "2") {
                    busType = "GHBudgetYLX";//预立项
                }
                if (IndividualinfoId != "" && IndividualinfoId != 0) {
                    Ext.Ajax.request({
                        params: { 'busType': busType, 'IndividualInfoId': valueId, 'projAmount': mainPanel_form.queryById("FProjAmount").getValue(),'OrgCode':$appinfo.ocode },
                        url: C_ROOT + 'GXM/XM/ProjectMst/FindIndividualInfo',
                        async: false,
                        success: function (response) {
                            var resp = Ext.JSON.decode(response.responseText);
                            New_IndividualinfoId = resp.Msg;
                            
                        }
                    });
                }
                return New_IndividualinfoId;
            }




            //========================================================================//
            //定义窗口
            Ext.define("Ext.ng.gh.baseWindow", {
                extend: 'Ext.window.Window',
                cancelback: Ext.emptyFn,
                closeAction: 'close',
                initComponent: function () {
                    var me = this;
                    me.callParent();
                    me.on("close", Ext.bind(function (p, opts) {
                        me.invokeCancelback();
                    }, me));
                },
                invokeCancelback: function () {
                    var me = this;
                    if (!Ext.isEmpty(me.cancelback)) {
                        me.cancelback();
                    }
                }
            });

            var oldPhidItem, phidItem;
			var projWinTreePanel;


            //项目名称弹出
            var projWin;
            var projWinToolbar = Ext.create('Ext.ng.Toolbar', {
                region: 'north',
                ngbuttons: [
                     'addbrother', 'addchild', "-","edit", "delete","ok", "->" //, 'cancel'
                ]
            });


            var nodeEditWinPanel_Config = {
                region: 'center',
                frame: true,
                split: true,
                minWidth: 490,
                buskey: 'PhId', //对应的业务表主键
                otype: "edit", //操作类型,add||edit,
                border: 0,
                id: "EditPanel",
                buskey: "PhId",
                bindtable: "Z_QTGKXM",
                desTitle: "编辑面板",
                columnsPerRow: 1,
                fields: [
                  {
                      fieldLabel: "项目代码",
                      itemId: "DM",
                      name: "DM",
                      maxLength: 255,
                      langKey: "DM",
                      xtype: "ngText",
                      readOnly: true
                  },
                  {
                      fieldLabel: "项目名称",
                      itemId: "MC",
                      name: "MC",
                      maxLength: 100,
                      langKey: "MC",
                      xtype: "ngText"
                  },
                  {
                      fieldLabel: "父节点代码",
                      itemId: "DEFSTR2",
                      name: "DEFSTR2",
                      maxLength: 255,
                      langKey: "DEFSTR2",
                      xtype: "ngText",
                      readOnly: true
                  },
				  {
                        fieldLabel: "申报单位",
                        itemId: "DEFSTR3",
                        name: "DEFSTR3",
                        maxLength: 255,
                        langKey: "DEFSTR3",
                        xtype: "ngText",
						hidden: true
                    },
                  {
                      xtype: "container",
                      name: "hiddenContainer",
                      hidden: true,
                      items: [
                        {
                            xtype: "hiddenfield",
                            fieldLabel: "主键",
                            name: "PhId"
                        },
                        {
                            xtype: "hiddenfield",
                            fieldLabel: "记录版本",
                            name: "NgRecordVer"
                        }
                      ]
                  }
                ]

            };
            //增加同级
            projWinToolbar.items.get('addbrother').on('click', function () {
                var treeP = Ext.getCmp("projectTree");
                var selectNode = treeP.getSelectionModel().lastSelected;
                if (Ext.isEmpty(selectNode)) {
                    setTimeout(function () {
                        Ext.MessageBox.alert("提示", "请选择节点,但不要选择根节点");
                        return;
                    }, 100);
                }

                if (selectNode.data.id == "root") {
                    setTimeout(function () {
                        Ext.MessageBox.alert("提示", "请选择下级节点,不要选择根节点");
                        return;
                    }, 100);
                }
                else {
                    //弹出新增窗口
                    var nodeEditWinPanel = Ext.create('Ext.ng.TableLayoutForm', nodeEditWinPanel_Config);
                    nodeEditWinPanel.queryById("DEFSTR3").setValue(mainPanel_form.queryById("FDeclarationUnit").getValue());
                    var parentCode='';
                    if(selectNode.data.parentId=='root'){
                        nodeEditWinPanel.queryById("DEFSTR2").setValue('');
                    }else{
                        nodeEditWinPanel.queryById("DEFSTR2").setValue(selectNode.data.parentId);// parentCode
                        parentCode=selectNode.data.parentId;
                    }
                    Ext.Ajax.request({
                        params: { "parentCode": parentCode,"year":sessionStorage.getItem("FYear") },
                        url: C_ROOT + 'GQT/QT/ProjLibProj/getCode',
                        success: function (response) {
                            nodeEditWinPanel.queryById("DM").setValue(response.text);
                        }
                    });
                    var pname="";
                    if(selectNode.data.parentId!=''){
                        pname=selectNode.parentNode.data.text;
                    }
                    var nodeEditWin = Ext.create("Ext.ng.gh.baseWindow", {
                        title: '项目增加',
                        modal: true,
                        height: 300,
                        width: 450,
                        layout: 'border',
                        hideAction: 'close',
                        items: [
                            nodeEditWinPanel
                        ],
                        buttons: [
                            "->",
                            {
                                text: '确 认',
                                handler: function () {
                                    //检查名称是否重复
                                    //to do

                                    var formvf = nodeEditWinPanel.isValid();
                                    if (!formvf) {
                                        return;
                                    }
                                    if(pname!=""){
                                        nodeEditWinPanel.queryById("MC").setValue(pname+'-'+nodeEditWinPanel.queryById("MC").getValue());
                                    }
                                    var formData = nodeEditWinPanel.getFormData();
                                    var year = selectNode.data.id.substring(0, 4);
                                    Ext.Ajax.request({
                                        params: { "projlibprojformData": formData, "year": year },
                                        url: C_ROOT + 'GQT/QT/ProjLibProj/save',
                                        success: function (response) {
                                            var resp = Ext.JSON.decode(response.responseText);
                                            if (resp.Status === "success") {
                                                nodeEditWin.close();

                                                //Ext.getCmp("projectTree").store.reload();
                                                var treeP = Ext.getCmp("projectTree");
                                                var selectNode = treeP.getSelectionModel().lastSelected;
                                                var pnode = selectNode.parentNode;
                                                if (Ext.isEmpty(pnode)) {
                                                    pnode = treeP.stroe.getRootNode();
                                                }
                                                var newnode = [{ PhId: resp.Data.PhId, id: resp.Data.DM, text: resp.Data.MC, leaf: false }];
                                                pnode.appendChild(newnode);
                                                pnode.set('leaf', false);
                                                treeP.expandNode(pnode);
                                                treeP.getSelectionModel().select(treeP.store.getById(resp.Data.DM)); //选中刚才增加的节点

                                                ///Ext.MessageBox.alert('提示', "保存成功");
                                            } else {
                                                Ext.MessageBox.alert('保存失败', resp.Msg);
                                            }
                                        }
                                    });

                                }
                            },
                            {
                                text: '取 消',
                                handler: function () {
                                    nodeEditWin.close();
                                }
                            }
                        ]
                    });

                    nodeEditWin.show();
                }
            });


            //增加下级
            projWinToolbar.items.get('addchild').on('click', function () {
                var treeP = Ext.getCmp("projectTree");
                var selectNode = treeP.getSelectionModel().lastSelected;
                if (Ext.isEmpty(selectNode)) {
                    setTimeout(function () {
                        Ext.MessageBox.alert("提示", "请选择节点,但不要选择根节点");
                        return;
                    }, 100);
                }

                if (selectNode.data.leaf) {
                    setTimeout(function () {
                        Ext.MessageBox.alert("提示", "请选择图标为'文件夹'样式的项目");
                        return;
                    }, 100);
                }
                else {
                    //弹出新增窗口
                    var nodeEditWinPanel = Ext.create('Ext.ng.TableLayoutForm', nodeEditWinPanel_Config);
                    nodeEditWinPanel.queryById("DEFSTR3").setValue(mainPanel_form.queryById("FDeclarationUnit").getValue());
                    var pCode = selectNode.data.id;
                    var pname=selectNode.data.text;
                    if (pCode == "root") {
                        //
                        pCode = "";
                        pname="";
                    }
                    nodeEditWinPanel.queryById("DEFSTR2").setValue(pCode);
                    Ext.Ajax.request({
                        params: { "parentCode": pCode ,"year":sessionStorage.getItem("FYear")},
                        url: C_ROOT + 'GQT/QT/ProjLibProj/getCode',
                        success: function (response) {
                            nodeEditWinPanel.queryById("DM").setValue(response.text);
                        }
                    });

                    var nodeEditWin = Ext.create("Ext.ng.gh.baseWindow", {
                        title: '项目增加',
                        modal: true,
                        height: 300,
                        width: 450,
                        layout: 'border',
                        hideAction: 'close',
                        items: [
                            nodeEditWinPanel
                        ],
                        buttons: [
                            "->",
                            {
                                text: '确 认',
                                handler: function () {

                                    //检查名称是否重复
                                    //to do

                                    /*var pnode = selectNode;
                                    var pCode = pnode.data.id
                                    if (pCode == "root") {
                                        //
                                    }
                                    else {
                                        nodeEditWinPanel.queryById("DEFSTR2").setValue(pCode); //设置父级代码
                                        var maxCode="0000", tmpCode;
                                        if (pnode.childNodes.length > 0) {
                                            for (var i = 0; i < pnode.childNodes.length; i++) {
                                                tmpCode = pCode.slice(-4);
                                                if (maxCode < tmpCode) {
                                                    maxCode = tmpCode;
                                                }
                                            }
                                        }

                                        maxCode = ("0000" + (parseInt(maxCode) + 1)).slice(-4);
                                        var newcode = pCode + maxCode;
                                        nodeEditWinPanel.queryById("DM").setValue(newcode);
                                    }*/

									var pnode = selectNode;
                                    var formvf = nodeEditWinPanel.isValid();
                                    if (!formvf) {
                                        return;
                                    }
                                    if(pname!=""){
                                        nodeEditWinPanel.queryById("MC").setValue(pname+'-'+nodeEditWinPanel.queryById("MC").getValue());
                                    }
                                    var formData = nodeEditWinPanel.getFormData();
                                    var year = selectNode.data.id.substring(0, 4);
                                    Ext.Ajax.request({
                                        params: { "projlibprojformData": formData, "year": year },
                                        url: C_ROOT + 'GQT/QT/ProjLibProj/save',
                                        success: function (response) {
                                            var resp = Ext.JSON.decode(response.responseText);
                                            if (resp.Status === "success") {
                                                nodeEditWin.close();

                                                var newnode = [{ PhId: resp.Data.PhId, id: resp.Data.DM, text: resp.Data.MC, leaf: false }];
                                                pnode.appendChild(newnode);
                                                pnode.set('leaf', false);
                                                treeP.expandNode(pnode);
                                                treeP.getSelectionModel().select(treeP.store.getById(resp.Data.DM)); //选中刚才增加的节点

                                                ///Ext.MessageBox.alert('提示', "保存成功");
                                            } else {
                                                Ext.MessageBox.alert('保存失败', resp.Msg);
                                            }
                                        }
                                    });

                                }
                            },
                            {
                                text: '取 消',
                                handler: function () {
                                    nodeEditWin.close();
                                }
                            }
                        ]
                    });

                    nodeEditWin.show();
                }
            });

            /*var nodeEditWinPanel_Config = {
                region: 'center',
                frame: true,
                split: true,
                minWidth: 490,
                buskey: 'PhId', //对应的业务表主键
                otype: "edit", //操作类型,add||edit,
                border: 0,
                id: "EditPanel",
                buskey: "PhId",
                bindtable: "Z_QTGKXM",
                desTitle: "编辑面板",
                columnsPerRow: 1,
                fields: [
                    {
                        fieldLabel: "项目代码",
                        itemId: "DM",
                        name: "DM",
                        maxLength: 255,
                        langKey: "DM",
                        xtype: "ngText"
                    },
                    {
                        fieldLabel: "项目名称",
                        itemId: "MC",
                        name: "MC",
                        maxLength: 250,
                        langKey: "MC",
                        xtype: "ngText"
                    },
                    {
                        fieldLabel: "父节点代码",
                        itemId: "DEFSTR2",
                        name: "DEFSTR2",
                        maxLength: 255,
                        langKey: "DEFSTR2",
                        xtype: "ngText"
                    },
                    {
                        xtype: "container",
                        name: "hiddenContainer",
                        hidden: true,
                        items: [
                            {
                                xtype: "hiddenfield",
                                fieldLabel: "主键",
                                name: "PhId"
                            },
                            {
                                xtype: "hiddenfield",
                                fieldLabel: "记录版本",
                                name: "NgRecordVer"
                            }
                        ]
                    }
                ]

            };*/


            var BudgetEditPanel_Config = {
                region: 'center',
                frame: true,
                split: true,
                minWidth: 490,
                buskey: 'PhId', //对应的业务表主键
                otype: "edit", //操作类型,add||edit,
                border: 0,
                id: "EditPanel",
                //buskey: "PhId",
                bindtable: "z_QtBaseProject",
                desTitle: "编辑面板",
                columnsPerRow: 1,
                fields: [
                    {
                        fieldLabel: "资金来源",
                        itemId: "FSourceOfFunds_EXName",
                        name: "FSourceOfFunds_EXName",
                        maxLength: 250,
                        langKey: "FSourceOfFunds_EXName",
                        helpid: "GHSourceOfFunds",
                        valueField: "dm",
                        displayField: "mc",
                        userCodeField: "dm",
                        ORMMode: false,
                        isInGrid: true,
                        helpResizable: true,
                        xtype: "ngRichHelp"
                    },
                    {
                        fieldLabel: "资金来源代码",
                        itemId: "FSourceOfFunds",
                        name: "FSourceOfFunds",
                        maxLength: 250,
                        langKey: "FSourceOfFunds",
                        xtype: "ngText",
                        hidden: true
                    },
                    {
                        fieldLabel: "支付方式",
                        itemId: "FPaymentMethod_EXName",
                        name: "FPaymentMethod_EXName",
                        maxLength: 250,
                        langKey: "FPaymentMethod_EXName",
                        helpid: "GHPaymentMethod",
                        valueField: "dm",
                        displayField: "mc",
                        userCodeField: "dm",
                        ORMMode: false,
                        isInGrid: true,
                        helpResizable: true,
                        xtype: "ngRichHelp"
                    },
                    {
                        fieldLabel: "支付方式代码",
                        itemId: "FPaymentMethod",
                        name: "FPaymentMethod",
                        maxLength: 250,
                        langKey: "FPaymentMethod",
                        xtype: "ngText",
                        hidden: true
                    },
                    {
                        fieldLabel: "预算科目",
                        itemId: "FBudgetAccounts_EXName",
                        name: "FBudgetAccounts_EXName",
                        maxLength: 250,
                        langKey: "FBudgetAccounts_EXName",
                        helpid: "GHBudgetAccounts",
                        valueField: "kmdm",
                        displayField: "kmmc",
                        userCodeField: "kmdm",
                        ORMMode: false,
                        isInGrid: true,
                        helpResizable: true,
                        xtype: "ngRichHelp"
                    },
                    {
                        fieldLabel: "预算科目代码",
                        itemId: "FBudgetAccounts",
                        name: "FBudgetAccounts",
                        maxLength: 250,
                        langKey: "FBudgetAccounts",
                        xtype: "ngText",
                        hidden: true
                    },
                    {
                        fieldLabel: "支出渠道",
                        itemId: "FExpensesChannel_EXName",
                        name: "FExpensesChannel_EXName",
                        maxLength: 250,
                        langKey: "FExpensesChannel_EXName",
                        helpid: "GHExpensesChannel",
                        valueField: "ocode",
                        displayField: "oname",
                        userCodeField: "ocode",
                        ORMMode: false,
                        isInGrid: true,
                        helpResizable: true,
                        xtype: "ngRichHelp"
                    },
                    {
                        fieldLabel: "支出渠道代码",
                        itemId: "FExpensesChannel",
                        name: "FExpensesChannel",
                        maxLength: 250,
                        langKey: "FExpensesChannel",
                        xtype: "ngText",
                        hidden: true
                    },
                    {
                        fieldLabel: "全选",
                        itemId: "selectall",
                        name: "selectall",
                        maxLength: 250,
                        langKey: "selectall",
                        xtype: "checkbox"
                    },

                ]

            };

            ngToolbar.items.get('copy').on('click', function () {
                var BudgetEditPanel = Ext.create('Ext.ng.TableLayoutForm', BudgetEditPanel_Config);
                BudgetEditPanel.queryById("FSourceOfFunds_EXName").on("helpselected", function (str) {
                    BudgetEditPanel.queryById("FSourceOfFunds_EXName").setValue(str.name);
                    BudgetEditPanel.queryById("FSourceOfFunds").setValue(str.code);
                })
                BudgetEditPanel.queryById("FPaymentMethod_EXName").on("helpselected", function (str) {
                    BudgetEditPanel.queryById("FPaymentMethod_EXName").setValue(str.name);
                    BudgetEditPanel.queryById("FPaymentMethod").setValue(str.code);
                })
                BudgetEditPanel.queryById("FBudgetAccounts_EXName").on("helpselected", function (str) {
                    BudgetEditPanel.queryById("FBudgetAccounts_EXName").setValue(str.name);
                    BudgetEditPanel.queryById("FBudgetAccounts").setValue(str.code);
                })
                BudgetEditPanel.queryById("FExpensesChannel_EXName").on("helpselected", function (str) {
                    BudgetEditPanel.queryById("FExpensesChannel_EXName").setValue(str.name);
                    BudgetEditPanel.queryById("FExpensesChannel").setValue(str.code);
                })

                BudgetEditPanel.queryById("FBudgetAccounts_EXName").on("beforetriggerclick", function (str) {
                    var FDeclarationUnit = mainPanel_form.queryById("FDeclarationUnit").getValue();
                    if (!FDeclarationUnit) {
                        Ext.MessageBox.alert("提示", '申报单位不能为空');
                        return false;
                    }
                    var filter = "(Z_QTDYGX.DEF_STR1='" + FDeclarationUnit + "' and Z_QTYSKM.KMLB='1')";
                    BudgetEditPanel.queryById("FBudgetAccounts_EXName").setClientSqlFilter(filter);

                });
                BudgetEditPanel.queryById('FExpensesChannel_EXName').on("beforetriggerclick", function (str) {
                    var FDeclarationUnit = mainPanel_form.queryById("FDeclarationUnit").getValue();
                    if (!FDeclarationUnit) {
                        Ext.MessageBox.alert("提示", '申报单位不能为空');
                        return false;
                    }
                    BudgetEditPanel.queryById("FExpensesChannel_EXName").setOutFilter({ DWDM: FDeclarationUnit });

                });
                if (ProjStatus == '1') {
                    BudgetEditPanel.queryById("FBudgetAccounts_EXName").hide();
                    BudgetEditPanel.queryById("FExpensesChannel_EXName").hide();
                }

                var win = Ext.create('Ext.window.Window', {
                    title: '批量修改',
                    height: 230,
                    width: 488,
                    modal: true,
                    //closable:true,
                    //closeAction:'hide',
                    items: [
                        BudgetEditPanel
                    ],
                    buttons: [
                        {
                            xtype: "button",
                            text: "确认",
                            handler: function () {
                                //alert(BudgetEditPanel.queryById("selectall").value);
                                var FSourceOfFunds = BudgetEditPanel.queryById("FSourceOfFunds").value;
                                var FSourceOfFunds_EXName = BudgetEditPanel.queryById("FSourceOfFunds_EXName").value;
                                var FPaymentMethod = BudgetEditPanel.queryById("FPaymentMethod").value;
                                var FPaymentMethod_EXName = BudgetEditPanel.queryById("FPaymentMethod_EXName").value;
                                var FBudgetAccounts = BudgetEditPanel.queryById("FBudgetAccounts").value;
                                var FBudgetAccounts_EXName = BudgetEditPanel.queryById("FBudgetAccounts_EXName").value;
                                var FExpensesChannel = BudgetEditPanel.queryById("FExpensesChannel").value;
                                var FExpensesChannel_EXName = BudgetEditPanel.queryById("FExpensesChannel_EXName").value;

                                if (BudgetEditPanel.queryById("selectall").value == true) {
                                    for (var i = 0; i < BudgetDtlPanel_store.getCount(); i++) {
                                        BudgetDtlPanel_store.getAt(i).set('FSourceOfFunds', FSourceOfFunds);
                                        BudgetDtlPanel_store.getAt(i).set('FSourceOfFunds_EXName', FSourceOfFunds_EXName);
                                        BudgetDtlPanel_store.getAt(i).set('FPaymentMethod', FPaymentMethod);
                                        BudgetDtlPanel_store.getAt(i).set('FPaymentMethod_EXName', FPaymentMethod_EXName);
                                        BudgetDtlPanel_store.getAt(i).set('FBudgetAccounts', FBudgetAccounts);
                                        BudgetDtlPanel_store.getAt(i).set('FBudgetAccounts_EXName', FBudgetAccounts_EXName);
                                        BudgetDtlPanel_store.getAt(i).set('FExpensesChannel', FExpensesChannel);
                                        BudgetDtlPanel_store.getAt(i).set('FExpensesChannel_EXName', FExpensesChannel_EXName);
                                    }
                                } else {
                                    var data = BudgetDtlPanel_grid.getSelectionModel().getSelection();
                                    for (var j = 0; j < data.length; j++) {
                                        data[j].set('FSourceOfFunds', FSourceOfFunds);
                                        data[j].set('FSourceOfFunds_EXName', FSourceOfFunds_EXName);
                                        data[j].set('FPaymentMethod', FPaymentMethod);
                                        data[j].set('FPaymentMethod_EXName', FPaymentMethod_EXName);

                                        data[j].set('FBudgetAccounts', FBudgetAccounts);
                                        data[j].set('FBudgetAccounts_EXName', FBudgetAccounts_EXName);
                                        data[j].set('FExpensesChannel', FExpensesChannel);
                                        data[j].set('FExpensesChannel_EXName', FExpensesChannel_EXName);
                                    }
                                }

                                win.close();
                            }
                        },
                        {
                            xtype: "button",
                            text: "取消",
                            handler: function () {
                                win.close();
                            }
                        }
                    ]

                });
                win.show();
            });
            

        projWinToolbar.items.get('edit').on('click', function () {
            var treeP = Ext.getCmp("projectTree");
            var selectNode = treeP.getSelectionModel().lastSelected;
            if (Ext.isEmpty(selectNode)) {
                setTimeout(function () {
                    Ext.MessageBox.alert("提示", "请选择节点,但不要选择根节点");
                    return;
                }, 100);
            }
            var canedit=true;
            Ext.Ajax.request({
                params: { "code": selectNode.data.id},
                url: C_ROOT + 'GQT/QT/ProjLibProj/JudgeCode',
                async:false,
                success: function (response) {
                    if (response.text== "true") {

                    } else {
                        canedit=false;
                        Ext.MessageBox.alert("提示", "该单据名称无法修改！");
                        return;
                    }

                    
                }
            });
            if(canedit==true){

                //弹出修改窗口
                var nodeEditWinPanel = Ext.create('Ext.ng.TableLayoutForm', nodeEditWinPanel_Config);
                //nodeEditWinPanel.queryById("DEFSTR3").setValue(mainPanel_form.queryById("FDeclarationUnit").getValue());
                if(selectNode.data.parentId=='root'){
                    nodeEditWinPanel.queryById("DEFSTR2").setValue('');
                }else{
                    nodeEditWinPanel.queryById("DEFSTR2").setValue(selectNode.data.parentId);// parentCode
                }
                nodeEditWinPanel.queryById("MC").setValue(selectNode.data.text);
                nodeEditWinPanel.queryById("DM").setValue(selectNode.data.id);



                var nodeEditWin = Ext.create("Ext.ng.gh.baseWindow", {
                    title: '项目修改',
                    modal: true,
                    height: 300,
                    width: 450,
                    layout: 'border',
                    hideAction: 'close',
                    items: [
                        nodeEditWinPanel
                    ],
                    buttons: [
                        "->",
                        {
                            text: '确 认',
                            handler: function () {



                                var formvf = nodeEditWinPanel.isValid();
                                if (!formvf) {
                                    return;
                                }

                                var formData = nodeEditWinPanel.getFormData();
                                Ext.Ajax.request({
                                    params: { "DM": nodeEditWinPanel.queryById("DM").getValue(), "MC": nodeEditWinPanel.queryById("MC").getValue()},
                                    url: C_ROOT + 'GXM/XM/ProjectMst/UpdateMC',
                                    success: function (response) {
                                        var resp = Ext.JSON.decode(response.responseText);
                                        if (resp.Status === "success") {
                                            var MC=nodeEditWinPanel.queryById("MC").getValue();
                                            Ext.MessageBox.alert('提示', "保存成功");
                                            selectNode.set("text", MC);
                                            nodeEditWin.close();
                                        } else {
                                            Ext.MessageBox.alert('保存失败', resp.Msg);
                                        }
                                    }
                                });

                            }
                        },
                        {
                            text: '取 消',
                            handler: function () {
                                nodeEditWin.close();
                            }
                        }
                    ]
                });

                nodeEditWin.show();
            }

        })

		projWinToolbar.items.get('ok').on('click', function () {
			var treeP = Ext.getCmp("projectTree");
            var record = treeP.getSelectionModel().lastSelected;
			treeP.expandNode(record);
			setTimeout(function () {
					if (record.data.leaf) {
						setTimeout(function () {
							Ext.MessageBox.alert("提示", "请选择图标为'文件夹'样式的项目");
							return;
						}, 100);
					}
					else {
						if (record.childNodes.length > 0)
						{
							Ext.MessageBox.alert("提示", "请选择末级项目");
							return;
						}
						if (record.data.id == "root") {
							setTimeout(function () {
								Ext.MessageBox.alert("提示", "不能选择根节点");
								return;
							}, 100);
						}
						else {
							SetProjCodeAndName({ "code": record.data.id, "name": record.data.text }, "ref");
							projWin.close();
						}
					}
				}, 100);

		});


            //删除
            projWinToolbar.items.get('delete').on('click', function () {
                var treeP = Ext.getCmp("projectTree");
                var selectNode = treeP.getSelectionModel().lastSelected;
                treeP.expandNode(selectNode);
                setTimeout(function () {
                    if (selectNode.hasChildNodes()) {
                        //setTimeout(function () {
                        Ext.MessageBox.alert("提示", "存在下级项目，请先删除下级项目后，再删除此项目");
                        return;
                        //}, 100);
                    }
                    if (selectNode.data.leaf) {
                        setTimeout(function () {
                            Ext.MessageBox.alert("提示", "请选择图标为'文件夹'样式的项目");
                            return;
                        }, 100);
                    }
                    else {
                        Ext.MessageBox.confirm("提示", "删除当前选中项目吗?", function (opt) {
                            if (opt.toString() == "no" || opt.toString() == "cancel") {
                                return;
                            } else {
                                Ext.Ajax.request({
                                    params: { 'id': selectNode.data.PhId },
                                    url: C_ROOT + 'GQT/QT/ProjLibProj/Delete',
                                    success: function (response) {
                                        var resp = Ext.JSON.decode(response.responseText);
                                        if (resp.Status === "success") {
                                            setTimeout(function () {
                                                SetProjCodeAndName({ "code": selectNode.data.id, "name": selectNode.data.text }, "delete");
                                                selectNode.remove();
                                                Ext.MessageBox.alert("提示", "删除成功!");
                                                return;
                                            }, 100);
                                        } else {
                                            setTimeout(function () {
                                                Ext.MessageBox.alert("提示", "删除失败!");
                                                return;
                                            }, 100);
                                        }
                                    }
                                });
                            }
                        });
                    }
                }, 100);
            });
            if (mainPanel_form.queryById("FProjName")) {
                //点击项目名称，弹出窗口
                mainPanel_form.queryById("FProjName").onTriggerClick = function (e) {
                    projWinTreePanel = Ext.create('Ext.ng.TreePanel', {
                        id: "projectTree",
                        region: "center",
                        rootVisible: true,
                        root: {
                            text: "项目树",
                            expanded: true
                        },
                        treeFields: [
                            { name: 'PhId', type: 'string' },
                            { name: 'text', type: 'string' },
                            { name: 'curentCode', type: 'string' },
                            { name: 'parentCode', type: 'string' },
                            { name: 'isProject', type: 'string' }
                        ],
                        url: '@Url.Content("~/GXM/XM/ProjectMst/LoadProjTree")' + '?OrgCode=' + mainPanel_form.queryById("FDeclarationUnit").getValue(),


                        //url: '@Url.Content("~/GXM/XM/ProjectMst/LoadProjTree?OrgCode=")',
                        listeners: {
                            'selectionchange': function (treepanel, rcds, eOpts) {
                                oldPhidItem = phidItem;
                                phidItem = rcds[0].data.PhId;
                            },
                            'select': function (treepanel, record, index, eOpts) {
                                //var text = record.data.text;
                                //var text2 = Ext.getCmp("projectTree").getSelectionModel().lastSelected.data.text;
                                ////treepanel.getSelection()[0].data.text
                                ////Ext.getCmp("projectTree").getSelectionModel().lastSelected.data.text

                                //setTimeout(function () { Ext.MessageBox.alert(text); }, 100)
                            },
                            'itemdblclick': function (treepanel, record, item, index, e, eOpts) {
                                var text = record.data.text;
                                var treeP = Ext.getCmp("projectTree");
                                treeP.expandNode(record);
                                setTimeout(function () {
                                    if (record.data.leaf) {
                                        setTimeout(function () {
                                            Ext.MessageBox.alert("提示", "请选择图标为'文件夹'样式的项目");
                                            return;
                                        }, 100);
                                    }
                                    else {
                                        if (record.childNodes.length > 0) {
                                            Ext.MessageBox.alert("提示", "请选择末级项目");
                                            return;
                                        }
                                        if (record.data.id == "root") {
                                            setTimeout(function () {
                                                Ext.MessageBox.alert("提示", "不能选择根节点");
                                                return;
                                            }, 100);
                                        }
                                        else {
                                            SetProjCodeAndName({ "code": record.data.id, "name": record.data.text }, "ref");
                                            projWin.close();
                                        }
                                    }
                                }, 100);
                            },
                            'afterrender': function () {
                                var recode = this.getStore().getNodeById('root');
                                this.getSelectionModel().select(recode);
                            }
                        }
                    });

                    projWin = Ext.create("Ext.ng.gh.baseWindow", {
                        title: '项目',
                        modal: true,
                        height: 450,
                        width: 520,//350
                        layout: 'border',
                        items: [
                            projWinToolbar,
                            projWinTreePanel
                        ]
                    });
                    if (mainPanel_form.queryById("FDeclarationUnit").getValue() != "") {
                        projWin.show();
                    } else {
                        Ext.MessageBox.alert("提示", '请先选择申报单位！');
                    }
                };
            }


            function SetProjCodeAndName(treeItem, option) {
                if (option == "ref") {
                    Ext.Ajax.request({
                        params: { "code": treeItem.code },
                        url: C_ROOT + 'GXM/XM/ProjectMst/JudgeIf',
                        success: function (response) {
                            if (response.text == "1") {
                                Ext.MessageBox.alert("提示", '该项目已经录入预算数据');
                            } else {
                                mainPanel_form.queryById("FProjName").setValue(treeItem.name);
                                mainPanel_form.queryById("FProjCode").setValue(treeItem.code);
                            }
                        }

                    });
                }

                if (option == "delete") {
                    //清空已引用数据
                    if (mainPanel_form.queryById("FProjCode").value == treeItem.code) {
                        mainPanel_form.queryById("FProjName").setValue("");
                        mainPanel_form.queryById("FProjCode").setValue("");
                    }
                }
            }
            //========================================================================//
            if (BudgetDtlPanel_grid.getColumn('FSourceOfFunds_EXName').getEditor()) {
                //资金来源
                BudgetDtlPanel_grid.getColumn('FSourceOfFunds_EXName').getEditor().on("beforetriggerclick", function (str) {
                    //var FDeclarationUnit = Ext.getCmp('FDeclarationUnit').getValue();
                    var FDeclarationUnit = mainPanel_form.queryById("FDeclarationUnit").getValue();
                    if (!FDeclarationUnit) {
                        Ext.MessageBox.alert("提示", '申报单位不能为空');
                        return false;
                    }
                    var filter = "(Z_QTDYGX.DEF_STR1='" + FDeclarationUnit + "')";
                    BudgetDtlPanel_grid.getColumn('FSourceOfFunds_EXName').getEditor().setClientSqlFilter(filter);

                });

                BudgetDtlPanel_grid.getColumn('FSourceOfFunds_EXName').getEditor().on('helpselected', function (obj) {


                    if (memoWinShow == true) {   //批注界面打开的，则为批注时触发

                        Ext.Ajax.request({
                            params: { "Code": obj.code },
                            url: C_ROOT + 'GQT/QT/SourceOfFunds/IfLastStage',
                            success: function (response) {
                                var resp = Ext.JSON.decode(response.responseText);
                                //debugger;
                                if (resp != null && resp != undefined) {
                                    if (resp.Data.length > 0) {
                                        Ext.MessageBox.alert("提示", '请选择末级资金来源');
                                        return false;
                                    } else {
                                        var selection = Memogrid.getSelectionModel().getSelection();
                                        selection[0].set('AfterCode', obj.code);//代码
                                        selection[0].set('AfterName', obj.name);//名称
                                        return false;
                                    }
                                }
                            }

                        });

                        //var selection = Memogrid.getSelectionModel().getSelection();
                        //selection[0].set('AfterCode', obj.code);//代码
                        //selection[0].set('AfterName', obj.name);//名称
                        return false;
                    }

                    var data = BudgetDtlPanel_grid.getSelectionModel().getSelection();
                    //判断资金来源是否是末级组织
                    //  var FSourceOfFunds_EXName_code = BudgetDtlPanel_grid.getColumn('FSourceOfFunds_EXName').getEditor().getValue();

                    Ext.Ajax.request({
                        params: { "Code": obj.code },
                        url: C_ROOT + 'GQT/QT/SourceOfFunds/IfLastStage',
                        success: function (response) {
                            var resp = Ext.JSON.decode(response.responseText);
                            //debugger;
                            if (resp != null && resp != undefined) {
                                if (resp.Data.length > 0) {
                                    data[0].set('FSourceOfFunds', '');
                                    data[0].set('FSourceOfFunds_EXName', '');
                                    Ext.MessageBox.alert("提示", '请选择末级资金来源');
                                } else {
                                    data[0].set('FSourceOfFunds', obj.code);
                                    data[0].set('FSourceOfFunds_EXName', obj.name);
                                }
                            }
                        }

                    });
                });
            }
            if (BudgetDtlPanel_grid.getColumn('FPaymentMethod_EXName').getEditor()) {
                BudgetDtlPanel_grid.getColumn('FPaymentMethod_EXName').getEditor().on('helpselected', function (obj) {

                    if (memoWinShow == true) {   //批注界面打开的，则为批注时触发
                        var selection = Memogrid.getSelectionModel().getSelection();
                        selection[0].set('AfterCode', obj.code);//代码
                        selection[0].set('AfterName', obj.name);//名称
                        return false;
                    }

                    var data = BudgetDtlPanel_grid.getSelectionModel().getSelection();
                    data[0].set('FPaymentMethod', obj.code);
                    data[0].set('FPaymentMethod_EXName', obj.name);
                });
            }

            BudgetDtlPanel_grid.getColumn('FAmount').renderer = function (val) {
                if (val) {
                    var moneyRend = Ext.util.Format.usMoney;
                    var newvalue = moneyRend(val);
                    return newvalue.replace('$', '');
                } else {
                    return '';
                }
            };

            FundApplPanel_grid.getColumn('FAmount').renderer = function (val) {
                if (val) {
                    var moneyRend = Ext.util.Format.usMoney;
                    var newvalue = moneyRend(val);
                    return newvalue.replace('$', '');
                } else {
                    return '';
                }
            };

            //控制系统选入的一些列不可编辑
            PerformTargetPanel_grid.on("beforeedit", function (editor, e, eOpts) {
                //Ext.MessageBox.alert("提示", "e:" + e);
                if (e.record.data) {
                    if ((e.field == "FTargetTypeCode_EXName" || e.field == "FTargetClassCode_EXName" || e.field == "FTargetCode") && e.record.data.FIfCustom == 2) {
                        return false;
                    }
                    else {
                        return true;
                    }
                }
            });
            if (PerformTargetPanel_grid.getColumn('FTargetCode').getEditor()) {
                PerformTargetPanel_grid.getColumn('FTargetCode').getEditor().on('helpselected', function (obj) {
                    var data = PerformTargetPanel_grid.getSelectionModel().getSelection();
                    data[0].set('FTargetCode', obj.code);
                    data[0].set('FTargetCode_EXName', obj.name);
                    data[0].set('FTargetTypeCode', obj.data.f_targettypecode);
                    data[0].set('FTargetClassCode', obj.data.f_targetclasscode);
                    data[0].set('FTargetName', obj.data.f_targetname);
                    data[0].set('FTargetValue', obj.data.f_targetvalue);
                    data[0].set('FTargetWeight', obj.data.f_targetweight);
                    data[0].set('FTargetDescribe', obj.data.f_targetdescribe);

                    data[0].set('FTargetClassCode_EXName', obj.data.classname);
                    data[0].set('FTargetTypeCode_EXName', obj.data.typename);
                    data[0].set('FIfCustom', 2);

                    PerformTargetPanel_store.sort();
                    ExsplitGrid(PerformTargetPanel_grid, [3, 4, 5]); //还原单元格
                    ExMergeGrid(PerformTargetPanel_grid, [3, 4, 5], false); //合并单元格
                });
            }
            if (PerformTargetPanel_grid.getColumn('FTargetTypeCode_EXName').getEditor()) {
                PerformTargetPanel_grid.getColumn('FTargetTypeCode_EXName').getEditor().on('helpselected', function (obj) {
                    var data = PerformTargetPanel_grid.getSelectionModel().getSelection();
                    data[0].set('FTargetTypeCode', obj.data.FCode);
                    data[0].set('FTargetTypeCode_EXName', obj.data.FName);

                    //PerformTargetPanel_store.sort();
                    ExsplitGrid(PerformTargetPanel_grid, [3, 4, 5]); //还原单元格
                    ExMergeGrid(PerformTargetPanel_grid, [3, 4, 5], false); //合并单元格
                });
            }
            if (PerformTargetPanel_grid.getColumn('FTargetClassCode_EXName').getEditor()) {
                PerformTargetPanel_grid.getColumn('FTargetClassCode_EXName').getEditor().on('helpselected', function (obj) {
                    var data = PerformTargetPanel_grid.getSelectionModel().getSelection();
                    data[0].set('FTargetClassCode', obj.data.FCode);
                    data[0].set('FTargetClassCode_EXName', obj.data.FName);

                    PerformTargetPanel_store.sort();
                    ExsplitGrid(PerformTargetPanel_grid, [3, 4, 5]); //还原单元格
                    ExMergeGrid(PerformTargetPanel_grid, [3, 4, 5], false); //合并单元格
                });
            }
            //日期格式
            ImplPlanPanel_grid.getColumn('FStartDate').renderer = function (val) {
                if (val) {
                    var str = Ext.util.Format.date(val, 'Y-m-d');
                    return str;
                } else {
                    return '';
                }
            };

            ImplPlanPanel_grid.getColumn('FEndDate').renderer = function (val) {
                if (val) {
                    var str = Ext.util.Format.date(val, 'Y-m-d');
                    return str;
                } else {
                    return '';
                }
            };

            //预立项时隐藏预算金额,预算科目,支出渠道
            /*if (ProjStatus == "1") {
                //mainPanel_form.queryById("FBudgetAmount").hide();
                BudgetDtlPanel_grid.getColumn('FBudgetAccounts_EXName').hide();
                BudgetDtlPanel_grid.getColumn('FExpensesChannel_EXName').hide();

            } else {
                BudgetDtlPanel_grid.getColumn('FBudgetAccounts_EXName').show();
                BudgetDtlPanel_grid.getColumn('FExpensesChannel_EXName').show();

            }*/


            //附件方法
            function OpenAttachment(buscode) {
                var param = {
                    product: "", //传相应产品，i6、i6s、i6P、A3、GE，可为空
                    attachguid: attachGuid, //会话guid,可传空生成方法cs代码:Guid.NewGuid().ToString()
                    attachTName: "c_pfc_attachment",
                    busTName: "xm3_ProjectMst", //传相应业务表
                    busid: busid, //传相应产品业务单据phid
                    bustypecode: "GHProjectInfo"//业务类型编码
                };
                var result = LoadAttach.InitBeforeOpen(param);
                var obj = eval(result);
                if (obj) {
                    if (obj.status == "success") //初始化成功
                    {
                        attachGuid = obj.msg;
                    } else {
                        Ext.MessageBox.alert('提示', "附件初始化失败");
                        return;
                    }
                } else {
                    Ext.MessageBox.alert('提示', "附件初始化失败");
                    return;
                }
                var opt = {
                    product: "", //传相应产品，可为空
                    mode: "NG3", //固定传NG3
                    openbymianframe: "1", //通过主框架打开附件 0或空否  1 是固定传1
                    oper: "winfrom", //web、pb、winfrom、progress（进度条模式）,固定传 winfrom
                    asr_tbl: "c_pfc_attachment",
                    tbl: "xm3_ProjectMst", //传相应业务表
                    fill: $appinfo.logid, //传相应操作员id
                    fillname: $appinfo.username, //传相应操作员姓名
                    chkSign: "0", //默认传0
                    chkCheckIn: "0", //默认传0
                    btnAdd: "1", //新增按钮oper非web时有效 0、禁用 1、显示 2、隐藏
                    addserverstuts: "0", //导入按钮oper非web时有效 0、禁用 1、显示 2、隐藏
                    btnScan: "1", //扫描按钮oper非web时有效 0、禁用 1、显示 2、隐藏
                    btnDelete: "1", //删除按钮oper非web时有效 0、禁用 1、显示 2、隐藏
                    btnEdit: "1", //编辑按钮oper非web时有效 0、禁用 1、显示 2、隐藏
                    btnView: "1", //查看按钮oper非web时有效 0、禁用 1、显示 2、隐藏
                    btnDownload: "1", //下载按钮oper非web时有效 0、禁用 1、显示 2、隐藏
                    btnCancel: "1", //取消按钮oper非web时有效 0、禁用 1、显示 2、隐藏
                    btnOk: "1", //确定按钮oper非web时有效 0、禁用 1、显示 2、隐藏
                    btnWebAdd: "2", //web新增按钮oper为web时有效 0、禁用 1、显示 2、隐藏
                    btnWebOk: "2", //web新增按钮oper为web时有效 0、禁用 1、显示 2、隐藏
                    archivestuts: "2", //归档按钮oper非web时有效 0、禁用 1、显示 2、隐藏
                    status: otypePurchase, //add 新增模式，view 查看模式， edit 编辑模式
                    showlist: "1", //显示文件列表 0 不显示 1显示
                    zip: "0", //附件压缩 0 不压缩 1 压缩
                    filenum: "", //附件上传数量限制 0或空不限制附件上传数量
                    filetype: "", //附件上传类型限制目前仅支持传入"image",如果传了"image"附件控件就只能上传图片
                    guid: attachGuid //传第二步附件初始化获得的guid
                };
                LoadAttach.Init(opt);
            }
            //默认先将附件信息带出
            InitAttachment();
            //附件信息初始化
            function InitAttachment() {
                var param = {
                    product: "", //传相应产品，i6、i6s、i6P、A3、GE，可为空
                    attachguid: attachGuid, //会话guid,可传空生成方法cs代码:Guid.NewGuid().ToString()
                    attachTName: "c_pfc_attachment",
                    busTName: "xm3_ProjectMst", //传相应业务表
                    busid: busid, //传相应产品业务单据phid
                    bustypecode: "GHProjectInfo"//业务类型编码
                };
                var result = LoadAttach.InitBeforeOpen(param);
                var obj = eval(result);
                if (obj) {
                    if (obj.status == "success") //初始化成功
                    {
                        attachGuid = obj.msg;
                    } else {
                        Ext.MessageBox.alert('提示', "附件初始化失败");
                        return;
                    }
                } else {
                    Ext.MessageBox.alert('提示', "附件初始化失败");
                    return;
                }
            }

            //控制工作流ui可编辑属性
            function SyncWorkFlowUI(workInfo) {
                //if (otype == $Otype.VIEW) return;

                var fld, fldName, fldValue, pos;
                var BudgetDtlPanelEditable = false;
                var ImplPlanPanelEditable = false;


                for (var i = 0; i < workInfo.biz_properties.length; i++)
                {
                    fld = workInfo.biz_properties[i];
                    pos = fld.control_id.indexOf('BudgetDtlPanel#');
                    if ( pos >= 0) {
                        fldName = fld.control_id.substr(pos + 'BudgetDtlPanel#'.length);
                        if (fldName) {
                            fldValue = fld.value;
                            if (fldValue == 1) {
                                BudgetDtlPanel_grid.setReadOnlyCol(fldName, false);
                                BudgetDtlPanelEditable = true;
                            }
                            else {
                                BudgetDtlPanel_grid.setReadOnlyCol(fldName, true);
                            }
                        }
                    }

                    pos = fld.control_id.indexOf('ImplPlanPanel#');
                    if (fld.control_id.indexOf('ImplPlanPanel#') >= 0) {
                        fldName = fld.control_id.substr(pos + 'ImplPlanPanel#'.length);
                        if (fldName) {
                            fldValue = fld.value;
                            if (fldValue == 1) {
                                ImplPlanPanel_grid.setReadOnlyCol(fldName, false);
                                ImplPlanPanelEditable = true;
                            }
                            else {
                                ImplPlanPanel_grid.setReadOnlyCol(fldName, true);
                            }
                        }
                    }

                }

                if (BudgetDtlPanelEditable) {
                    BudgetDtlPanel_grid.setGridReadOnly(false);
                }

                if (ImplPlanPanelEditable) {
                    ImplPlanPanel_grid.setGridReadOnly(false);
                }

            }

            //获取绩效评价指标
            function getPerformTarget(performTypeCode, clearStore) {

                if (PerformTargetPanel_store.getCount() > 0)
                {
                    var typeCode = PerformTargetPanel_store.getAt(0).get("FTargetTypeCode");
                    if (typeCode == performTypeCode)
                    {
                        return;
                    }
                }

                Ext.Ajax.request({
                    params: { 'clientSqlFilter': "Z_QTPerformEvalTarget.f_TargetTypeCode='" + performTypeCode + "'" },
                    url: C_ROOT + 'SUP/RichHelp/GetHelpList?helpid=GHPerformEvalTarget&ORMMode=false',
                    async: false, //同步请求
                    success: function (response) {
                        var resp = Ext.decode(response.responseText);

                        if (resp.Record) {
                            if (clearStore)  //清除原来记录
                            {
                                PerformTargetPanel_store.removeAll();
                            }

                            var records = resp.Record;
                            var data;
                            for (var i = 0; i < records.length; i++) {
                                data = {
                                    "FTargetCode": records[i].f_targetcode,
                                    "FTargetCode_EXName": records[i].f_targetname,
                                    "FTargetTypeCode": records[i].f_targettypecode,
                                    "FTargetClassCode": records[i].f_targetclasscode,
                                    "FTargetName": records[i].f_targetname,
                                    "FTargetValue": records[i].f_targetvalue,
                                    "FTargetWeight": records[i].f_targetweight,
                                    "FTargetDescribe": records[i].f_targetdescribe,
                                    "FTargetClassCode_EXName": records[i].classname,
                                    "FTargetTypeCode_EXName": records[i].typename,
                                    "FIfCustom": 2
                                };
                                PerformTargetPanel_store.add(data);
                            }

                            PerformTargetPanel_store.sort();
                            ExsplitGrid(PerformTargetPanel_grid, [3, 4, 5]); //还原单元格
                            ExMergeGrid(PerformTargetPanel_grid, [3, 4, 5], false); //合并单元格
                        }
                    }
                });
            }

            //检查绩效目标分解
            function checkPerformTarget() {
                var FIfPerformanceAppraisal = mainPanel_form.queryById("FIfPerformanceAppraisal").getValue();
                if (FIfPerformanceAppraisal == 1) {
                    var count = PerformTargetPanel_store.getCount();
                    //检查是否录入
                    if (count <= 0) {
                        hidePerformTargetTab(false, true);
                        Ext.MessageBox.alert('提示', "请输入绩效目标分解指标信息");
                        return false;
                    }

                    //检查权重合计是否为100%
                    var weightTotal = 0, weight = 0;
                    for (var i = 0; i < count; i++) {
                        weight = PerformTargetPanel_store.getAt(i).get('FTargetWeight') - 0;
                        weightTotal = weightTotal + weight;
                        var FTargetName=PerformTargetPanel_store.getAt(i).get('FTargetName');
                        if($GetLength(FTargetName)>255){
                            Ext.MessageBox.alert('提示', "指标名称输入字符超过最大长度(255)(中文算两个字符)！");
                            return false;
                        }
                        var FTargetValue=PerformTargetPanel_store.getAt(i).get('FTargetValue');
                        if($GetLength(FTargetValue)>100){
                            Ext.MessageBox.alert('提示', "指标值输入字符超过最大长度(100)(中文算两个字符)！");
                            return false;
                        }
                        var FTargetDescribe=PerformTargetPanel_store.getAt(i).get('FTargetDescribe');
                        if($GetLength(FTargetDescribe)>300){
                            Ext.MessageBox.alert('提示', "指标描述输入字符超过最大长度(300)(中文算两个字符)！");
                            return false;
                        }

                    }

                    if (weightTotal != 100) {
                        hidePerformTargetTab(false, true);
                        Ext.MessageBox.alert('提示', "指标权重合计必须为100");
                        return false;
                    }

                    return true;
                } else {
                    if((mainPanel_form.queryById("FTemporary")&&mainPanel_form.queryById("FTemporary").getValue()=='1')||(mainPanel_form.queryById("FZcType")&&(mainPanel_form.queryById("FZcType").getValue()=='2'||mainPanel_form.queryById("FZcType").getValue()=='3'))){
                        //临时项目、基本支出项目不需要判断绩效阈值
                    }else{
                        if (!controlProjectProjectThreshold()) //组织绩效项目阈值控制
                        {
                            return false;
                        }
                    }
                }

                return true;
            }


            //处理绩效目标分解tab页面的显示隐藏
            function hidePerformTargetTab(ishide, activetab) {
                if (ishide) {
                    /*if (tabPanel.tabBar.items.length >= 7) {
                        tabPanel.tabBar.items.getAt(6).hide();
                    }
                    var tab = Ext.getCmp("TabPage9");
                    var tab7 = Ext.getCmp("TabPage7");
                    if (tab && tab7) {
                        if (activetab) {
                            tabPanel.setActiveTab(tab7);
                        }
                        tab.hide();
                    }*/
                    for (var i = 0; i < tabPanel.tabBar.items.length; i++) {
                        if (Ext.getCmp("TabPage9") != undefined && tabPanel.tabBar.items.getAt(i).text == Ext.getCmp("TabPage9").title) {
                            var tab = Ext.getCmp("TabPage9");
                            var tab7 = Ext.getCmp("TabPage7");
                            if (tab && tab7) {
                                if (activetab) {
                                    tabPanel.setActiveTab(tab7);
                                }
                            }
                            tabPanel.tabBar.items.getAt(i).hide();
                            return;
                        }
                    }
                }
                else {
                    var ifShow = mainPanel_form.queryById("FIfPerformanceAppraisal").getValue();
                    if (ifShow == 1) {
                        /*if (tabPanel.tabBar.items.length >= 7) {
                            tabPanel.tabBar.items.getAt(6).show();
                        }
                        var tab = Ext.getCmp("TabPage9");
                        var tab7 = Ext.getCmp("TabPage7");
                        if (tab && tab7) {
                            tab.show();
                            if (activetab) {
                                tabPanel.setActiveTab(tab7);
                                tabPanel.setActiveTab(tab);
                            }
                        }*/
                        for (var i = 0; i < tabPanel.tabBar.items.length; i++) {
                            if (Ext.getCmp("TabPage9") != undefined && tabPanel.tabBar.items.getAt(i).text == Ext.getCmp("TabPage9").title) {
                                var tab = Ext.getCmp("TabPage9");
                                var tab7 = Ext.getCmp("TabPage7");
                                tabPanel.tabBar.items.getAt(i).show();
                                if (tab && tab7) {
                                    if (activetab) {
                                        tabPanel.setActiveTab(tab);
                                    }
                                }
                            }
                        }
                    }
                    else {
                        hidePerformTargetTab(true, true);
                    }
                }
            }


            //设置默认展示tab
            function activeTabpage(tabpageid) {
                //默认 tabpage1
                var tabActive = Ext.getCmp(tabpageid);
                if (tabActive) {
                    tabActive.show();
                    tabPanel.setActiveTab(tabActive);
                }
            }


            //获得项目阈值
            function getProjectThreshold(orgcode, FExpenseCategoryCode) {
                Ext.Ajax.request({
                    params: { 'Orgcode': orgcode, 'FExpenseCategoryCode': FExpenseCategoryCode },
                    url: C_ROOT + 'GQT/QT/ProjectThreshold/GetProjectThresholdByOrgAndZCLB',
                    async: false, //同步请求
                    success: function (response) {
                        var resp = Ext.JSON.decode(response.responseText);
                        orgProjectProjectThreshold = resp.FThreshold;
                        orgProjectProjectType = resp.ProjTypeId;
                    }
                });
            };

            //组织绩效项目阈值控制
            function controlProjectProjectThreshold() {
                /*if (!orgProjectProjectThreshold) {
                    var unitCode = mainPanel_form.queryById("FDeclarationUnit").getValue();
                    var FExpenseCategoryCode = mainPanel_form.queryById("FExpenseCategory").getValue();
                    getProjectThreshold(unitCode, FExpenseCategoryCode);
                }*/

                if (orgProjectProjectThreshold && orgProjectProjectThreshold != 0) {

                    //取得合计数
                    //var projAmount = mainPanel_form.queryById("FProjAmount").getValue();
                    var projAmount = 0, amount = 0;
                    for (var i = 0; i < BudgetDtlPanel_store.getCount(); i++) {
                        amount = BudgetDtlPanel_store.getAt(i).get('FAmount');
                        if (amount) {
                            projAmount = projAmount + amount;
                        }
                    }


                    if (+projAmount >= +orgProjectProjectThreshold) {

                        //获取项目类型
                        var projectType = mainPanel_form.queryById("FExpenseCategory").getValue();
                        var arry = orgProjectProjectType.split(',');

                        if (array_contain(arry, projectType).state) {
                            mainPanel_form.queryById("FIfPerformanceAppraisal").setValue(1);
                            hidePerformTargetTab(false, true);
                            Ext.MessageBox.alert("提示", "项目金额大于阈值,必须启用绩效评价");
                            return false;
                        }
                    }
                    else {
                        return true;
                    }

                }

                return true;
            }

             //数组是否包含元素
            function array_contain(array, obj) {

                if (array != null && array != undefined) {
                    for (var i = 0; i < array.length; i++) {
                        if (array[i] == obj)
                            return { state: true };
                    }
                }
                return { state: false };
            }





        });


    function returnMemoArr(MemoArr, individualInfo) {
        var memoLength = MemoArr.length;
        for (var i = 0; i < individualInfo.form['mainPanel'].fields.length; i++) { //判断主表自定义字段显示情况
            if (individualInfo.form['mainPanel'].fields[i].hidden == true) {
                for (var j = 0; j < memoLength; j++) {
                    if (MemoArr[j][0] == individualInfo.form['mainPanel'].fields[i].itemId && MemoArr[j][1].indexOf("主表") >= 0 ) { //判断主表字段
                        MemoArr.splice(j, 1);
                        memoLength--;
                        break;
                    }
                }
            }
        }
        for (var i = 0; i < individualInfo.form['FunctionalOvervPanel'].fields.length; i++) { //判断部门职能概述自定义字段显示情况
            if (individualInfo.form['FunctionalOvervPanel'].fields[i].itemId == "FFunctionalOverview" && individualInfo.form['FunctionalOvervPanel'].fields[i].hidden == true) {
                for (var j = 0; j < memoLength; j++) {
                    if (MemoArr[j][0] == individualInfo.form['FunctionalOvervPanel'].fields[i].itemId && MemoArr[j][1].indexOf("明细表") >= 0) { //判断部门职能概述
                        MemoArr.splice(j, 1);
                        memoLength--;
                        break;
                    }
                }
                break; //该from只控制FFunctionalOverview 是否展示，故有判断到的就跳出循环
            }
        }
        for (var i = 0; i < individualInfo.form['ProjOverviewPanel'].fields.length; i++) { //判断项目概况自定义字段显示情况
            if (individualInfo.form['ProjOverviewPanel'].fields[i].hidden == true) { //|| individualInfo.form['ProjOverviewPanel'].fields[i].hideLabel == true
                for (var j = 0; j < memoLength; j++) {
                    if (MemoArr[j][0] == individualInfo.form['ProjOverviewPanel'].fields[i].itemId && MemoArr[j][1].indexOf("明细") >= 0) {
                        MemoArr.splice(j, 1);
                        memoLength--;
                        break;
                    }
                }
            }
        }
        for (var i = 0; i < individualInfo.form['longTargetPanel'].fields.length; i++) { //判断总体绩效目标自定义字段显示情况
            if (individualInfo.form['longTargetPanel'].fields[i].hidden == true) {// || individualInfo.form['longTargetPanel'].fields[i].hideLabel == true
                for (var j = 0; j < memoLength; j++) {
                    if (MemoArr[j][0] == individualInfo.form['longTargetPanel'].fields[i].itemId && MemoArr[j][1].indexOf("明细") >= 0) {
                        MemoArr.splice(j, 1);
                        memoLength--;
                        break;
                    }
                }
            }
        }
        for (var i = 0; i < individualInfo.form['yearTargetPanel'].fields.length; i++) { //判断年度绩效目标自定义字段显示情况
            if (individualInfo.form['yearTargetPanel'].fields[i].hidden == true) { //|| individualInfo.form['yearTargetPanel'].fields[i].hideLabel == true
                for (var j = 0; j < memoLength; j++) {
                    if (MemoArr[j][0] == individualInfo.form['yearTargetPanel'].fields[i].itemId && MemoArr[j][1].indexOf("明细") >= 0) {
                        MemoArr.splice(j, 1);
                        memoLength--;
                        break;
                    }
                }
            }
        }
        for (var i = 0; i < individualInfo.form['projectStartInfoPanel'].fields.length; i++) { //判断项目立项情况自定义字段显示情况
            if (individualInfo.form['projectStartInfoPanel'].fields[i].hidden == true) { //|| individualInfo.form['projectStartInfoPanel'].fields[i].hideLabel == true
                for (var j = 0; j < memoLength; j++) {
                    if (MemoArr[j][0] == individualInfo.form['projectStartInfoPanel'].fields[i].itemId && MemoArr[j][1].indexOf("明细") >= 0) {
                        MemoArr.splice(j, 1);
                        memoLength--;
                        break;
                    }
                }
            }
        }
        for (var i = 0; i < individualInfo.tabPanel['DtlPanel'].items.length; i++) { //判断项目立项情况自定义字段显示情况
            if (individualInfo.tabPanel['DtlPanel'].items[i].hidden == true) {
                switch (individualInfo.tabPanel['DtlPanel'].items[i].id) {
                    case "TabPage1":
                        for (var j = 0; j < memoLength; j++) {
                            if (MemoArr[j][0] == "FFunctionalOverview" && MemoArr[j][1].indexOf("明细") >= 0) {
                                MemoArr.splice(j, 1);
                                memoLength--;
                                break;
                            }
                        }
                        break;
                    case "TabPage2":
                        for (var j = 0; j < memoLength; j++) {
                            if (MemoArr[j][0] == "FProjOverview" && MemoArr[j][1].indexOf("明细") >= 0) {
                                MemoArr.splice(j, 1);
                                memoLength--;
                                break;
                            }
                        }
                        break;
                    case "TabPage3":
                        for (var j = 0; j < memoLength; j++) {
                            if ((MemoArr[j][0] == "FProjBasis" || MemoArr[j][0] == "FFeasibility" || MemoArr[j][0] == "FNecessity" )  && MemoArr[j][1].indexOf("明细") >= 0) {
                                MemoArr.splice(j, 1);
                                memoLength--;

                            }
                        }
                        break;
                    case "TabPage4": //x项目明细
                        for (var i = 0; i < dtlAreaField.length; i++) {
                            for (var j = 0; j < memoLength; j++) {
                                if (MemoArr[j][0] == dtlAreaField[i] && MemoArr[j][1].indexOf("明细") >= 0) {
                                    MemoArr.splice(j, 1);
                                    memoLength--;
                                    break;
                                }
                            }
                        }
                        break;
                    case "TabPage5": //项目资金申请 因不能手动修改，故不判断
                        break;
                    case "TabPage6":
                        for(var j = 0; j < memoLength; j++) {
                            if ((MemoArr[j][0] == "FImplContent" || MemoArr[j][0] == "FStartDate" || MemoArr[j][0] == "FEndDate") && MemoArr[j][1].indexOf("明细") >= 0) {
                                MemoArr.splice(j, 1);
                                memoLength--;

                            }
                        }
                        break;
                    case "TabPage7":
                        for (var j = 0; j < memoLength; j++) {
                            if (MemoArr[j][0] == "FLTPerformGoal" && MemoArr[j][1].indexOf("明细") >= 0) {
                                MemoArr.splice(j, 1);
                                memoLength--;
                                break;
                            }
                        }
                        break;
                    case "TabPage8":
                        for (var j = 0; j < memoLength; j++) {
                            if (MemoArr[j][0] == "FAnnualPerformGoal" && MemoArr[j][1].indexOf("明细") >= 0) {
                                MemoArr.splice(j, 1);
                                memoLength--;
                                break;
                            }
                        }
                        break;
                    case "TabPage9": //绩效目标分解 因不能手动修改，故不判断
                        break;
                }
            }
        }

        for (var i = 0; i < individualInfo.grid['BudgetDtlPanel'].columns.length; i++) { //判断明细自定义字段显示情况
            if (individualInfo.grid['BudgetDtlPanel'].columns[i].hidden == true) {
                for (var j = 0; j < memoLength; j++) {
                    if (MemoArr[j][0] == individualInfo.grid['BudgetDtlPanel'].columns[i].dataIndex && MemoArr[j][1].indexOf("明细表") >= 0) { //判断明细表字段
                        MemoArr.splice(j, 1);
                        memoLength--;
                        break;
                    }
                }
            }
        }

        for (var i = 0; i < individualInfo.grid['ImplPlanPanel'].columns.length; i++) { //判断明细自定义字段显示情况
            if (individualInfo.grid['ImplPlanPanel'].columns[i].hidden == true) {
                for (var j = 0; j < memoLength; j++) {
                    if (MemoArr[j][0] == individualInfo.grid['ImplPlanPanel'].columns[i].dataIndex && MemoArr[j][1].indexOf("明细表") >= 0) { //判断明细表字段
                        MemoArr.splice(j,1);
                        memoLength--;
                        break;
                    }
                }
            }
        }

        return MemoArr;
    }



    </script>
}
